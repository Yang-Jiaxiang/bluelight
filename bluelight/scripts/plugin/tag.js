var openWriteTAG=!1;function loadWriteTAG(){var e;(e=document.createElement("SPAN")).innerHTML='<img class="img TAG" alt="writeTAG" id="writeTAG" src="../image/icon/black/tag_off.png" width="50" height="50">',getByid("icon-list").appendChild(e),(e=document.createElement("SPAN")).innerHTML='<div id="TagStyleDiv" style="background-color:#30306044;">\n        <span style="color: white;" id="medicalSpecialtyTagSpan">Medical specialty：</span>\n        <select id="medicalSpecialtyTag">\n        </select>\n      </div>',getByid("page-header").appendChild(e),getByid("TagStyleDiv").style.display="none"}function readImageTags(e){let t=new XMLHttpRequest;t.open("GET",e),t.responseType="json",t.send(),t.onload=function(){Object.entries(t.response.medicalSpecialty).forEach((e=>{let[t,n]=e,a=n.name,l=document.getElementById("medicalSpecialtyTag"),i=document.createElement("option");i.id=a,i.textContent=a,l.appendChild(i);let o=document.getElementById("TagStyleDiv"),c=document.createElement("div");c.id=a,c.style.color="white",o.appendChild(c),Object.entries(n.diseases).forEach((e=>{let[t,n]=e,a=document.createElement("span"),l=n.name;a.id="diseaseTagSpan",a.textContent="Disease："+l+" ",c.appendChild(a);let i=document.createElement("select");i.id="diseaseSelectorTag"+l.replace(/ /g,""),document.querySelectorAll("[id^=diseaseSelectorTag]").length>0&&(c.hidden=!0),c.appendChild(i),n.tags.forEach((e=>{let t=document.createElement("option");t.id=e,t.textContent=e,i.appendChild(t)}))}))}))}}loadWriteTAG(),readImageTags("../data/imageTags.json"),getByid("medicalSpecialtyTag").onchange=function(){document.getElementById("TagStyleDiv").querySelectorAll("div").forEach((e=>{e.hidden=!0})),document.querySelectorAll("div[id='"+this.value+"']").forEach((e=>{e.hidden=!1}))},getByid("writeTAG").onclick=function(){if(cancelTools(),openWriteTAG=!openWriteTAG,img2darkByClass("TAG",!openWriteTAG),this.src=1==openWriteTAG?"../image/icon/black/tag_on.png":"../image/icon/black/tag_off.png",1==openWriteTAG?(getByid("TagStyleDiv").style.display="",set_BL_model("writeTAG")):getByid("TagStyleDiv").style.display="none",displayMark(viewportNumber),1==openWriteTAG)return;let e=SearchUid2Index(GetViewport().sop),t=e[0],n=e[1],a=e[2],l=Patient.Study[t].Series[n].Sop[a].SopUID;set_TAG_context(e),1==ConfigLog.Xml2Dcm.enableXml2Dcm?function(e,t,n){document.createElement("a");let a=new File([e],t+".xml",{type:"text/plain"});var l=new XMLHttpRequest;l.open("POST",ConfigLog.Xml2Dcm.Xml2DcmUrl,!0),l.setRequestHeader("enctype","multipart/form-data");var i=new FormData;i.append("files",a),l.send(i),l.onload=function(){if(200==l.status){let e=JSON.parse(l.responseText);for(let t of e)window.open(t)}}}(String(get_TAG_context()),""+CreateRandom()):function(e,t,n){let a=document.createElement("a"),l=new Blob([e],{type:"text/plain"});a.href=window.URL.createObjectURL(l),a.download=t,a.click()}(String(get_TAG_context()),l+".xml"),getByid("MouseOperation").click()};var TAG_format='<?xml version="1.0" encoding="UTF-8"?>\n    <file-format>\n        <meta-header xfer="1.2.840.10008.1.2.1" name="Little Endian Explicit">\n            <element tag="0002,0013" vr="SH" vm="1" len="10" name="ImplementationVersionName">BlueLight</element>\n        </meta-header>\n        <data-set xfer="1.2.840.10008.1.2.1" name="Little Endian Explicit">\n            <element tag="0004,1430" vr="CS" vm="1" len="6" name="DirectoryRecordType">IMAGE</element>\n            <element tag="0008,0018" vr="UI" vm="1" len="___SOPInstanceUID(len)___" name="SOPInstanceUID">___SOPInstanceUID___</element>\n            <element tag="0020,0013" vr="IS" vm="1" len="___InstanceNumber(len)___" name="InstanceNumber">___InstanceNumber___</element>\n            <element tag="0020,000d" vr="UI" vm="1" len="___StudyInstanceUID(len)___" name="StudyInstanceUID">___StudyInstanceUID___</element>\n            <element name="ImageTag">___ImageTag___</element>\n        </data-set>\n    </file-format>\n    ',TAG_format_object_list=[];function set_TAG_context(e){TAG_format_object_list=[];let t,n=""+TAG_format,a=e[0],l=e[1],i=e[2];function o(e,t,n,a){n=""+(n=Null2Empty(n)),e=e.replace("___"+t+"___",""+n);var l=(""+n).length;return l%2!=0&&l++,1==a&&(e=e.replace("___"+t+"(len)___",l)),e}document.getElementById("TagStyleDiv").querySelectorAll("div").forEach((e=>{if(!1===e.hidden){let n=e.querySelectorAll("[id^=diseaseSelectorTag]")[0];t=n.value}}));let c=Patient.Study[a].Series[l].Sop[i];n=o(n,"SOPInstanceUID",c.SopUID,!0),n=o(n,"InstanceNumber",c.InstanceNumber,!0),n=o(n,"StudyInstanceUID",Patient.Study[a].StudyUID,!0),n=o(n,"ImageTag",t,!0),TAG_format_object_list.push(n)}function get_TAG_context(){for(var e="",t=0;t<TAG_format_object_list.length;t++)e+=TAG_format_object_list[t];return e}