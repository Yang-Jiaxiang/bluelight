var openWriteGSPS=!1,openWriteGraphic=!1;function loadWriteGraphic(){var e;(e=document.createElement("SPAN")).innerHTML='<img class="img GSPS" alt="writeGSPS" id="writeGSPS" src="../image/icon/black/gsps_off.png" width="50" height="50">',getByid("icon-list").appendChild(e),(e=document.createElement("SPAN")).innerHTML='<div id="GspsStyleDiv" style="background-color:#30306044;">\n        <select id="GSPScolorSelect" style="background-color:#929292;font-weight:bold;font-size:16px;">\n          <option id="GSPSBlackSelect" style="color: #000000;font-weight:bold;">Black</option>\n          <option id="GSPSBlueSelect" style="color: #0000FF;font-weight:bold;" selected="selected">Blue</option>\n          <option id="GSPSBrownSelect" style="color: #A52A2A;font-weight:bold;">Brown</option>\n          <option id="GSPSCyanSelect" style="color: #00FFFF;font-weight:bold;">Cyan</option>\n          <option id="GSPSGreenSelect" style="color: #00FF00;font-weight:bold;">Green</option>\n          <option id="GSPSMagentaSelect" style="color: #FF00FF;font-weight:bold;">Magenta</option>\n          <option id="GSPSOrangeSelect" style="color: #FFA500;font-weight:bold;">Orange</option>\n          <option id="GSPSPurpleSelect" style="color: #663399;font-weight:bold;">Purple</option>\n          <option id="GSPSRedSelect" style="color: #FF0000;font-weight:bold;">Red</option>\n          <option id="GSPSYellowSelect" style="color: #FFFF00;font-weight:bold;"> Yellow</option>\n          <option id="GSPSWhiteSelect" style="color: #FFFFFF;font-weight:bold;">White</option>\n        </select>\n        <font color="white">Nameï¼š</font><input type="text" id="GspsName" value="T1" size="8" />\n        <select id="GspsTypeSelect" style="background-color:#929292;font-weight:bold;font-size:16px;">\n          <option id="GspsPOLYLINE" selected="selected">Rectangle</option>\n          <option id="GspsCIRCLE">Circle</option>\n          <option id="GspsLINE">Line</option>\n        </select>\n      </div>',getByid("page-header").appendChild(e),getByid("GspsStyleDiv").style.display="none"}function GetGraphicColor(){return getByid("GraphicBlackSelect").selected?"#000000":getByid("GraphicBlueSelect").selected?"#0000FF":getByid("GraphicBrownSelect").selected?"#844200":getByid("GraphicCyanSelect").selected?"#00FFFF":getByid("GraphicGreenSelect").selected?"#00FF00":getByid("GraphicMagentaSelect").selected?"#FF00FF":getByid("GraphicOrangeSelect").selected?"#FFA500":getByid("GraphicPurpleSelect").selected?"#663399":getByid("GraphicRedSelect").selected?"#FF0000":getByid("GraphicYellowSelect").selected?"#FFFF00":getByid("GraphicWhiteSelect").selected?"#FFFFFF":"#0000FF"}function GetGSPSColor(){return getByid("GSPSBlackSelect").selected?"#000000":getByid("GSPSBlueSelect").selected?"#0000FF":getByid("GSPSBrownSelect").selected?"#844200":getByid("GSPSCyanSelect").selected?"#00FFFF":getByid("GSPSGreenSelect").selected?"#00FF00":getByid("GSPSMagentaSelect").selected?"#FF00FF":getByid("GSPSOrangeSelect").selected?"#FFA500":getByid("GSPSPurpleSelect").selected?"#663399":getByid("GSPSRedSelect").selected?"#FF0000":getByid("GSPSYellowSelect").selected?"#FFFF00":getByid("GSPSWhiteSelect").selected?"#FFFFFF":"#0000FF"}function GetGraphicName(){return getByid("GraphicBlackSelect").selected?"T7":getByid("GraphicBlueSelect").selected?"T8":getByid("GraphicBrownSelect").selected?"T9":getByid("GraphicCyanSelect").selected?"T10":getByid("GraphicGreenSelect").selected?"T11":getByid("GraphicMagentaSelect").selected?"T12":getByid("GraphicOrangeSelect").selected?"L1":getByid("GraphicPurpleSelect").selected?"L2":getByid("GraphicRedSelect").selected?"L3":getByid("GraphicYellowSelect").selected?"L4":getByid("GraphicWhiteSelect").selected?"L5":"T8"}loadWriteGraphic(),window.addEventListener("keydown",(e=>{var t=e.which;!openWriteGSPS&&!openWriteGraphic||!Graphic_now_choose||46!==t&&110!==t||(PatientMark.splice(PatientMark.indexOf(Graphic_now_choose.reference),1),displayMark(),Graphic_now_choose=null,refreshMarkFromSop(GetNowUid().sop))})),getByid("GspsTypeSelect").onchange=function(){displayMark()},getByid("writeGSPS").onclick=function(){0!=this.enable&&(cancelTools(),openWriteGSPS=!openWriteGSPS,img2darkByClass("GSPS",!openWriteGSPS),openLeftImgClick=!openWriteGSPS,this.src=1==openWriteGSPS?"../image/icon/black/gsps_on.png":"../image/icon/black/gsps_off.png",1==openWriteGSPS?(getByid("GspsStyleDiv").style.display="",set_BL_model("writegsps"),writegsps()):getByid("GspsStyleDiv").style.display="none",displayMark(),1!=openWriteGSPS&&(set_GSPS_context(),1==ConfigLog.Xml2Dcm.enableXml2Dcm?function(e,t,a){document.createElement("a");let n=new File([e],t+".xml",{type:"text/plain"});var r=new XMLHttpRequest;r.open("POST",ConfigLog.Xml2Dcm.Xml2DcmUrl,!0),r.setRequestHeader("enctype","multipart/form-data");var i=new FormData;i.append("files",n),r.send(i),r.onload=function(){if(200==r.status){let e=JSON.parse(r.responseText);for(let t of e)window.open(t)}}}(String(get_Graphic_context()),""+CreateSecurePassword()):function(e,t,a){let n=document.createElement("a"),r=new Blob([e],{type:"text/plain"});n.href=window.URL.createObjectURL(r),n.download="filename_GSPS.xml",n.click()}(String(get_Graphic_context())),getByid("MouseOperation").click()))};var Graphic_Annotation_format='<?xml version="1.0" encoding="UTF-8"?>\n<file-format>\n    <meta-header xfer="1.2.840.10008.1.2.1" name="Little Endian Explicit">\n        <element tag="0002,0000" vr="UL" vm="1" len="4" name="FileMetaInformationGroupLength">200</element>\n        <element tag="0002,0001" vr="OB" vm="1" len="2" name="FileMetaInformationVersion" binary="hidden"></element>\n        <element tag="0002,0002" vr="UI" vm="1" len="28" name="MediaStorageSOPClassUID">1.2.840.10008.5.1.4.1.1.11.1</element>\n        <element tag="0002,0003" vr="UI" vm="1" len="___SOPInstanceUID(len)___" name="MediaStorageSOPInstanceUID">___SOPInstanceUID___</element>\n        <element tag="0002,0010" vr="UI" vm="1" len="18" name="TransferSyntaxUID">1.2.840.10008.1.2</element>\n        <element tag="0002,0012" vr="UI" vm="1" len="28" name="ImplementationClassUID">1.2.276.0.7230010.3.0.3.6.4</element>\n        <element tag="0002,0013" vr="SH" vm="1" len="16" name="ImplementationVersionName">OFFIS_DCMTK_364</element>\n    </meta-header>\n    <data-set xfer="1.2.840.10008.1.2" name="Little Endian Implicit">\n        <element tag="0008,0005" vr="CS" vm="1" len="10" name="SpecificCharacterSet">ISO_IR 192</element>\n        <element tag="0008,0016" vr="UI" vm="1" len="28" name="SOPClassUID">1.2.840.10008.5.1.4.1.1.11.1</element>\n        <element tag="0008,0018" vr="UI" vm="1" len="___SOPInstanceUID(len)___" name="SOPInstanceUID">___SOPInstanceUID___</element>\n        <element tag="0008,0020" vr="DA" vm="1" len="8" name="StudyDate">___StudyDate___</element>\n        <element tag="0008,0023" vr="DA" vm="1" len="8" name="ContentDate">___StudyDate___</element>\n        <element tag="0008,0030" vr="TM" vm="1" len="10" name="StudyTime">___StudyTime___</element>\n        <element tag="0008,0033" vr="TM" vm="1" len="10" name="ContentTime">___StudyTime___</element>\n        <element tag="0008,0050" vr="SH" vm="1" len="___AccessionNumber(len)___" name="AccessionNumber">___AccessionNumber___</element>\n        <element tag="0008,0060" vr="CS" vm="1" len="2" name="Modality">PR</element>\n        <element tag="0008,1030" vr="LO" vm="1" len="___StudyDescription(len)___" name="StudyDescription">___StudyDescription___</element>\n        <element tag="0008,103e" vr="LO" vm="1" len="12" name="SeriesDescription">BlueLight GSPS</element>\n        <sequence tag="0008,1115" vr="SQ" card="1" len="188" name="ReferencedSeriesSequence">\n            <item card="2" len="180">\n                <sequence tag="0008,1140" vr="SQ" card="1" len="108" name="ReferencedImageSequence">\n                    <item card="2" len="100">\n                        <element tag="0008,1150" vr="UI" vm="1" len="28" name="ReferencedSOPClassUID">1.2.840.10008.5.1.4.1.1.1.1</element>\n                        <element tag="0008,1155" vr="UI" vm="1" len="___ReferencedSOPInstanceUID(len)___" name="ReferencedSOPInstanceUID">___ReferencedSOPInstanceUID___</element>\n                    </item>\n                </sequence>\n                <element tag="0020,000e" vr="UI" vm="1" len="___ReferencedSeriesInstanceUID(len)___" name="SeriesInstanceUID">___ReferencedSeriesInstanceUID___</element>\n            </item>\n        </sequence>\n        <element tag="0010,0010" vr="PN" vm="1" len="___PatientName(len)___" name="PatientName">___PatientName___</element>\n        <element tag="0010,0020" vr="LO" vm="1" len="___PatientID(len)___" name="PatientID">___PatientID___</element>\n        <element tag="0018,0015" vr="CS" vm="0" len="0" name="BodyPartExamined"></element>\n        <element tag="0018,1020" vr="LO" vm="1" len="6" name="SoftwareVersions">3.5.4</element>\n        <element tag="0020,000d" vr="UI" vm="1" len="___StudyInstanceUID(len)___" name="StudyInstanceUID">___StudyInstanceUID___</element>\n        <element tag="0020,000e" vr="UI" vm="1" len="___SeriesInstanceUID(len)___" name="SeriesInstanceUID">___SeriesInstanceUID___</element>\n        <element tag="0020,0010" vr="SH" vm="1" len="___StudyID(len)___" name="StudyID">___StudyID___</element>\n        <element tag="0020,0011" vr="IS" vm="1" len="4" name="SeriesNumber">999</element>\n        <sequence tag="0070,0001" vr="SQ" card="1" len="194" name="GraphicAnnotationSequence">\n            <item card="3" len="186">\n                <element tag="0070,0002" vr="CS" vm="1" len="4" name="GraphicLayer">DRAW</element>\n                <sequence tag="0070,0008" vr="SQ" card="0" len="0" name="TextObjectSequence">\n                </sequence>\n                <sequence tag="0070,0009" vr="SQ" card="1" len="158" name="GraphicObjectSequence">\n___item___\n                </sequence>\n            </item>\n        </sequence>\n        <sequence tag="0070,0060" vr="SQ" card="1" len="60" name="GraphicLayerSequence">\n            <item card="4" len="52">\n                <element tag="0070,0002" vr="CS" vm="1" len="4" name="GraphicLayer">DRAW</element>\n                <element tag="0070,0062" vr="IS" vm="1" len="2" name="GraphicLayerOrder">0</element>\n                <element tag="0070,0068" vr="LO" vm="1" len="8" name="GraphicLayerDescription">Drawings</element>\n                <element tag="0070,0401" vr="US" vm="3" len="6" name="GraphicLayerRecommendedDisplayCIELabValue">655\\33153\\32896</element>\n            </item>\n        </sequence>\n        <element tag="0070,0080" vr="CS" vm="1" len="4" name="ContentLabel">GSPS</element>\n        <element tag="0070,0081" vr="LO" vm="1" len="12" name="ContentDescription">Description</element>\n        <element tag="0070,0082" vr="DA" vm="1" len="8" name="PresentationCreationDate">___PresentationCreationDate___</element>\n        <element tag="0070,0083" vr="TM" vm="1" len="10" name="PresentationCreationTime">___PresentationCreationTime___</element>\n        <element tag="0070,0084" vr="PN" vm="1" len="10" name="ContentCreatorName">BlueLight</element>\n    </data-set>\n</file-format>',Graphic_format_object_list=[],Graphic_format_tail='\n                    <item card="7" len="150">\n                        <element tag="0070,0005" vr="CS" vm="1" len="6" name="GraphicAnnotationUnits">PIXEL</element>\n                        <element tag="0070,0020" vr="US" vm="1" len="2" name="GraphicDimensions">2</element>\n                        <element tag="0070,0021" vr="US" vm="1" len="___NumberOfGraphicPoints(len)___" name="NumberOfGraphicPoints">___NumberOfGraphicPoints___</element>\n                        <element tag="0070,0022" vr="FL" vm="___vm___" len="___len___" name="GraphicData">___GraphicData___</element>\n                        <element tag="0070,0023" vr="CS" vm="1" len="8" name="GraphicType">___GraphicType___</element>___rotation___\n                        <element tag="0070,0024" vr="CS" vm="1" len="2" name="GraphicFilled">N</element>\n                        <sequence tag="0070,0232" vr="SQ" card="1" len="34" name="LineStyleSequence">\n                            <item card="2" len="26">\n                                <element tag="0070,0251" vr="US" vm="3" len="6" name="PatternOnColorCIELabValue">___PatternOnColorCIELabValue___</element>\n                                <element tag="0070,0253" vr="FL" vm="1" len="4" name="LineThickness">1</element>\n                            </item>\n                        </sequence>\n                    </item>',Graphic_format_rotation='\n\n                        <element tag="0071,0230" vr="FD" vm="1" len="8" name="RotationAngle">___RotationAngle___</element>\n                        <element tag="0071,0273" vr="FL" vm="2" len="8" name="RotationPoint">___RotationPoint___</element>',Graphic_now_choose=null,temp_xml_format="";function Graphic_pounch(e,t,a){let n=4*getMarkSize(GetViewportMark(),!1),r=SearchUid2Index(GetViewport().sop),i=r[0],o=r[1],l=r[2];for(var s=0;s<PatientMark.length;s++)if((!a||PatientMark[s]==a)&&PatientMark[s].sop==Patient.Study[i].Series[o].Sop[l].SopUID)for(var _=0;_<PatientMark[s].mark.length;_++)if("POLYLINE"==PatientMark[s].mark[_].type){for(var m=PatientMark[s].mark[_],p=-999999,c=-999999,h=999999,g=999999,d=[],G=[],k=[],u=[],S=0;S<PatientMark[s].mark[_].markX.length;S+=1)parseInt(m.markX[S])>=p&&(p=parseInt(m.markX[S])),parseInt(m.markX[S])<=h&&(h=parseInt(m.markX[S]));for(S=0;S<PatientMark[s].mark[_].markX.length;S+=1)equal_TOL(p,parseInt(m.markX[S]),n)&&d.push(S),equal_TOL(h,parseInt(m.markX[S]),n)&&k.push(S);for(S=0;S<PatientMark[s].mark[_].markY.length;S+=1)parseInt(m.markY[S])>=c&&(c=parseInt(m.markY[S])),parseInt(m.markY[S])<=g&&(g=parseInt(m.markY[S]));for(S=0;S<PatientMark[s].mark[_].markX.length;S+=1)equal_TOL(c,parseInt(m.markY[S]),n)&&G.push(S),equal_TOL(g,parseInt(m.markY[S]),n)&&u.push(S);for(S=0;S<PatientMark[s].mark[_].markX.length-1;S+=1){var P=(parseInt(m.markX[S])+parseInt(m.markX[S+1]))/2,w=(parseInt(m.markY[S])+parseInt(m.markY[S+1]))/2;if(t+n>=w&&e+n>=P&&t<w+n&&e<P+n){if(equal_TOL(w,c,n))return Graphic_now_choose={reference:PatientMark[s],point:G,mark:m,middle:[(p+h)/2,(c+g)/2],value:"up"},!0;if(equal_TOL(w,g,n))return Graphic_now_choose={reference:PatientMark[s],point:u,mark:m,middle:[(p+h)/2,(c+g)/2],value:"down"},!0;if(equal_TOL(P,h,n))return Graphic_now_choose={reference:PatientMark[s],point:k,mark:m,middle:[(p+h)/2,(c+g)/2],value:"left"},!0;if(equal_TOL(P,p,n))return Graphic_now_choose={reference:PatientMark[s],point:d,mark:m,middle:[(p+h)/2,(c+g)/2],value:"right"},!0}}}return Graphic_now_choose=null,!1}function set_Graphic_context(){Graphic_format_object_list=[];let e="",t="",a=SearchUid2Index(GetViewport().sop),n=a[0],r=a[1],i=a[2];e=""+Graphic_Annotation_format;for(var o=0;o<PatientMark.length;o++)if(PatientMark[o].sop==Patient.Study[n].Series[r].Sop[i].SopUID)for(var l=0;l<PatientMark[o].mark.length;l++){if("POLYLINE"==PatientMark[o].mark[l].type){let P=""+Graphic_format_tail;for(var s=PatientMark[o].mark[l],_="",m=0;m<s.markX.length;m+=1){var p=0,c=0;s.RotationAngle&&s.RotationPoint?[p,c]=rotatePoint([s.markX[m],s.markY[m]],s.RotationAngle,s.RotationPoint):[p,c]=[s.markX[m],s.markY[m]],0!=m&&(_+="\\"),_+=(p=parseInt(p)+".0123")+"\\"+(c=parseInt(c)+".0123")}if(P=P.replace("___GraphicData___",_),P=P.replace("___vm___","10"),P=P.replace("___len___",4*(s.markX.length+s.markY.length)),P=P.replace("___PatternOnColorCIELabValue___",""+SetGraphicColor(PatientMark[o].color)),P=P.replace("___GraphicType___","POLYLINE"),P=G(P,"NumberOfGraphicPoints",5,!0),s.RotationAngle&&s.RotationPoint){var h=(""+Graphic_format_rotation).replace("___RotationAngle___",s.RotationAngle);h=h.replace("___RotationPoint___",s.RotationPoint[0]+"\\"+s.RotationPoint[1]),P=P.replace("___rotation___",h)}else P=P.replace("___rotation___","");t+=P}var g=new Date;function d(e,t){return t?e<10?"00"+e:e<100?"0"+e:""+e:(e<10?"0":"")+e}function G(e,t,a,n){a=Null2Empty(a),e=e.replace("___"+t+"___",""+a);var r=(""+a).length;return r%2!=0&&r++,1==n&&(e=e.replace("___"+t+"(len)___",r)),e}for(var k=CreateUid("sop"),u=CreateUid("series"),S=0;S<5;S++)e=G(e,"StudyDate",GetViewport().StudyDate,!0),e=G(e,"StudyTime",GetViewport().StudyTime,!0),e=G(e,"StudyInstanceUID",Patient.Study[n].StudyUID,!0),e=G(e,"SeriesInstanceUID",u,!0),e=G(e,"SOPInstanceUID",k,!0),e=G(e,"PatientID",GetViewport().PatientID,!0),e=G(e,"PatientName",GetViewport().PatientName,!0),e=G(e,"ReferencedSOPInstanceUID",PatientMark[o].sop,!0),e=G(e,"ReferencedSeriesInstanceUID",Patient.Study[n].Series[r].SeriesUID,!0),e=G(e,"AccessionNumber",GetViewport().AccessionNumber,!0),e=G(e,"StudyDescription",GetViewport().StudyDescription,!0),e=G(e,"StudyID",GetViewport().StudyID,!0),e=e.replace("___PresentationCreationDate___",""+g.getFullYear()+d(g.getMonth()+1)+d(g.getDate())),e=e.replace("___PresentationCreationTime___",""+d(g.getHours()+1)+d(g.getMinutes())+d(g.getSeconds())+"."+d(g.getMilliseconds(),!0))}e=e.replace("___item___",t),Graphic_format_object_list.push(e)}function get_Graphic_context(){for(var e="",t=0;t<Graphic_format_object_list.length;t++)e+=Graphic_format_object_list[t];return e}function set_GSPS_context(){Graphic_format_object_list=[];let e="",t="",a=SearchUid2Index(GetViewport().sop),n=a[0],r=a[1],i=a[2];function o(e,t,a,n){a=Null2Empty(a),e=e.replace("___"+t+"___",""+a);var r=(""+a).length;return r%2!=0&&r++,1==n&&(e=e.replace("___"+t+"(len)___",r)),e}e=""+Graphic_Annotation_format;for(var l=0;l<PatientMark.length;l++)if(PatientMark[l].sop==Patient.Study[n].Series[r].Sop[i].SopUID)for(var s=0;s<PatientMark[l].mark.length;s++){if("POLYLINE"==PatientMark[l].mark[s].type){let P=""+Graphic_format_tail;for(var _=PatientMark[l].mark[s],m="",p=0;p<_.markX.length;p+=1){var c=0,h=0;_.RotationAngle&&_.RotationPoint?[c,h]=rotatePoint([_.markX[p],_.markY[p]],_.RotationAngle,_.RotationPoint):[c,h]=[_.markX[p],_.markY[p]],0!=p&&(m+="\\"),m+=(c=parseInt(c)+".0123")+"\\"+(h=parseInt(h)+".0123")}if(P=P.replace("___GraphicData___",m),P=P.replace("___vm___",_.markX.length+_.markY.length),P=P.replace("___len___",4*(_.markX.length+_.markY.length)),P=P.replace("___PatternOnColorCIELabValue___",""+SetGraphicColor(PatientMark[l].color)),P=P.replace("___GraphicType___","POLYLINE"),P=o(P,"NumberOfGraphicPoints",(_.markX.length+_.markY.length)/2,!0),_.RotationAngle&&_.RotationPoint){var g=(""+Graphic_format_rotation).replace("___RotationAngle___",_.RotationAngle);g=g.replace("___RotationPoint___",_.RotationPoint[0]+"\\"+_.RotationPoint[1]),P=P.replace("___rotation___",g)}else P=P.replace("___rotation___","");t+=P}else if("CIRCLE"==PatientMark[l].mark[s].type){let w=""+Graphic_format_tail;for(_=PatientMark[l].mark[s],m="",p=0;p<_.markX.length;p+=1)c=0,h=0,[c,h]=[_.markX[p],_.markY[p]],0!=p&&(m+="\\"),m+=(c=parseInt(c)+".0123")+"\\"+(h=parseInt(h)+".0123");w=w.replace("___rotation___",""),w=w.replace("___GraphicData___",m),w=w.replace("___vm___","4"),w=w.replace("___len___",4*(_.markX.length+_.markY.length)),w=w.replace("___PatternOnColorCIELabValue___",""+SetGraphicColor(PatientMark[l].color)),w=w.replace("___GraphicType___","CIRCLE"),w=o(w,"NumberOfGraphicPoints",(_.markX.length+_.markY.length)/2,!0),t+=w}var d=new Date;function G(e,t){return t?e<10?"00"+e:e<100?"0"+e:""+e:(e<10?"0":"")+e}for(var k=CreateUid("sop"),u=CreateUid("series"),S=0;S<5;S++)e=o(e,"StudyDate",GetViewport().StudyDate,!0),e=o(e,"StudyTime",GetViewport().StudyTime,!0),e=o(e,"StudyInstanceUID",Patient.Study[n].StudyUID,!0),e=o(e,"SeriesInstanceUID",u,!0),e=o(e,"SOPInstanceUID",k,!0),e=o(e,"PatientID",GetViewport().PatientID,!0),e=o(e,"PatientName",GetViewport().PatientName,!0),e=o(e,"ReferencedSOPInstanceUID",PatientMark[l].sop,!0),e=o(e,"ReferencedSeriesInstanceUID",Patient.Study[n].Series[r].SeriesUID,!0),e=o(e,"AccessionNumber",GetViewport().AccessionNumber,!0),e=o(e,"StudyDescription",GetViewport().StudyDescription,!0),e=o(e,"StudyID",GetViewport().StudyID,!0),e=e.replace("___PresentationCreationDate___",""+d.getFullYear()+G(d.getMonth()+1)+G(d.getDate())),e=e.replace("___PresentationCreationTime___",""+G(d.getHours()+1)+G(d.getMinutes())+G(d.getSeconds())+"."+G(d.getMilliseconds(),!0))}e=e.replace("___item___",t),Graphic_format_object_list.push(e)}function writegsps(){"writegsps"==BL_mode&&(DeleteMouseEvent(),Mousedown=function(e){1==e.which?MouseDownCheck=!0:3==e.which&&(rightMouseDown=!0),getCurrPoint(e)[0],getCurrPoint(e)[1],windowMouseX=GetmouseX(e),windowMouseY=GetmouseY(e),GetViewport().originalPointX=getCurrPoint(e)[0],GetViewport().originalPointY=getCurrPoint(e)[1],rightMouseDown||1!=getByid("GspsPOLYLINE").selected||1==Graphic_pounch(getCurrPoint(e)[0],getCurrPoint(e)[1])&&displayMark()},Mousemove=function(e){var t=getCurrPoint(e)[0],a=getCurrPoint(e)[1],n=getClass("labelXY");{let t=rotateCalculation(e);n[viewportNumber].innerText="X: "+parseInt(t[0])+" Y: "+parseInt(t[1])}if(1==openLink)for(var r=0;r<Viewport_Total;r++)GetViewport(r).newMousePointX=GetViewport().newMousePointX,GetViewport(r).newMousePointY=GetViewport().newMousePointY;for(putLabel(),r=0;r<Viewport_Total;r++)displayRuler(r);if(1==MouseDownCheck&&1==getByid("GspsCIRCLE").selected){let e=SearchNowUid();(s={}).study=e.studyuid,s.series=e.sreiesuid,s.color=GetGSPSColor(),s.mark=[],s.showName=getByid("GspsName").value,s.hideName=s.showName,s.mark.push({}),s.sop=e.sopuid;var i=s.mark.length-1;for(s.mark[i].type="CIRCLE",s.mark[i].markX=[],s.mark[i].markY=[],s.mark[i].markX.push(GetViewport().originalPointX),s.mark[i].markY.push(GetViewport().originalPointY),s.mark[i].markX.push(GetViewport().originalPointX+Math.sqrt(Math.pow(Math.abs(GetViewport().originalPointX-t),2)+Math.pow(Math.abs(GetViewport().originalPointY-a),2)/2)),s.mark[i].markY.push(GetViewport().originalPointY+Math.sqrt(Math.pow(Math.abs(GetViewport().originalPointX-t),2)+Math.pow(Math.abs(GetViewport().originalPointY-a),2)/2)),PatientMark.push(s),refreshMark(s),r=0;r<Viewport_Total;r++)displayMark(r);displayAngleRuler(),PatientMark.splice(PatientMark.indexOf(s),1)}if(1==MouseDownCheck&&1==getByid("GspsLINE").selected){let e=SearchNowUid();for((s={}).study=e.studyuid,s.series=e.sreiesuid,s.color=GetGSPSColor(),s.mark=[],s.showName=""+getByid("GspsName").value,s.hideName=s.showName,s.mark.push({}),s.sop=e.sopuid,i=s.mark.length-1,s.mark[i].type="POLYLINE",s.mark[i].markX=[],s.mark[i].markY=[],s.mark[i].markX.push(GetViewport().originalPointX),s.mark[i].markY.push(GetViewport().originalPointY),s.mark[i].markY.push(a),s.mark[i].markX.push(t),PatientMark.push(s),refreshMark(s),r=0;r<Viewport_Total;r++)displayMark(r);displayAngleRuler(),PatientMark.splice(PatientMark.indexOf(s),1)}if(!(1!=openWriteGraphic&&1!=getByid("GspsPOLYLINE").selected||1!=MouseDownCheck&&1!=rightMouseDown))if(t<=0&&(t=0),a<=0&&(a=0),t>GetViewport().imageWidth&&(t=GetViewport().imageWidth),a>GetViewport().imageHeight&&(a=GetViewport().imageHeight),GetViewport().originalPointX<=0&&(GetViewport().originalPointX=0),GetViewport().originalPointY<=0&&(GetViewport().originalPointY=0),GetViewport().originalPointX>GetViewport().imageWidth&&(GetViewport().originalPointX=GetViewport().imageWidth),GetViewport().originalPointY>GetViewport().imageHeight&&(GetViewport().originalPointY=GetViewport().imageHeight),Graphic_now_choose||1!=MouseDownCheck){if(1==rightMouseDown)Math.abs(a-GetViewport().originalPointY)>Math.abs(t-GetViewport().originalPointX)?(Graphic_now_choose.mark&&Graphic_now_choose.mark.RotationAngle||(Graphic_now_choose.mark.RotationAngle=0),a<GetViewport().originalPointY-1?Graphic_now_choose.mark.RotationAngle+=parseInt((GetViewport().originalPointY-a)/3):a>GetViewport().originalPointY+1&&(Graphic_now_choose.mark.RotationAngle-=parseInt((a-GetViewport().originalPointY)/3))):Math.abs(t-GetViewport().originalPointX)>Math.abs(a-GetViewport().originalPointY)&&(Graphic_now_choose.mark&&Graphic_now_choose.mark.RotationAngle||(Graphic_now_choose.mark.RotationAngle=0),t<GetViewport().originalPointX-1?Graphic_now_choose.mark.RotationAngle+=parseInt((GetViewport().originalPointX-t)/3):t>GetViewport().originalPointX+1&&(Graphic_now_choose.mark.RotationAngle-=parseInt((t-GetViewport().originalPointX)/3))),Graphic_now_choose.mark.RotationAngle>360&&(Graphic_now_choose.mark.RotationAngle-=360),Graphic_now_choose.mark.RotationAngle<0&&(Graphic_now_choose.mark.RotationAngle+=360),GetViewport().originalPointX=t,GetViewport().originalPointY=a;else if(1==MouseDownCheck){var o=Graphic_now_choose.point;if("up"==Graphic_now_choose.value)for(var l=0;l<o.length;l++)Graphic_now_choose.mark.markY[o[l]]=a;else if("down"==Graphic_now_choose.value)for(l=0;l<o.length;l++)Graphic_now_choose.mark.markY[o[l]]=a;else if("left"==Graphic_now_choose.value)for(l=0;l<o.length;l++)Graphic_now_choose.mark.markX[o[l]]=t;else if("right"==Graphic_now_choose.value)for(l=0;l<o.length;l++)Graphic_now_choose.mark.markX[o[l]]=t}Graphic_now_choose.mark.RotationAngle>=0&&(Graphic_now_choose.mark.RotationPoint=getRotationPoint(Graphic_now_choose.mark,!0)),displayMark()}else{let e=SearchNowUid();var s;for((s={}).study=e.studyuid,s.series=e.sreiesuid,s.color=GetGraphicColor(),1==getByid("GspsPOLYLINE").selected&&(s.color=GetGSPSColor()),s.mark=[],s.showName=GetGraphicName(),s.hideName=s.showName,1==getByid("GspsPOLYLINE").selected&&(s.showName=getByid("GspsName").value),s.mark.push({}),s.sop=e.sopuid,i=s.mark.length-1,s.mark[i].type="POLYLINE",s.mark[i].markX=[],s.mark[i].markY=[],s.mark[i].markX.push(GetViewport().originalPointX),s.mark[i].markY.push(GetViewport().originalPointY),s.mark[i].markX.push(GetViewport().originalPointX),s.mark[i].markY.push(a),s.mark[i].markX.push(t),s.mark[i].markY.push(a),s.mark[i].markX.push(t),s.mark[i].markY.push(GetViewport().originalPointY),s.mark[i].markX.push(GetViewport().originalPointX),s.mark[i].markY.push(GetViewport().originalPointY),PatientMark.push(s),refreshMark(s),r=0;r<Viewport_Total;r++)displayMark(r);displayAngleRuler(),PatientMark.splice(PatientMark.indexOf(s),1)}},Mouseup=function(e){var t=getCurrPoint(e)[0],a=getCurrPoint(e)[1];if(MouseDownCheck=!1,rightMouseDown=!1,1==getByid("GspsLINE").selected){let e=SearchNowUid();(i={}).study=e.studyuid,i.series=e.sreiesuid,i.color=GetGSPSColor(),i.mark=[],i.showName=""+getByid("xmlMarkNameText").value,i.hideName=i.showName,i.mark.push({}),i.sop=e.sopuid;var n=i.mark.length-1;i.mark[n].type="POLYLINE",i.mark[n].markX=[],i.mark[n].markY=[],i.mark[n].markX.push(GetViewport().originalPointX),i.mark[n].markY.push(GetViewport().originalPointY),i.mark[n].markY.push(a),i.mark[n].markX.push(t),PatientMark.push(i),refreshMark(i);for(var r=0;r<Viewport_Total;r++)displayMark(r);displayAngleRuler(),Graphic_now_choose={reference:i}}if(1==getByid("GspsCIRCLE").selected){let e=SearchNowUid();for((i={}).study=e.studyuid,i.series=e.sreiesuid,i.color=GetGSPSColor(),i.mark=[],i.showName=getByid("GspsName").value,i.hideName=i.showName,i.mark.push({}),i.sop=e.sopuid,n=i.mark.length-1,i.mark[n].type="CIRCLE",i.mark[n].markX=[],i.mark[n].markY=[],i.mark[n].markX.push(GetViewport().originalPointX),i.mark[n].markY.push(GetViewport().originalPointY),i.mark[n].markX.push(GetViewport().originalPointX+Math.sqrt(Math.pow(Math.abs(GetViewport().originalPointX-t),2)+Math.pow(Math.abs(GetViewport().originalPointY-a),2)/2)),i.mark[n].markY.push(GetViewport().originalPointY+Math.sqrt(Math.pow(Math.abs(GetViewport().originalPointX-t),2)+Math.pow(Math.abs(GetViewport().originalPointY-a),2)/2)),PatientMark.push(i),refreshMark(i),r=0;r<Viewport_Total;r++)displayMark(r);displayAngleRuler(),Graphic_now_choose={reference:i}}if(1==openWriteGraphic&&!Graphic_now_choose||1==getByid("GspsPOLYLINE").selected&&!Graphic_now_choose){t<=0&&(t=0),a<=0&&(a=0),t>GetViewport().imageWidth&&(t=GetViewport().imageWidth),a>GetViewport().imageHeight&&(a=GetViewport().imageHeight),GetViewport().originalPointX<=0&&(GetViewport().originalPointX=0),GetViewport().originalPointY<=0&&(GetViewport().originalPointY=0),GetViewport().originalPointX>GetViewport().imageWidth&&(GetViewport().originalPointX=GetViewport().imageWidth),GetViewport().originalPointY>GetViewport().imageHeight&&(GetViewport().originalPointY=GetViewport().imageHeight);let e=SearchNowUid();var i;for((i={}).study=e.studyuid,i.series=e.sreiesuid,i.color=GetGraphicColor(),1==getByid("GspsPOLYLINE").selected&&(i.color=GetGSPSColor()),i.mark=[],i.showName=GetGraphicName(),i.hideName=i.showName,1==getByid("GspsPOLYLINE").selected&&(i.showName=getByid("GspsName").value),i.mark.push({}),i.sop=e.sopuid,n=i.mark.length-1,i.mark[n].type="POLYLINE",i.mark[n].markX=[],i.mark[n].markY=[],i.mark[n].markX.push(GetViewport().originalPointX),i.mark[n].markY.push(GetViewport().originalPointY),i.mark[n].markX.push(GetViewport().originalPointX),i.mark[n].markY.push(a),i.mark[n].markX.push(t),i.mark[n].markY.push(a),i.mark[n].markX.push(t),i.mark[n].markY.push(GetViewport().originalPointY),i.mark[n].markX.push(GetViewport().originalPointX),i.mark[n].markY.push(GetViewport().originalPointY),PatientMark.push(i),Graphic_pounch(t,(a+GetViewport().originalPointY)/2,i),r=0;r<Viewport_Total;r++)displayMark(r);displayAngleRuler(),refreshMark(i)}}),AddMouseEvent()}function drawPOLYLINE_Write(e){var t=e.canvas,a=e.mark;if("POLYLINE"==a.type){var n=t.getContext("2d");n.globalAlpha=parseFloat(getByid("markAlphaText").value)/100,setMarkColor(n),a.parent.color&&(n.strokeStyle=n.fillStyle=""+a.parent.color);for(var r=0;r<a.markX.length;r+=1){n.beginPath();var i=1*a.markX[r],o=1*a.markY[r],l=1*a.markX[r+1],s=1*a.markY[r+1];if(a.RotationAngle&&a.RotationPoint&&([i,o]=rotatePoint([i,o],a.RotationAngle,a.RotationPoint),[l,s]=rotatePoint([l,s],a.RotationAngle,a.RotationPoint)),a.GSPS_Text&&0==r){n.font=4*parseInt(n.lineWidth)+"px Arial",n.fillStyle="red";var _=n.globalAlpha;n.globalAlpha=1,n.fillText(""+a.GSPS_Text,i<l?i:l,o<s?o-7:s-7),n.globalAlpha=_}var m=n.globalAlpha;if(n.globalAlpha=1,n.moveTo(i,o),n.lineTo(l,s),n.stroke(),n.globalAlpha=m,a.GraphicFilled&&"Y"==a.GraphicFilled&&(n.fillStyle="#FFFF88",n.fill(),console.log(i,o,l,s)),n.closePath(),1==openWriteGraphic||1==getByid("GspsPOLYLINE").selected&&1==openWriteGSPS){a.RotationAngle&&a.RotationPoint&&([i,o]=rotatePoint([i,o],-a.RotationAngle,a.RotationPoint),[l,s]=rotatePoint([l,s],-a.RotationAngle,a.RotationPoint)),n.lineWidth=""+2*parseInt(n.lineWidth);var p=n.fillStyle;Graphic_now_choose&&Graphic_now_choose.mark==a&&(n.strokeStyle=getRGBFrom0xFF(n.strokeStyle,!1,!0)),n.beginPath(),n.arc(i/2+l/2,o/2+s/2,parseInt(n.lineWidth),0,2*Math.PI),n.stroke(),n.closePath();for(var c=0;c<2;c++)n.fillStyle=p,n.beginPath(),n.arc(i/2+l/2,o/2+s/2,parseInt(n.lineWidth),0,2*Math.PI),n.fill(),n.closePath();n.lineWidth=""+parseInt(n.lineWidth)/2}}}}PLUGIN.PushMarkList(drawPOLYLINE_Write);