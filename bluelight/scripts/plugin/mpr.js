var o3DPointX=0,o3DPointY=0,openMPR=!1,buffer_mpr_X=0,buffer_mpr_Y=0;function loadMPR(){var e;(e=document.createElement("SPAN")).innerHTML='<img class="img MPR" alt="3d" id="ImgMPR" src="../image/icon/black/b_AdvancedMode_off.png" width="50" height="50">',getByid("icon-list").appendChild(e),(e=document.createElement("SPAN")).innerHTML='<label style="color: #ffffff;" id="mprLightLabel">position<input type="checkbox" checked="true" name="mprLight"\n    id="mprLight"></label>',getByid("page-header").appendChild(e),getByid("mprLightLabel").style.display="none"}function loadMPR_UI(){var e;getByid("MouseOperation_MPR")||((e=document.createElement("IMG")).src=getByid("MouseOperation").src,e.id="MouseOperation_MPR",e.className="MPR_icon",e.width=e.height="50",e.style.filter="sepia(100%)",getByid("MouseOperation_span").appendChild(e)),getByid("WindowRevision_MPR")||((e=document.createElement("IMG")).src=getByid("WindowRevision").src,e.id="WindowRevision_MPR",e.className="MPR_icon",e.width=e.height="50",e.style.filter="sepia(100%)",getByid("WindowRevision_span").appendChild(e)),getByid("b_Scroll_MPR")||((e=document.createElement("IMG")).src=getByid("b_Scroll").src,e.id="b_Scroll_MPR",e.className="MPR_icon",e.width=e.height="50",e.style.filter="sepia(100%)",getByid("b_Scroll_span").appendChild(e)),getByid("MouseRotate_MPR")||((e=document.createElement("IMG")).src=getByid("MouseRotate").src,e.id="MouseRotate_MPR",e.className="MPR_icon",e.width=e.height="50",e.style.filter="sepia(100%)",getByid("MouseRotate_span").appendChild(e))}function enterMPR_UI(){getByid("MouseOperation_MPR").style.display="",getByid("WindowRevision_MPR").style.display="",getByid("b_Scroll_MPR").style.display="",getByid("MouseRotate_MPR").style.display="",getByid("MouseOperation").style.display="none",getByid("WindowRevision").style.display="none",getByid("WindowLevelDiv").style.display="none",getByid("b_Scroll").style.display="none",getByid("MouseRotate").style.display="none",openLeftImgClick=!1}function exitMPR_UI(){getByid("MouseOperation_MPR").style.display="none",getByid("WindowRevision_MPR").style.display="none",getByid("b_Scroll_MPR").style.display="none",getByid("MouseRotate_MPR").style.display="none",getByid("MouseOperation").style.display="",getByid("WindowRevision").style.display="",getByid("WindowLevelDiv").style.display="",getByid("b_Scroll").style.display="",getByid("MouseRotate").style.display="",openLeftImgClick=!0}function drawBorderMPR(e){for(var t=getClass("MPR_icon"),i=0;i<t.length;i++)Css(t[i],"border","");Css(e,"border","3px #FFFFFF solid"),Css(e,"borderRadius","3px 3px 3px 3px")}function Anatomical_Section2(e){var t=GetViewport().canvas();if(0!=openMPR){var i;cancelTools(),getByid("MprCanvas2")?i=getByid("MprCanvas2"):(i=document.createElement("CANVAS")).id="MprCanvas2";var n=0;n+=getByid("3DDiv"+(o3DListLength-1)).thickness-Thickness-(getByid("3DDiv0").thickness-Thickness),0==(n/=o3DListLength)&&(n=1),n<0&&(n*=-1),i.style="position: absolute;top: 50%;left:50%; margin: -"+o3DListLength*(parseInt(t.style.height)/parseFloat(GetViewport().imageHeight))*n/2+"px 0 0 -"+parseInt(t.style.width)/2+"px;transform:scaleY("+-1*Direction_VR+");",GetViewport(1).appendChild(i);try{GetViewport(1).canvas().style.display="none",GetViewportMark(1).style.display="none"}catch(e){}var o=getByid("3DDiv0").canvas();i.height=o3DListLength,i.width=o.width,i.style.height=i.height*(parseInt(t.style.height)/parseFloat(GetViewport().imageHeight))*n+"px",i.style.width=t.style.width;var a=i.getContext("2d").getImageData(0,0,i.width,i.height),r=parseInt(o3DPointY),s=parseInt(o3DPointX),d=buffer_mpr_Y,l=r;if(nowInstanceNumber=e>=0?e:getNowInstance(),1==getByid("mprLight").checked){for(var h=0;h<o3DListLength;h++){for(var c=getByid("3DDiv"+h).canvas(),p=c.getContext("2d").createImageData(i.width,1),g=c.getContext("2d").createImageData(i.width,1),u=h;u==h;u+=1)for(var v=0;v<4*i.width;v+=4)p.data[v]=Uint8Canvas[h][d*o.width*4+v+0],p.data[v+1]=Uint8Canvas[h][d*o.width*4+v+1],p.data[v+2]=Uint8Canvas[h][d*o.width*4+v+2],p.data[v+3]=Uint8Canvas[h][d*o.width*4+v+3],g.data[v]=221,g.data[v+1]=53,g.data[v+2]=119,g.data[v+3]=255;c.getContext("2d").putImageData(p,0,d),c.getContext("2d").putImageData(g,0,l)}buffer_mpr_Y=r}for(h=0;h<o3DListLength;h++)for(u=h;u==h;u+=1)for(v=0;v<4*i.width;v+=4)v==4*s?(a.data[u*i.width*4+v]=38,a.data[u*i.width*4+v+1]=140,a.data[u*i.width*4+v+2]=191,a.data[u*i.width*4+v+3]=255):u==parseInt(nowInstanceNumber*(o3DListLength/SeriesCount))+0?(a.data[u*i.width*4+v]=255,a.data[u*i.width*4+v+1]=255,a.data[u*i.width*4+v+2]=0,a.data[u*i.width*4+v+3]=255):(a.data[u*i.width*4+v]=Uint8Canvas[h][r*o.width*4+v+0],a.data[u*i.width*4+v+1]=Uint8Canvas[h][r*o.width*4+v+1],a.data[u*i.width*4+v+2]=Uint8Canvas[h][r*o.width*4+v+2],a.data[u*i.width*4+v+3]=255);i.getContext("2d").putImageData(a,0,0)}}function Anatomical_Section(e){var t=GetViewport().canvas();if(0!=openMPR){var i;cancelTools(),getByid("MprCanvas1")?i=getByid("MprCanvas1"):(i=document.createElement("CANVAS")).id="MprCanvas1";var n=0;n+=getByid("3DDiv"+(o3DListLength-1)).thickness-Thickness-(getByid("3DDiv0").thickness-Thickness),(n/=o3DListLength)<0&&(n*=-1),0==n&&(n=1),i.style="position: absolute;top: 50%;left:50%; margin: -"+parseInt(t.style.height)/2+"px 0 0 -"+o3DListLength*(parseInt(t.style.height)/parseFloat(GetViewport().imageHeight))*n/2+"px;transform:rotate(-90deg) scaleY(1) scaleX("+Direction_VR+");",GetViewport(0).appendChild(i);try{GetViewport(0).canvas().style.display="none",GetViewportMark(0).style.display="none"}catch(e){}var o=getByid("3DDiv0").canvas();i.height=o.height,i.width=o3DListLength,i.style.height=t.style.height,i.style.width=i.width*(parseInt(t.style.height)/parseFloat(GetViewport().imageHeight))*n+"px";var a=i.getContext("2d").getImageData(0,0,i.width,i.height),r=parseInt(o3DPointX),s=parseInt(o3DPointY),d=buffer_mpr_X,l=r;if(nowInstanceNumber=e>=0?e:getNowInstance(),1==getByid("mprLight").checked){for(var h=0;h<o3DListLength;h++){for(var c=getByid("3DDiv"+h).canvas(),p=c.getContext("2d").createImageData(1,i.height),g=c.getContext("2d").createImageData(1,i.height),u=0;u<i.height;u+=1)for(var v=4*h;v==4*h;v+=4)p.data[4*u]=Uint8Canvas[h][u*o.width*4+4*d],p.data[4*u+1]=Uint8Canvas[h][u*o.width*4+4*d+1],p.data[4*u+2]=Uint8Canvas[h][u*o.width*4+4*d+2],p.data[4*u+3]=Uint8Canvas[h][u*o.width*4+4*d+3],g.data[4*u]=38,g.data[4*u+1]=140,g.data[4*u+2]=191,g.data[4*u+3]=255;c.getContext("2d").putImageData(p,d,0),c.getContext("2d").putImageData(g,l,0)}buffer_mpr_X=r}for(h=0;h<o3DListLength;h++)for(u=0;u<i.height;u+=1)for(v=4*h;v==4*h;v+=4)u==s?(a.data[u*i.width*4+v]=221,a.data[u*i.width*4+v+1]=53,a.data[u*i.width*4+v+2]=119,a.data[u*i.width*4+v+3]=255):h==parseInt(nowInstanceNumber*(o3DListLength/SeriesCount))+0?(a.data[u*i.width*4+v]=255,a.data[u*i.width*4+v+1]=255,a.data[u*i.width*4+v+2]=0,a.data[u*i.width*4+v+3]=255):(a.data[u*i.width*4+v]=Uint8Canvas[h][u*o.width*4+4*r],a.data[u*i.width*4+v+1]=Uint8Canvas[h][u*o.width*4+4*r+1],a.data[u*i.width*4+v+2]=Uint8Canvas[h][u*o.width*4+4*r+2],a.data[u*i.width*4+v+3]=255);i.getContext("2d").putImageData(a,0,0)}}function initMPR(){if(0==openMPR){exitMPR_UI(),VIEWPORT.fixRow=VIEWPORT.fixCol=null;for(var e=0;e<o3DListLength;e++)try{(d=getByid("3DDiv"+e)).canvas().width=2,d.canvas().height=2,d.getElementsByClassName("VrCanvas")[0]=null,d.canvas(),d.parentElement.removeChild(d),delete d}catch(M){}for(e=0;e<o3d_3degree;e++)try{(d=getByid("3DDiv2_"+e)).canvas().width=2,d.canvas().height=2,d.getElementsByClassName("VrCanvas")[0]=null,delete d,(d=getByid("3DDiv3_"+e)).canvas().width=2,d.canvas().height=2,d.getElementsByClassName("VrCanvas")[0]=null,delete d}catch(D){}VIEWPORT.lockViewportList=[],window.removeEventListener("resize",resizeVR,!1),GetViewport(3).removeEventListener("mousemove",mousemove3D,!1),GetViewport(3).removeEventListener("mousedown",mousedown3D,!1),GetViewport(3).removeEventListener("mouseup",mouseup3D,!1),GetViewport(3).removeEventListener("touchstart",touchstart3D,!1),GetViewport(3).removeEventListener("touchmove",touchmove3D,!1),GetViewport(3).removeEventListener("touchend",touchend3D,!1),GetViewport(0).removeEventListener("mousemove",Anatomical_SectionMouseMove0,!1),GetViewport(0).removeEventListener("mousedown",Anatomical_SectionMouseDown0,!1),GetViewport(0).removeEventListener("mouseup",Anatomical_SectionMouseMouseup0,!1),GetViewport(0).removeEventListener("wheel",Wheel,!1),GetViewport(1).removeEventListener("mousemove",Anatomical_SectionMouseMove,!1),GetViewport(1).removeEventListener("mousedown",Anatomical_SectionMouseDown,!1),GetViewport(1).removeEventListener("mouseup",Anatomical_SectionMouseMouseup,!1),GetViewport(1).removeEventListener("wheel",Wheel,!1),cancelTools(),openMouseTool=!0,drawBorder(getByid("MouseOperation")),getByid("ImgMPR").src="../image/icon/black/b_AdvancedMode_off.png",getByid("3dDisplay").style.display="none",getByid("mprLightLabel").style.display="none";try{getByid("MprCanvas1").style.display="none",getByid("MprCanvas2").style.display="none"}catch(V){}getByid("OutSide3dDiv")&&(getByid("OutSide3dDiv"),getByid("OutSide3dDiv").parentElement.removeChild(getByid("OutSide3dDiv")));for(var t=0;t<Viewport_Total;t++)GetViewport(t).removeEventListener("contextmenu",contextmenuF,!1),GetViewport(t).removeEventListener("mousemove",Mousemove,!1),GetViewport(t).removeEventListener("mousedown",Mousedown,!1),GetViewport(t).removeEventListener("mouseup",Mouseup,!1),GetViewport(t).removeEventListener("mouseout",Mouseout,!1),GetViewport(t).removeEventListener("wheel",Wheel,!1),GetViewport(t).removeEventListener("mousedown",thisF,!1),GetViewport(t).removeEventListener("touchstart",touchstartF,!1),GetViewport(t).removeEventListener("touchend",touchendF,!1),GetViewport(t).addEventListener("touchstart",thisF,!1),GetViewport(t).addEventListener("mousedown",thisF,!1);viewportNumber=0,window.onresize(),o3DListLength=0;var i=GetViewport(0).sop,n=SearchUid2Json(i);n&&loadAndViewImage(Patient.Study[n.studyuid].Series[n.sreiesuid].Sop[n.sopuid].imageId,0),getByid("MouseOperation").click()}else if(1==openMPR){enterMPR_UI(),VIEWPORT.fixRow=VIEWPORT.fixCol=2,openLink=!1,changeLinkImg(),openAnnotation=!1,displayAnnotation(),getByid("3dDisplay").style.display="",getByid("mprLightLabel").style.display="",getByid("SplitViewportDiv").style.display="none",cancelTools(),getByid("ImgMPR").src="../image/icon/black/b_AdvancedMode_on.png";var o=GetViewport().sop;SetTable(2,2);var a=SearchUid2Json(o);GetViewport().NowCanvasSizeWidth=GetViewport().NowCanvasSizeHeight=null;for(var r=0;r<4;r++)GetViewport(r).canvas().style.display=GetViewportMark(r).style.display="none";viewportNumber=2,loadAndViewImage(Patient.Study[a.studyuid].Series[a.sreiesuid].Sop[a.sopuid].imageId),VIEWPORT.lockViewportList=[0,1,3],window.addEventListener("resize",resizeVR,!1);for(var s=0;s<Viewport_Total;s++)GetViewport(s).removeEventListener("contextmenu",contextmenuF,!1),GetViewport(s).removeEventListener("mousemove",Mousemove,!1),GetViewport(s).removeEventListener("mousedown",Mousedown,!1),GetViewport(s).removeEventListener("mouseup",Mouseup,!1),GetViewport(s).removeEventListener("mouseout",Mouseout,!1),GetViewport(s).removeEventListener("wheel",Wheel,!1),GetViewport(s).removeEventListener("mousedown",thisF,!1),GetViewport(s).removeEventListener("touchstart",touchstartF,!1),GetViewport(s).removeEventListener("touchend",touchendF,!1),GetViewport(s).removeEventListener("touchstart",thisF,!1);for(GetViewport().addEventListener("contextmenu",contextmenuF,!1),GetViewport().addEventListener("mouseout",Mouseout,!1),GetViewport().addEventListener("touchstart",touchstartF,!1),GetViewport().addEventListener("touchmove",touchmoveF,!1),GetViewport().addEventListener("touchend",touchendF,!1),GetViewport().addEventListener("wheel",Wheel,!1),GetViewport(3).addEventListener("mousemove",mousemove3D,!1),GetViewport(3).addEventListener("mousedown",mousedown3D,!1),GetViewport(3).addEventListener("mouseup",mouseup3D,!1),GetViewport(3).addEventListener("touchstart",touchstart3D,!1),GetViewport(3).addEventListener("touchmove",touchmove3D,!1),GetViewport(3).addEventListener("touchend",touchend3D,!1),GetViewport(3).addEventListener("contextmenu",contextmenuF,!1),GetViewport(0).addEventListener("mousemove",Anatomical_SectionMouseMove0,!1),GetViewport(0).addEventListener("mousedown",Anatomical_SectionMouseDown0,!1),GetViewport(0).addEventListener("mouseup",Anatomical_SectionMouseMouseup0,!1),GetViewport(0).addEventListener("wheel",Wheel,!1),GetViewport(1).addEventListener("mousemove",Anatomical_SectionMouseMove,!1),GetViewport(1).addEventListener("mousedown",Anatomical_SectionMouseDown,!1),GetViewport(1).addEventListener("mouseup",Anatomical_SectionMouseMouseup,!1),GetViewport(1).addEventListener("wheel",Wheel,!1),e=0;e<o3DListLength;e++){var d=getByid("3DDiv"+e);GetViewport(3).appendChild(d)}var l=sortInstance(o),h=getViewportFixSize(window.innerWidth,window.innerHeight,2,2);if(o3DListLength!=l.length)for(e=0;e<o3DListLength;e++)try{(d=getByid("3DDiv"+e)).canvas().width=2,d.canvas().height=2,d.getElementsByClassName("VrCanvas")[0]=null,d.canvas(),d.parentElement.removeChild(d),delete d}catch(L){}if(o3d_3degree>=0){for(e=0;e<o3d_3degree;e++)try{(d=getByid("3DDiv2_"+e)).canvas().width=2,d.canvas().height=2,d.getElementsByClassName("VrCanvas")[0]=null,d.canvas(),d.parentElement.removeChild(d),delete d}catch(C){}for(e=0;e<o3d_3degree;e++)try{(d=getByid("3DDiv3_"+e)).canvas().width=2,d.canvas().height=2,d.getElementsByClassName("VrCanvas")[0]=null,d.canvas(),d.parentElement.removeChild(d),delete d}catch(P){}}o3DListLength=l.length,Thickness=0;var c=1e29,p=document.createElement("DIV");function g(e){return new Promise((t=>setTimeout(t,e)))}p.id="OutSide3dDiv",openRendering=!0,img2darkByClass("Rendering",!openRendering);var u=!1;function v(e,t,i){e.width=t.width,e.height=t.height,e.style.width=t.width+"px",e.style.height=t.height+"px";var n=e.getContext("2d"),o=n.createImageData(t.width,t.height),a=t.windowWidth,r=t.windowCenter;1==getByid("o3DAngio").selected?(a=332,r=287):1==getByid("o3DAirways").selected&&(a=409,r=-538);var s=r+a/2,d=r-a/2,l=t.intercept;CheckNull(l)&&(l=0);var h=t.slope;CheckNull(h)&&(h=1);var c=0;if(1==t.color)for(var p=0;p<o.data.length;p+=4)c=i[p],c=parseInt((c*h-d+l)/(s-d)*255),o.data[p+0]=c,c=i[p+1],c=parseInt((c*h-d+l)/(s-d)*255),o.data[p+1]=c,c=i[p+2],c=parseInt((c*h-d+l)/(s-d)*255),o.data[p+2]=c,o.data[p+3]=255;else if(1!=t.invert&&1==GetViewport().openInvert||1==t.invert&&0==GetViewport().openInvert){p=0;for(var g=0;p<o.data.length;p+=4,g++)o.data[p+0]=o.data[p+1]=o.data[p+2]=255-parseInt((i[g]*h-d+l)/(s-d)*255),o.data[p+3]=255}else for(p=0,g=0;p<o.data.length;p+=4,g++)o.data[p+0]=o.data[p+1]=o.data[p+2]=parseInt((i[g]*h-d+l)/(s-d)*255),o.data[p+3]=255;n.putImageData(o,0,0)}GetViewport(3).appendChild(p),getByid("OutSide3dDiv").parentNode.replaceChild(p,getByid("OutSide3dDiv")),getByid("OutSide3dDiv").style.transformStyle="",Thickness=-Thickness+c;for(var w=0;w<l.length;w++){const f=w,R=getPatientbyImageID[l[f].imageId].image,B=getPatientbyImageID[l[f].imageId].pixelData;try{var m=document.createElement("DIV");m.addEventListener("contextmenu",contextmenuF,!1),m.id="3DDiv"+f,m.className="o3DDiv",m.sop=R.data.string("x00080018"),m.width=R.width,m.height=R.height,m.style.width=R.width+"px",m.style.height=R.height+"px",m.thickness=parseFloat(R.data.string("x00200032").split("\\")[2])*GetViewport().PixelSpacingX,m.thickness<Thickness&&(Thickness=m.thickness),m.thickness<c&&(c=m.thickness),o3Dcount=l.length,p.appendChild(m),getByid("3DDiv"+f).parentNode.replaceChild(m,getByid("3DDiv"+f)),m.style.zIndex=f;var y=document.createElement("CANVAS");y.className="VrCanvas",m.appendChild(y),v(y,R,B),m.style.transform="rotate3d(0, 0, 0 , 0deg) translateZ(-"+f+"px)",m.style.width=h[0]+"px",m.style.height=h[1]+"px",m.canvas=function(){return this.getElementsByClassName("VrCanvas")[0]?this.getElementsByClassName("VrCanvas")[0]:null},m.ctx=function(){return this.getElementsByClassName("VrCanvas")[0]?this.getElementsByClassName("VrCanvas")[0].getContext("2d"):null}}catch(G){return u=!0,1==openMPR&&(openMPR=!1,alert("Error, this image may not support 3D.")),openRendering=!1,void getByid("ImgMPR").click("error")}}return void function(){if(1==u&&1==openMPR)return openRendering=!1,img2darkByClass("MPR",!openMPR),void getByid("ImgMPR").click();g(100).then((()=>{if(Direction_VR=1,getByid("3DDiv"+(o3DListLength-1)).thickness-Thickness-(getByid("3DDiv0").thickness-Thickness)<0){Direction_VR=-1;for(var e=[],t=0;t<o3DListLength;t++){var i=getByid("3DDiv"+t);e.push(i.thickness)}for(t=0;t<o3DListLength;t++)(i=getByid("3DDiv"+t)).thickness=e[o3DListLength-t-1]}Alpha3D(),g(100).then((()=>{openRendering=!1,img2darkByClass("MPR",!openMPR),setTimeout(getByid("MouseOperation_MPR").click(),100)}))}))}()}}function display3DLine(e,t,i,n,o){if(o||(o="#00FF00"),openMPR){var a=GetViewportMark(),r=a.getContext("2d"),s=parseFloat(a.width)/parseFloat(Css(a,"width"));s<=0&&(s=parseFloat(Css(a,"width"))/parseFloat(a.width)),s<=1.5&&(s=1.5),r.lineWidth=""+1*Math.abs(s),nowInstanceNumber=getNowInstance,r.beginPath(),r.strokeStyle=o,r.fillStyle=o,r.moveTo(e,t),r.lineTo(i,n),r.stroke(),2==openAngle&&(r.moveTo(e,t),r.lineTo(x2,y2),r.stroke()),r.closePath()}}function o3dWindowLevel(){var e=GetViewport().sop;if(o3Dcount!=o3DListLength)for(var t=o3DListLength-1;t>=o3Dcount;t--)(i=getByid("3DDiv"+t)).canvas().width=2,i.canvas().height=2,i.parentElement.removeChild(i);for(o3DListLength=o3Dcount,t=0;t<o3DListLength;t++)try{(i=getByid("3DDiv"+t)).canvas().width=2,i.canvas().height=2}catch(e){}if(o3d_3degree>=0){for(t=0;t<o3d_3degree;t++)(i=getByid("3DDiv2_"+t)).canvas().width=2,i.canvas().height=2,i.getElementsByClassName("VrCanvas")[0]=null,i.canvas(),i.parentElement.removeChild(i),delete i;for(t=0;t<o3d_3degree;t++){var i;(i=getByid("3DDiv3_"+t)).canvas().width=2,i.canvas().height=2,i.getElementsByClassName("VrCanvas")[0]=null,i.canvas(),i.parentElement.removeChild(i),delete i}}var n,o=sortInstance(e);openVR?n=getViewportFixSize(window.innerWidth,window.innerHeight,1,1):openMPR&&(n=getViewportFixSize(window.innerWidth,window.innerHeight,2,2)),o3DListLength=o.length;var a=1e28;function r(e){return new Promise((t=>setTimeout(t,e)))}Thickness=0,openRendering=!0,img2darkByClass("Rendering",!openRendering),Thickness=0,a=1e19,Thickness=-Thickness+a;for(var s=0;s<o.length;s++){const e=s,t=getPatientbyImageID[o[e].imageId].image,i=getPatientbyImageID[o[e].imageId].pixelData;var d=document.createElement("DIV");d.addEventListener("contextmenu",contextmenuF,!1),d.id="3DDiv"+e,d.className="o3DDiv",d.sop=t.data.string("x00080018"),d.thickness=parseFloat(t.data.string("x00200032").split("\\")[2])*GetViewport().PixelSpacingX,d.thickness<Thickness&&(Thickness=d.thickness),d.thickness<a&&(a=d.thickness),d.width=t.width,d.height=t.height,d.style.width=t.width+"px",d.style.height=t.height+"px",d.style.zIndex=e,o3Dcount=o.length,1==openVR?GetViewport(0).appendChild(d):1==openMPR&&GetViewport(3).appendChild(d),getByid("3DDiv"+e).parentNode.replaceChild(d,getByid("3DDiv"+e));var l=document.createElement("CANVAS");l.className="VrCanvas",d.appendChild(l),displayCanvasFor3D(l,t,i),d.style.transform="rotate3d(0, 0, 0 , 0deg) translateZ(-"+e+"px)",d.style.width=n[0]+"px",d.style.height=n[1]+"px",d.canvas=function(){return this.getElementsByClassName("VrCanvas")[0]?this.getElementsByClassName("VrCanvas")[0]:null},d.ctx=function(){return this.getElementsByClassName("VrCanvas")[0]?this.getElementsByClassName("VrCanvas")[0].getContext("2d"):null}}Direction_VR=1,r(100).then((()=>{if(getByid("3DDiv"+(o3DListLength-1)).thickness-Thickness-(getByid("3DDiv0").thickness-Thickness)<0){var e=[];Direction_VR=-1;for(var t=0;t<o3DListLength;t++){var i=getByid("3DDiv"+t);e.push(i.thickness)}for(t=0;t<o3DListLength;t++)(i=getByid("3DDiv"+t)).thickness=e[o3DListLength-t-1]}Alpha3D(),r(100).then((()=>{openRendering=!1,openMPR?img2darkByClass("MPR",!openMPR):openVR&&img2darkByClass("VR",!openVR)}))}))}loadMPR(),loadMPR_UI(),getByid("MouseOperation_MPR").style.display="none",getByid("WindowRevision_MPR").style.display="none",getByid("b_Scroll_MPR").style.display="none",getByid("MouseRotate_MPR").style.display="none",getByid("b_Scroll_MPR").onclick=function(){0!=this.enable&&(set_BL_model("scroll"),scroll(),Touchmove=function(e,t){var i=getCurrPoint(e)[0],n=getCurrPoint(e)[1];if(t&&(getCurrPoint(t)[0],getCurrPoint(t)[1]),1==TouchDownCheck&&0==rightTouchDown){var o=-1,a=GetViewport().sop;let e=SearchUid2Index(a),t=e[0],d=e[1],h=e[2];var r=parseInt(Patient.Study[t].Series[d].Sop[h].InstanceNumber),s=sortInstance(a);for(l=0;l<s.length&&s[l].InstanceNumber!=r;l++);Math.abs(n-GetViewport().originalPointY)<Math.abs(i-GetViewport().originalPointX)?i<GetViewport().originalPointX-3?(nextFrame(viewportNumber,-1),o=l-1<0?s.length-1:l-1):i>GetViewport().originalPointX+3&&(nextFrame(viewportNumber,1),s[l].InstanceNumber==r&&(o=l+1>=s.length?0:l+1)):n<GetViewport().originalPointY-3?(nextFrame(viewportNumber,-1),o=l-1<0?s.length-1:l-1):n>GetViewport().originalPointY+3&&(nextFrame(viewportNumber,1),o=l+1>=s.length?0:l+1),GetViewport().originalPointX=i,GetViewport().originalPointY=n,1==openMPR&&o>-1&&(Anatomical_Section(o),Anatomical_Section2(o))}},drawBorderMPR(this))},getByid("WindowRevision_MPR").onclick=function(){0!=this.enable&&(set_BL_model("windowlevel"),windowlevel(),drawBorderMPR(this))},getByid("MouseRotate_MPR").onclick=function(){0!=this.enable&&(set_BL_model("rotate"),rotate(),drawBorderMPR(this))},getByid("MouseOperation_MPR").onclick=function(){if(0!=this.enable){for(var e=getClass("MPR_div"),t=0;t<e.length;t++)e[t].style.display="none";set_BL_model("mouseTool_MPR"),GetViewport(2).removeEventListener("mousemove",Mousemove,!1),GetViewport(2).removeEventListener("mousedown",Mousedown,!1),GetViewport(2).removeEventListener("mouseup",Mouseup,!1),GetViewport(2).removeEventListener("wheel",Wheel,!1),Wheel=function(e){if(openMPR){for(var t=GetViewport(),i=t.canvas(),n=0,o=!1,a=viewportNumber,r=0;r<Viewport_Total;r++){o=!1,1==openLink&&(a=r),e.pageX,i.getBoundingClientRect().left,GetViewport().newMousePointX,GetViewport().imageWidth,parseInt(GetViewport().canvas().style.width),e.pageY,i.getBoundingClientRect().top,GetViewport().newMousePointY,GetViewport().imageHeight,parseInt(GetViewport().canvas().style.height);var s=GetViewport(a).sop;try{var[d,l,h]=SearchUid2Index(t.sop)}catch(e){return}var c=parseInt(Patient.Study[d].Series[l].Sop[h].InstanceNumber),p=sortInstance(s);if(!(p.length<=1)){if(e.deltaY<0){for(var g=0;g<p.length&&1!=o;g++)if(p[g].InstanceNumber==c){if(g-1<0){loadAndViewImage(p[p.length-1].imageId,a),n=p.length-1,o=!0;break}loadAndViewImage(p[g-1].imageId,a),n=g-1,o=!0;break}}else for(g=0;g<p.length&&1!=o;g++)if(p[g].InstanceNumber==c){if(g+1>=p.length){loadAndViewImage(p[0].imageId,a),n=0,o=!0;break}loadAndViewImage(p[g+1].imageId,a),n=g+1,o=!0;break}if(0==openLink)break}}Anatomical_Section(n),Anatomical_Section2(n)}},Mousedown=function(e){1==e.which?MouseDownCheck=!0:3==e.which&&(rightMouseDown=!0),windowMouseX=GetmouseX(e),windowMouseY=GetmouseY(e),GetViewport().originalPointX=getCurrPoint(e)[0],GetViewport().originalPointY=getCurrPoint(e)[1]},Mousemove=function(e){if("mouseTool_MPR"==BL_mode){var t=GetViewport();if(t.canvas(),t.openMark||GetViewportMark().getContext("2d").clearRect(0,0,GetViewportMark().width,GetViewportMark().height),1==openMPR&&1!=openWindow&&1!=openChangeFile&&1==MouseDownCheck){viewportNumber=2;let i=rotateCalculation(e);currX11M=i[0],currY11M=i[1],o3DPointX=currX11M,o3DPointY=currY11M,AngleXY0=[currX11M,0],AngleXY1=[currX11M,t.imageHeight],1==openMPR&&(Anatomical_Section(),Anatomical_Section2()),display3DLine(currX11M,0,currX11M,t.imageHeight,"rgb(38,140,191)"),display3DLine(0,currY11M,t.imageWidth,currY11M,"rgb(221,53,119)")}}},Mouseup=function(e){MouseDownCheck=!1,rightMouseDown=!1},Touchmove=function(e,t){if("mouseTool_MPR"==BL_mode){var i=GetViewport();if(i.canvas(),i.openMark||GetViewportMark().getContext("2d").clearRect(0,0,GetViewportMark().width,GetViewportMark().height),(!openDisplayMarkup||!getByid("DICOMTagsSelect").selected&&!getByid("AIMSelect").selected)&&1==openMPR&&1==TouchDownCheck){viewportNumber=2;let t=rotateCalculation(e);currX11M=t[0],currY11M=t[1],o3DPointX=currX11M,o3DPointY=currY11M,AngleXY0=[currX11M,0],AngleXY1=[currX11M,i.imageHeight],1==openMPR&&(Anatomical_Section(),Anatomical_Section2()),display3DLine(currX11M,0,currX11M,i.imageHeight,"rgb(38,140,191)"),display3DLine(0,currY11M,i.imageWidth,currY11M,"rgb(221,53,119)")}}},GetViewport(2).addEventListener("mousemove",Mousemove,!1),GetViewport(2).addEventListener("mousedown",Mousedown,!1),GetViewport(2).addEventListener("mouseup",Mouseup,!1),GetViewport(2).addEventListener("wheel",Wheel,!1),drawBorderMPR(this)}},getByid("ImgMPR").onclick=function(e){0!=this.enable&&(openMPR=!openMPR,"error"==e&&(openMPR=!1),img2darkByClass("MPR",!openMPR),initMPR())},Anatomical_SectionMouseDown0=function(e){1==e.which?MouseDownCheck=!0:3==e.which&&(rightMouseDown=!0),windowMouseX=GetmouseX(e),windowMouseY=GetmouseY(e),GetViewport().originalPointX=getCurrPoint(e)[0],GetViewport().originalPointY=getCurrPoint(e)[1]},Anatomical_SectionMouseMouseup=function(e){getCurrPoint(e)[0],getCurrPoint(e)[1],MouseDownCheck=!1,rightMouseDown=!1},Anatomical_SectionMouseMove=function(e){if(1==openMPR&&1!=openWindow&&1!=openChangeFile&&1==MouseDownCheck){let r=rotateCalculation(e);if(currX11M=r[0],currY11M=r[1],o3DPointX=currX11M,o3DPointY=currY11M,AngleXY0=[currX11M,0],AngleXY1=[currX11M,GetViewport(1).imageHeight],1==openMPR){var t=GetViewport().sop,i=SearchUid2Index(t),n=i[0],o=i[1],a=i[2];Anatomical_Section(parseInt(Patient.Study[n].Series[o].Sop[a].InstanceNumber),!0)}display3DLine(currX11M,0,currX11M,GetViewport().imageHeight,"rgb(38,140,191)")}},Anatomical_SectionMouseDown=function(e){1==e.which?MouseDownCheck=!0:3==e.which&&(rightMouseDown=!0),windowMouseX=GetmouseX(e),windowMouseY=GetmouseY(e),GetViewport().originalPointX=getCurrPoint(e)[0],GetViewport().originalPointY=getCurrPoint(e)[1]},Anatomical_SectionMouseMouseup0=function(e){getCurrPoint(e)[0],getCurrPoint(e)[1],MouseDownCheck=!1,rightMouseDown=!1},Anatomical_SectionMouseMove0=function(e){if(1==openMPR&&1!=openWindow&&1!=openChangeFile&&1==MouseDownCheck){let r=rotateCalculation(e);if(currX11M=r[1],currY11M=r[0],o3DPointX=currX11M,o3DPointY=currY11M,AngleXY1=[currX11M,0],AngleXY0=[currX11M,GetViewport(0).imageHeight],1==openMPR){var t=GetViewport().sop,i=SearchUid2Index(t),n=i[0],o=i[1],a=i[2];Anatomical_Section2(parseInt(Patient.Study[n].Series[o].Sop[a].InstanceNumber))}display3DLine(0,currY11M,GetViewport().imageWidth,currY11M,"rgb(221,53,119)")}};