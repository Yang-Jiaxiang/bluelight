var openWriteXML=!1;function loadxml_format(){var e;(e=document.createElement("SPAN")).innerHTML='<img class="img XML" alt="writeXML" id="writeXML" src="../image/icon/black/xml_off.png" width="50" height="50">',getByid("icon-list").appendChild(e),(e=document.createElement("SPAN")).innerHTML='<label style="color: #ffffff;" id="xmlMarkName">name<input type="text" id="xmlMarkNameText" value="noName" /></label>',getByid("page-header").appendChild(e),getByid("xmlMarkName").style.display="none"}function drawXML_mark_Write(e){var t=e.canvas,a=e.mark,n=e.showName;if("XML_mark"==a.type){var r=t.getContext("2d");r.globalAlpha=parseFloat(getByid("markAlphaText").value)/100;var o=r.globalAlpha;if(r.globalAlpha=1,r.font=12*parseInt(r.lineWidth)+"px Arial",r.fillStyle="red",1==openWriteXML)for(var i=0;i<a.markX.length;i+=2){r.strokeStyle=""+a.parent.color,r.beginPath();var l=1*a.markX[i],m=1*a.markY[i],s=(a.markX.length,1*a.markX[i+1]),h=1*a.markY[i+1];r.fillText(""+n,l<s?l:s,m<h?m-5:h-5),r.rect(l,m,s-l,h-m),r.stroke(),r.closePath(),1==openWriteXML&&(r.lineWidth=""+2*parseInt(r.lineWidth),r.beginPath(),xml_now_choose&&xml_now_choose.mark==a&&(r.strokeStyle="#00FFFF",r.arc(l/2+s/2,m,parseInt(r.lineWidth),0,2*Math.PI),r.stroke(),r.closePath(),r.beginPath(),r.strokeStyle="#00FFFF",r.arc(l/2+s/2,h,parseInt(r.lineWidth),0,2*Math.PI),r.stroke(),r.closePath(),r.beginPath(),r.strokeStyle="#00FFFF",r.arc(l,m/2+h/2,parseInt(r.lineWidth),0,2*Math.PI),r.stroke(),r.closePath(),r.beginPath(),r.strokeStyle="#00FFFF",r.arc(s,m/2+h/2,parseInt(r.lineWidth),0,2*Math.PI),r.stroke(),r.closePath()),r.beginPath(),r.fillStyle="#FF0000",r.arc(l/2+s/2,m,parseInt(r.lineWidth),0,2*Math.PI),r.fill(),r.closePath(),r.beginPath(),r.fillStyle="#FF0000",r.arc(l/2+s/2,h,parseInt(r.lineWidth),0,2*Math.PI),r.fill(),r.closePath(),r.beginPath(),r.fillStyle="#FF0000",r.arc(l,m/2+h/2,parseInt(r.lineWidth),0,2*Math.PI),r.fill(),r.closePath(),r.beginPath(),r.fillStyle="#FF0000",r.arc(s,m/2+h/2,parseInt(r.lineWidth),0,2*Math.PI),r.fill(),r.closePath(),r.lineWidth=""+parseInt(r.lineWidth)/2)}else for(i=0;i<a.markX.length;i+=2)r.strokeStyle=""+a.parent.color,r.beginPath(),l=1*a.markX[i],m=1*a.markY[i],a.markX.length,s=1*a.markX[i+1],h=1*a.markY[i+1],r.fillText(""+n,l<s?l:s,m<h?m-5:h-5),r.rect(l,m,s-l,h-m),r.stroke(),r.closePath(),1==openWriteXML&&(r.lineWidth=""+2*parseInt(r.lineWidth),r.beginPath(),r.fillStyle="#FF0000",r.arc(l/2+s/2,m,parseInt(r.lineWidth),0,2*Math.PI),r.fill(),r.closePath(),r.beginPath(),r.fillStyle="#FF0000",r.arc(l/2+s/2,h,parseInt(r.lineWidth),0,2*Math.PI),r.fill(),r.closePath(),r.beginPath(),r.fillStyle="#FF0000",r.arc(l,m/2+h/2,parseInt(r.lineWidth),0,2*Math.PI),r.fill(),r.closePath(),r.beginPath(),r.fillStyle="#FF0000",r.arc(s,m/2+h/2,parseInt(r.lineWidth),0,2*Math.PI),r.fill(),r.closePath(),r.lineWidth=""+parseInt(r.lineWidth)/2);r.globalAlpha=o}}loadxml_format(),getByid("writeXML").onclick=function(){0!=this.enable&&(cancelTools(),openWriteXML=!openWriteXML,img2darkByClass("XML",!openWriteXML),openLeftImgClick=!openWriteXML,this.src=1==openWriteXML?"../image/icon/black/xml_on.png":"../image/icon/black/xml_off.png",1==openWriteXML?(getByid("xmlMarkName").style.display="",set_BL_model("writexml"),writexml()):getByid("xmlMarkName").style.display="none",displayMark(),1!=openWriteXML&&(xml_now_choose=null,setXml_context(),function(e,t,a){let n=document.createElement("a"),r=new Blob([e],{type:"text/plain"});n.href=window.URL.createObjectURL(r),n.download="filename.xml",n.click()}(String(getXml_context())),getByid("MouseOperation").click()))},window.addEventListener("keydown",(e=>{var t=e.which;openWriteXML&&xml_now_choose&&(46===t||110===t)&&(PatientMark.splice(PatientMark.indexOf(xml_now_choose.reference),1),displayMark(),xml_now_choose=null,refreshMarkFromSop(GetNowUid().sop)),xml_now_choose=null})),getByid("xmlMarkNameText").onchange=function(){if(xml_now_choose){xml_now_choose.reference.showName=""+this.value,xml_now_choose.reference.hideName=xml_now_choose.reference.showName,refreshMark(xml_now_choose.reference),xml_now_choose=null;for(var e=0;e<Viewport_Total;e++)displayMark(e)}},PLUGIN.PushMarkList(drawXML_mark_Write);var xml_format="\n<annotation>\n  <folder>Unknown</folder>\n  <filename>Unknown</filename>\n  <path>Unknown</path>\n  <source>\n    <database>Unknown</database>\n  </source>\n  <size>\n    <width>_width_</width>\n    <height>_height_</height>\n    <depth>3</depth>\n  </size>\n  <segmented>0</segmented>\n  <object>\n    <name>_name_</name>\n    <pose>Unknown</pose>\n    <truncated>0</truncated>\n    <difficult>0</difficult>\n    <bndbox>\n      <xmin>_xmin_</xmin>\n      <ymin>_ymin_</ymin>\n      <xmax>_xmax_</xmax>\n      <ymax>_ymax_</ymax>\n    </bndbox>\n  </object>\n  \n</annotation>\n",xml_format_title="\n<annotation>\n  <folder>Unknown</folder>\n  <filename>Unknown</filename>\n  <path>Unknown</path>\n  <source>\n    <database>Unknown</database>\n  </source>\n  <size>\n    <width>_width_</width>\n    <height>_height_</height>\n    <depth>3</depth>\n  </size>\n  <segmented>0</segmented>",xml_format_object="\n  <object>\n    <name>_name_</name>\n    <pose>Unknown</pose>\n    <truncated>0</truncated>\n    <difficult>0</difficult>\n    <bndbox>\n      <xmin>_xmin_</xmin>\n      <ymin>_ymin_</ymin>\n      <xmax>_xmax_</xmax>\n      <ymax>_ymax_</ymax>\n    </bndbox>\n  </object>\n",xml_format_object_list=[],xml_format_tail="\n</annotation>\n",xml_now_choose=null,temp_xml_format="";function setXml_context(){xml_format_object_list=[];let e="",t=SearchUid2Index(GetViewport().sop),a=t[0],n=t[1],r=t[2];for(var o=0;o<PatientMark.length;o++)if(e=""+xml_format_object,PatientMark[o].sop==Patient.Study[a].Series[n].Sop[r].SopUID)for(var i=0;i<PatientMark[o].mark.length;i++)if("XML_mark"==PatientMark[o].mark[i].type)for(var l=PatientMark[o].mark[i],m=0;m<PatientMark[o].mark[i].markX.length;m+=2){var s=parseInt(l.markX[m]),h=parseInt(l.markY[m]),k=parseInt(l.markX[m+1]),p=parseInt(l.markY[m+1]);e=e.replace("_xmin_",s<k?s:k),e=e.replace("_ymin_",h<p?h:p),e=e.replace("_xmax_",s>k?s:k),e=e.replace("_ymax_",h>p?h:p),e=e.replace("_name_",PatientMark[o].showName),xml_format_object_list.push(e)}}function getXml_context(){for(var e="",t=0;t<xml_format_object_list.length;t++)e+=xml_format_object_list[t];return xml_format_title.replace("_width_",GetViewport().imageWidth).replace("_height_",GetViewport().imageHeight)+e+xml_format_tail}function xml_pounch(e,t){let a=4*getMarkSize(GetViewportMark(),!1),n=SearchUid2Index(GetViewport().sop),r=n[0],o=n[1],i=n[2];for(var l=0;l<PatientMark.length;l++)if(PatientMark[l].sop==Patient.Study[r].Series[o].Sop[i].SopUID)for(var m=0;m<PatientMark[l].mark.length;m++)if("XML_mark"==PatientMark[l].mark[m].type)for(var s=PatientMark[l].mark[m],h=0;h<PatientMark[l].mark[m].markX.length;h+=2){var k=parseInt(s.markX[h]),p=parseInt(s.markY[h]),c=parseInt(s.markX[h+1]),d=parseInt(s.markY[h+1]);if(t+a>=p&&e+a>=k/2+c/2&&t<p+a&&e<k/2+c/2+a)return xml_now_choose={reference:PatientMark[l],mark:s,value:"up"},getByid("xmlMarkNameText").value=""+PatientMark[l].showName,!0;if(t+a>=d&&e+a>=k/2+c/2&&t<d+a&&e<k/2+c/2+a)return xml_now_choose={reference:PatientMark[l],mark:s,value:"down"},getByid("xmlMarkNameText").value=""+PatientMark[l].showName,!0;if(t+a>=p/2+d/2&&e+a>=k&&t<p/2+d/2+a&&e<k+a)return xml_now_choose={reference:PatientMark[l],mark:s,value:"left"},getByid("xmlMarkNameText").value=""+PatientMark[l].showName,!0;if(t+a>=p/2+d/2&&e+a>=c&&t<p/2+d/2+a&&e<c+a)return xml_now_choose={reference:PatientMark[l],mark:s,value:"right"},getByid("xmlMarkNameText").value=""+PatientMark[l].showName,!0}return xml_now_choose=null,!1}function deleteXml(){let e=SearchUid2Index(GetViewport().sop),t=e[0],a=e[1],n=e[2];for(var r=[],o=0;o<PatientMark.length;o++)if(PatientMark[o].sop==Patient.Study[t].Series[a].Sop[n].SopUID)for(var i=0;i<PatientMark[o].mark.length;i++)"XML_mark"==PatientMark[o].mark[i].type&&r.push(PatientMark[o]);for(var l=0;l<r.length;l++)PatientMark.splice(PatientMark.indexOf(r),1);refreshMarkFromSop(Patient.Study[t].Series[a].Sop[n].SopUID),displayMark()}function importXml(e){var t=new XMLHttpRequest;try{t.open("get",e,!1)}catch(e){}t.responseType="xml",t.onreadystatechange=function(e){try{var a=(new DOMParser).parseFromString(t.response,"text/xml").getElementsByTagName("annotation")[0].getElementsByTagName("object");let e=SearchNowUid();for(var n=0;n<a.length;n++){var r={};r.study=e.studyuid,r.series=e.sreiesuid,r.color="#0000FF",r.mark=[],r.showName=""+a[n].getElementsByTagName("name")[0].childNodes[0].data,r.hideName=r.showName,r.mark.push({}),r.sop=e.sopuid;var o=r.mark.length-1;r.mark[o].type="XML_mark",r.mark[o].markX=[],r.mark[o].markY=[],r.mark[o].markX.push(a[n].getElementsByTagName("bndbox")[0].getElementsByTagName("xmin")[0].childNodes[0].data),r.mark[o].markY.push(a[n].getElementsByTagName("bndbox")[0].getElementsByTagName("ymin")[0].childNodes[0].data),r.mark[o].markX.push(a[n].getElementsByTagName("bndbox")[0].getElementsByTagName("xmax")[0].childNodes[0].data),r.mark[o].markY.push(a[n].getElementsByTagName("bndbox")[0].getElementsByTagName("ymax")[0].childNodes[0].data),PatientMark.push(r)}refreshMark(r),setXml_context()}catch(e){}},t.send()}function writexml(){"writexml"==BL_mode&&(DeleteMouseEvent(),Mousedown=function(e){1==e.which?MouseDownCheck=!0:3==e.which&&(rightMouseDown=!0);var t=getCurrPoint(e)[0],a=getCurrPoint(e)[1];windowMouseX=GetmouseX(e),windowMouseY=GetmouseY(e),GetViewport().originalPointX=getCurrPoint(e)[0],GetViewport().originalPointY=getCurrPoint(e)[1],1==xml_pounch(t,a)&&displayMark()},Mousemove=function(e){var t=getCurrPoint(e)[0],a=getCurrPoint(e)[1],n=getClass("labelXY");{let t=rotateCalculation(e);n[viewportNumber].innerText="X: "+parseInt(t[0])+" Y: "+parseInt(t[1])}if(1==rightMouseDown&&scale_size(e,t,a),1==openLink)for(var r=0;r<Viewport_Total;r++)GetViewport(r).newMousePointX=GetViewport().newMousePointX,GetViewport(r).newMousePointY=GetViewport().newMousePointY;for(putLabel(),r=0;r<Viewport_Total;r++)displayRuler(r);if(MouseDownCheck)if(windowMouseX=GetmouseX(e),windowMouseY=GetmouseY(e),xml_now_choose)for("up"==xml_now_choose.value?xml_now_choose.mark.markY[0]=a:"down"==xml_now_choose.value?xml_now_choose.mark.markY[1]=a:"left"==xml_now_choose.value?xml_now_choose.mark.markX[0]=t:"right"==xml_now_choose.value&&(xml_now_choose.mark.markX[1]=t),r=0;r<Viewport_Total;r++)displayMark(r);else{let e=SearchNowUid();var o={};o.study=e.studyuid,o.series=e.sreiesuid,o.color="#0000FF",o.mark=[],o.showName=""+getByid("xmlMarkNameText").value,o.hideName=o.showName,o.mark.push({}),o.sop=e.sopuid;var i=o.mark.length-1;o.mark[i].type="XML_mark",o.mark[i].markX=[],o.mark[i].markY=[],o.mark[i].markX.push(GetViewport().originalPointX),o.mark[i].markY.push(GetViewport().originalPointY),o.mark[i].markX.push(t),o.mark[i].markY.push(a),PatientMark.push(o),refreshMark(o);for(r=0;r<Viewport_Total;r++)displayMark(r);displayAngleRuler(),PatientMark.splice(PatientMark.indexOf(o),1)}},Mouseup=function(e){var t=getCurrPoint(e)[0],a=getCurrPoint(e)[1];if(MouseDownCheck=!1,rightMouseDown=!1,1==openWriteXML&&!xml_now_choose){let e=SearchNowUid();var n={};n.study=e.studyuid,n.series=e.sreiesuid,n.color="#0000FF",n.mark=[],n.showName=""+getByid("xmlMarkNameText").value,n.hideName=n.showName,n.mark.push({}),n.sop=e.sopuid;var r=n.mark.length-1;n.mark[r].type="XML_mark",n.mark[r].markX=[],n.mark[r].markY=[],n.mark[r].markX.push(GetViewport().originalPointX),n.mark[r].markY.push(GetViewport().originalPointY),n.mark[r].markX.push(t),n.mark[r].markY.push(a),PatientMark.push(n),refreshMark(n);for(var o=0;o<Viewport_Total;o++)displayMark(o);displayAngleRuler()}}),AddMouseEvent()}