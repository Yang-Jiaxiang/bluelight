var ColorSpace={Unkown:0,Grayscale:1,AdobeRGB:2,RGB:3,CYMK:4},JpegImage=function(){"use strict";var e=new Int32Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),r=4017,n=799,o=3406,a=2276,t=1567,s=3784,i=5793,c=2896;function l(){}function f(e,r){for(var n,o,a=0,t=[],s=16;s>0&&!e[s-1];)s--;t.push({children:[],index:0});var i,c=t[0];for(n=0;n<s;n++){for(o=0;o<e[n];o++){for((c=t.pop()).children[c.index]=r[a];c.index>0;)c=t.pop();for(c.index++,t.push(c);t.length<=n;)t.push(i={children:[],index:0}),c.children[c.index]=i.children,c=i;a++}n+1<s&&(t.push(i={children:[],index:0}),c.children[c.index]=i.children,c=i)}return t[0].children}function h(e,r,n){return 64*((e.blocksPerLine+1)*r+n)}function u(r,n,o,a,t,s,i,c,l){o.precision,o.samplesPerLine,o.scanLines;var f=o.mcusPerLine,u=o.progressive,b=(o.maxH,o.maxV,n),v=0,p=0;function m(){if(p>0)return p--,v>>p&1;if(255==(v=r[n++])){var e=r[n++];if(e)throw"unexpected marker: "+(v<<8|e).toString(16)}return p=7,v>>>7}function d(e){for(var r,n=e;null!==(r=m());){if("number"==typeof(n=n[r]))return n;if("object"!=typeof n)throw"invalid huffman sequence"}return null}function k(e){for(var r=0;e>0;){var n=m();if(null===n)return;r=r<<1|n,e--}return r}function C(e){var r=k(e);return r>=1<<e-1?r:r+(-1<<e)+1}var w,P=0,g=0;function y(e,r,n,o,a){var t=n%f;r(e,h(e,(n/f|0)*e.v+o,t*e.h+a))}function D(e,r,n){r(e,h(e,n/e.blocksPerLine|0,n%e.blocksPerLine))}var L,x,T,A,U,I,q=a.length;I=u?0===s?0===c?function(e,r){var n=d(e.huffmanTableDC),o=0===n?0:C(n)<<l;e.blockData[r]=e.pred+=o}:function(e,r){e.blockData[r]|=m()<<l}:0===c?function(r,n){if(P>0)P--;else for(var o=s,a=i;o<=a;){var t=d(r.huffmanTableAC),c=15&t,f=t>>4;if(0!==c){var h=e[o+=f];r.blockData[n+h]=C(c)*(1<<l),o++}else{if(f<15){P=k(f)+(1<<f)-1;break}o+=16}}}:function(r,n){for(var o=s,a=i,t=0;o<=a;){var c=e[o];switch(g){case 0:var f=d(r.huffmanTableAC),h=15&f;if(t=f>>4,0===h)t<15?(P=k(t)+(1<<t),g=4):(t=16,g=1);else{if(1!==h)throw"invalid ACn encoding";w=C(h),g=t?2:3}continue;case 1:case 2:r.blockData[n+c]?r.blockData[n+c]+=m()<<l:0==--t&&(g=2==g?3:0);break;case 3:r.blockData[n+c]?r.blockData[n+c]+=m()<<l:(r.blockData[n+c]=w<<l,g=0);break;case 4:r.blockData[n+c]&&(r.blockData[n+c]+=m()<<l)}o++}4===g&&0==--P&&(g=0)}:function(r,n){var o=d(r.huffmanTableDC),a=0===o?0:C(o);r.blockData[n]=r.pred+=a;for(var t=1;t<64;){var s=d(r.huffmanTableAC),i=15&s,c=s>>4;if(0!==i){var l=e[t+=c];r.blockData[n+l]=C(i),t++}else{if(c<15)break;t+=16}}};var G,M,S,z,H=0;for(M=1==q?a[0].blocksPerLine*a[0].blocksPerColumn:f*o.mcusPerColumn,t||(t=M);H<M;){for(x=0;x<q;x++)a[x].pred=0;if(P=0,1==q)for(L=a[0],U=0;U<t;U++)D(L,I,H),H++;else for(U=0;U<t;U++){for(x=0;x<q;x++)for(S=(L=a[x]).h,z=L.v,T=0;T<z;T++)for(A=0;A<S;A++)y(L,I,H,T,A);H++}if(p=0,(G=r[n]<<8|r[n+1])<=65280)throw"marker was not found";if(!(G>=65488&&G<=65495))break;n+=2}return n-b}function b(e,l,f){var h,u,b,v,p,m,d,k,C,w,P=e.quantizationTable;for(w=0;w<64;w++)f[w]=e.blockData[l+w]*P[w];for(w=0;w<8;++w){var g=8*w;0!==f[1+g]||0!==f[2+g]||0!==f[3+g]||0!==f[4+g]||0!==f[5+g]||0!==f[6+g]||0!==f[7+g]?(h=i*f[0+g]+128>>8,u=i*f[4+g]+128>>8,b=f[2+g],v=f[6+g],p=c*(f[1+g]-f[7+g])+128>>8,k=c*(f[1+g]+f[7+g])+128>>8,m=f[3+g]<<4,d=f[5+g]<<4,C=h-u+1>>1,h=h+u+1>>1,u=C,C=b*s+v*t+128>>8,b=b*t-v*s+128>>8,v=C,C=p-d+1>>1,p=p+d+1>>1,d=C,C=k+m+1>>1,m=k-m+1>>1,k=C,C=h-v+1>>1,h=h+v+1>>1,v=C,C=u-b+1>>1,u=u+b+1>>1,b=C,C=p*a+k*o+2048>>12,p=p*o-k*a+2048>>12,k=C,C=m*n+d*r+2048>>12,m=m*r-d*n+2048>>12,d=C,f[0+g]=h+k,f[7+g]=h-k,f[1+g]=u+d,f[6+g]=u-d,f[2+g]=b+m,f[5+g]=b-m,f[3+g]=v+p,f[4+g]=v-p):(C=i*f[0+g]+512>>10,f[0+g]=C,f[1+g]=C,f[2+g]=C,f[3+g]=C,f[4+g]=C,f[5+g]=C,f[6+g]=C,f[7+g]=C)}for(w=0;w<8;++w){var y=w;0!==f[8+y]||0!==f[16+y]||0!==f[24+y]||0!==f[32+y]||0!==f[40+y]||0!==f[48+y]||0!==f[56+y]?(h=i*f[0+y]+2048>>12,u=i*f[32+y]+2048>>12,b=f[16+y],v=f[48+y],p=c*(f[8+y]-f[56+y])+2048>>12,k=c*(f[8+y]+f[56+y])+2048>>12,m=f[24+y],d=f[40+y],C=h-u+1>>1,h=h+u+1>>1,u=C,C=b*s+v*t+2048>>12,b=b*t-v*s+2048>>12,v=C,C=p-d+1>>1,p=p+d+1>>1,d=C,C=k+m+1>>1,m=k-m+1>>1,k=C,C=h-v+1>>1,h=h+v+1>>1,v=C,C=u-b+1>>1,u=u+b+1>>1,b=C,C=p*a+k*o+2048>>12,p=p*o-k*a+2048>>12,k=C,C=m*n+d*r+2048>>12,m=m*r-d*n+2048>>12,d=C,f[0+y]=h+k,f[56+y]=h-k,f[8+y]=u+d,f[48+y]=u-d,f[16+y]=b+m,f[40+y]=b-m,f[24+y]=v+p,f[32+y]=v-p):(C=i*f[w+0]+8192>>14,f[0+y]=C,f[8+y]=C,f[16+y]=C,f[24+y]=C,f[32+y]=C,f[40+y]=C,f[48+y]=C,f[56+y]=C)}for(w=0;w<64;++w){var D=l+w,L=f[w];L=L<=-2056/e.bitConversion?0:L>=2024/e.bitConversion?255/e.bitConversion:L+2056/e.bitConversion>>4,e.blockData[D]=L}}function v(e,r){for(var n=r.blocksPerLine,o=r.blocksPerColumn,a=new Int32Array(64),t=0;t<o;t++)for(var s=0;s<n;s++)b(r,h(r,t,s),a);return r.blockData}function p(e){return e<=0?0:e>=255?255:0|e}return l.prototype={load:function(e){var r=function(e){this.parse(e),this.onload&&this.onload()}.bind(this);if(e.indexOf("data:")>-1){for(var n=e.indexOf("base64,")+7,o=atob(e.substring(n)),a=new Uint8Array(o.length),t=o.length-1;t>=0;t--)a[t]=o.charCodeAt(t);r(o)}else{var s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.onload=function(){var e=new Uint8Array(s.response);r(e)}.bind(this),s.send(null)}},parse:function(r){function n(){var e=r[c]<<8|r[c+1];return c+=2,e}function o(e){for(var r=Math.ceil(e.samplesPerLine/8/e.maxH),n=Math.ceil(e.scanLines/8/e.maxV),o=0;o<e.components.length;o++){E=e.components[o];var a=Math.ceil(Math.ceil(e.samplesPerLine/8)*E.h/e.maxH),t=Math.ceil(Math.ceil(e.scanLines/8)*E.v/e.maxV),s=r*E.h,i=n*E.v*64*(s+1);E.blockData=new Int16Array(i),E.blocksPerLine=a,E.blocksPerColumn=t}e.mcusPerLine=r,e.mcusPerColumn=n}var a,t,s,i,c=0,l=(r.length,null),h=null,b=[],p=[],m=[],d=n();if(65496!=d)throw"SOI not found";for(d=n();65497!=d;){var k,C;switch(d){case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var w=(s=void 0,i=void 0,s=n(),i=r.subarray(c,c+s-2),c+=i.length,i);65504===d&&74===w[0]&&70===w[1]&&73===w[2]&&70===w[3]&&0===w[4]&&(l={version:{major:w[5],minor:w[6]},densityUnits:w[7],xDensity:w[8]<<8|w[9],yDensity:w[10]<<8|w[11],thumbWidth:w[12],thumbHeight:w[13],thumbData:w.subarray(14,14+3*w[12]*w[13])}),65518===d&&65===w[0]&&100===w[1]&&111===w[2]&&98===w[3]&&101===w[4]&&0===w[5]&&(h={version:w[6],flags0:w[7]<<8|w[8],flags1:w[9]<<8|w[10],transformCode:w[11]});break;case 65499:for(var P=n()+c-2;c<P;){var g=r[c++],y=new Int32Array(64);if(g>>4==0)for(k=0;k<64;k++)y[e[k]]=r[c++];else{if(g>>4!=1)throw"DQT: invalid table spec";for(k=0;k<64;k++)y[e[k]]=n()}b[15&g]=y}break;case 65472:case 65473:case 65474:if(a)throw"Only single frame JPEGs supported";n(),(a={}).extended=65473===d,a.progressive=65474===d,a.precision=r[c++],a.scanLines=n(),a.samplesPerLine=n(),a.components=[],a.componentIds={};var D,L=r[c++],x=0,T=0;for(j=0;j<L;j++){D=r[c];var A=r[c+1]>>4,U=15&r[c+1];x<A&&(x=A),T<U&&(T=U);var I=r[c+2];C=a.components.push({h:A,v:U,quantizationTable:b[I],quantizationTableId:I,bitConversion:255/((1<<a.precision)-1)}),a.componentIds[D]=C-1,c+=3}a.maxH=x,a.maxV=T,o(a);break;case 65476:var q=n();for(j=2;j<q;){var G=r[c++],M=new Uint8Array(16),S=0;for(k=0;k<16;k++,c++)S+=M[k]=r[c];var z=new Uint8Array(S);for(k=0;k<S;k++,c++)z[k]=r[c];j+=17+S,(G>>4==0?m:p)[15&G]=f(M,z)}break;case 65501:n(),t=n();break;case 65498:n();var H=r[c++],R=[];for(j=0;j<H;j++){var V=a.componentIds[r[c++]];E=a.components[V];var Y=r[c++];E.huffmanTableDC=m[Y>>4],E.huffmanTableAC=p[15&Y],R.push(E)}var B=r[c++],J=r[c++],O=r[c++],X=u(r,c,a,R,t,B,J,O>>4,15&O);c+=X;break;case 65535:255!==r[c]&&c--;break;default:if(255==r[c-3]&&r[c-2]>=192&&r[c-2]<=254){c-=3;break}throw"unknown JPEG marker "+d.toString(16)}d=n()}switch(this.width=a.samplesPerLine,this.height=a.scanLines,this.jfif=l,this.adobe=h,this.components=[],a.components.length){case 1:this.colorspace=ColorSpace.Grayscale;break;case 3:this.adobe?this.colorspace=ColorSpace.AdobeRGB:this.colorspace=ColorSpace.RGB;break;case 4:this.colorspace=ColorSpace.CYMK;break;default:this.colorspace=ColorSpace.Unknown}for(var j=0;j<a.components.length;j++){var E;(E=a.components[j]).quantizationTable||null===E.quantizationTableId||(E.quantizationTable=b[E.quantizationTableId]),this.components.push({output:v(0,E),scaleX:E.h/a.maxH,scaleY:E.v/a.maxV,blocksPerLine:E.blocksPerLine,blocksPerColumn:E.blocksPerColumn,bitConversion:E.bitConversion})}},getData16:function(e,r){if(1!==this.components.length)throw"Unsupported color mode";var n,o,a,t,s,i,c=this.width/e,l=this.height/r,f=0,u=this.components.length,b=new Uint16Array(e*r*u),v=new Uint16Array((this.components[0].blocksPerLine<<3)*this.components[0].blocksPerColumn*8);for(i=0;i<u;i++){for(var p,m,d,k=(n=this.components[i]).blocksPerLine,C=n.blocksPerColumn,w=k<<3,P=0,g=0;g<C;g++)for(var y=g<<3,D=0;D<k;D++){var L=h(n,g,D),x=(f=0,D<<3);for(p=0;p<8;p++)for(P=(y+p)*w,m=0;m<8;m++)v[P+x+m]=n.output[L+f++]}for(o=n.scaleX*c,a=n.scaleY*l,f=i,s=0;s<r;s++)for(t=0;t<e;t++)d=(0|s*a)*w+(0|t*o),b[f]=v[d],f+=u}return b},getData:function(e,r){var n,o,a,t,s,i,c,l,f,u,b,v,m,d,k,C=this.width/e,w=this.height/r,P=0,g=this.components.length,y=e*r*g,D=new Uint8Array(y),L=new Uint8Array((this.components[0].blocksPerLine<<3)*this.components[0].blocksPerColumn*8);for(i=0;i<g;i++){for(var x,T,A,U=(n=this.components[i]).blocksPerLine,I=n.blocksPerColumn,q=U<<3,G=0,M=0;M<I;M++)for(var S=M<<3,z=0;z<U;z++){var H=h(n,M,z),R=(P=0,z<<3);for(x=0;x<8;x++)for(G=(S+x)*q,T=0;T<8;T++)L[G+R+T]=n.output[H+P++]*n.bitConversion}for(o=n.scaleX*C,a=n.scaleY*w,P=i,s=0;s<r;s++)for(t=0;t<e;t++)A=(0|s*a)*q+(0|t*o),D[P]=L[A],P+=g}switch(g){case 1:case 2:break;case 3:if(k=!0,this.adobe&&this.adobe.transformCode?k=!0:void 0!==this.colorTransform&&(k=!!this.colorTransform),k)for(i=0;i<y;i+=g)c=D[i],l=D[i+1],v=p(c-179.456+1.402*(f=D[i+2])),m=p(c+135.459-.344*l-.714*f),d=p(c-226.816+1.772*l),D[i]=v,D[i+1]=m,D[i+2]=d;break;case 4:if(!this.adobe)throw"Unsupported color mode (4 components)";if(k=!1,this.adobe&&this.adobe.transformCode?k=!0:void 0!==this.colorTransform&&(k=!!this.colorTransform),k)for(i=0;i<y;i+=g)c=D[i],l=D[i+1],u=p(434.456-c-1.402*(f=D[i+2])),b=p(119.541-c+.344*l+.714*f),c=p(481.816-c-1.772*l),D[i]=u,D[i+1]=b,D[i+2]=c;break;default:throw"Unsupported color mode"}return D}},l}();export default JpegImage;