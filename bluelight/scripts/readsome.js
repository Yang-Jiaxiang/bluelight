function readXML(e){var t=new XMLHttpRequest;try{t.open("get",e,!0)}catch(e){}t.responseType="xml",t.onreadystatechange=function(e){try{var a=(new DOMParser).parseFromString(t.response,"text/xml"),n=a.getElementsByTagName("ImageAnnotationCollection")[0].getElementsByTagName("imageAnnotations")[0].getElementsByTagName("imageReferenceEntityCollection")[0].getElementsByTagName("ImageReferenceEntity")[0].getElementsByTagName("imageStudy")[0],s=n.getElementsByTagName("instanceUid")[0].getAttribute("root"),r=n.getElementsByTagName("imageSeries")[0].getElementsByTagName("instanceUid")[0].getAttribute("root"),i=n.getElementsByTagName("imageSeries")[0].getElementsByTagName("imageCollection")[0].getElementsByTagName("Image")[0].getElementsByTagName("sopInstanceUid")[0].getAttribute("root"),m=a.getElementsByTagName("ImageAnnotationCollection")[0].getElementsByTagName("imageAnnotations")[0].getElementsByTagName("ImageAnnotation")[0].getElementsByTagName("markupEntityCollection")[0].getElementsByTagName("MarkupEntity"),o={};o.study=s,o.series=r,o.sop=i,o.mark=[],o.showName="AIM",o.hideName=o.showName;try{for(var l=a.getElementsByTagName("ImageAnnotationCollection")[0].getElementsByTagName("imageAnnotations")[0].getElementsByTagName("ImageAnnotation")[0].getElementsByTagName("imagingObservationEntityCollection")[0].getElementsByTagName("ImagingObservationEntity"),g=0;g<l.length;g++){o.mark.push({}),(x=o.mark[o.mark.length-1]).type="Characteristic";var d=l[g].getElementsByTagName("imagingObservationCharacteristicCollection")[0].getElementsByTagName("ImagingObservationCharacteristic");x.markTitle="",x.markTitle=l[g].getElementsByTagName("label")[0].getAttribute("value")+":"+l[g].getElementsByTagName("typeCode")[0].getElementsByTagName("iso:displayName")[0].getAttribute("value"),x.markX=[],x.markY=[],x.markZ=[];for(var p=0;p<d.length;p++)x.markX.push(d[p].getElementsByTagName("label")[0].getAttribute("value")),x.markZ.push(d[p].getElementsByTagName("typeCode")[0].getAttribute("code")),x.markY.push(d[p].getElementsByTagName("typeCode")[0].getElementsByTagName("iso:displayName")[0].getAttribute("value"))}}catch(e){}for(g=0;g<m.length;g++)if("TwoDimensionPolyline"==m[g].getAttribute("xsi:type"))for(o.mark.push({}),(x=o.mark[o.mark.length-1]).type="TwoDimensionPolyline",d=m[g].getElementsByTagName("twoDimensionSpatialCoordinateCollection")[0].getElementsByTagName("TwoDimensionSpatialCoordinate"),x.markX=[],x.markY=[],p=0;p<d.length;p++)x.markX.push(d[p].getElementsByTagName("x")[0].getAttribute("value")),x.markY.push(d[p].getElementsByTagName("y")[0].getAttribute("value"));else if("TwoDimensionMultiPoint"==m[g].getAttribute("xsi:type"))for(o.mark.push({}),(x=o.mark[o.mark.length-1]).type="TwoDimensionMultiPoint",d=m[g].getElementsByTagName("twoDimensionSpatialCoordinateCollection")[0].getElementsByTagName("TwoDimensionSpatialCoordinate"),x.markX=[],x.markY=[],p=0;p<d.length;p++)x.markX.push(d[p].getElementsByTagName("x")[0].getAttribute("value")),x.markY.push(d[p].getElementsByTagName("y")[0].getAttribute("value"));else if("TwoDimensionEllipse"==m[g].getAttribute("xsi:type"))for(o.mark.push({}),(x=o.mark[o.mark.length-1]).type="TwoDimensionEllipse",d=m[g].getElementsByTagName("twoDimensionSpatialCoordinateCollection")[0].getElementsByTagName("TwoDimensionSpatialCoordinate"),x.markX=[],x.markY=[],p=0;p<d.length;p++)x.markX.push(d[p].getElementsByTagName("x")[0].getAttribute("value")),x.markY.push(d[p].getElementsByTagName("y")[0].getAttribute("value"));else if("TextAnnotationEntity"==m[g].getAttribute("xsi:type")){var x;for(o.mark.push({}),(x=o.mark[o.mark.length-1]).type="TextAnnotationEntity",d=m[g].getElementsByTagName("twoDimensionSpatialCoordinateCollection")[0].getElementsByTagName("TwoDimensionSpatialCoordinate"),x.markX=[],x.markY=[],p=0;p<d.length;p++)x.markX.push(d[p].getElementsByTagName("x")[0].getAttribute("value")),x.markY.push(d[p].getElementsByTagName("y")[0].getAttribute("value"))}PatientMark.push(o),refreshMark(o)}catch(e){}},t.send()}function readDicomOverlay(e,t,a){for(var n=0;n<=28;n+=2){var s=""+n;if(n<10&&(s="0"+n),t.elements["x600"+n+"3000"])try{var r=new Uint8ClampedArray(t.byteArray.buffer,t.elements["x60"+s+"3000"].dataOffset,t.elements["x60"+s+"3000"].length),i=new Uint8ClampedArray(8*r.length),m=0,o=0;for(var l of r)o=l,1==parseInt(o%2)?i[m+0]=1:i[8*l+0]=0,o/=2,1==parseInt(o%2)?i[m+1]=1:i[8*l+1]=0,o/=2,1==parseInt(o%2)?i[m+2]=1:i[8*l+2]=0,o/=2,1==parseInt(o%2)?i[m+3]=1:i[8*l+3]=0,o/=2,1==parseInt(o%2)?i[m+4]=1:i[8*l+4]=0,o/=2,1==parseInt(o%2)?i[m+5]=1:i[8*l+5]=0,o/=2,1==parseInt(o%2)?i[m+6]=1:i[8*l+6]=0,o/=2,1==parseInt(o%2)?i[m+7]=1:i[8*l+7]=0,m+=8;var g={};g.study=t.string("x0020000d"),g.series=t.string("x0020000e"),g.sop=t.string("x00080018"),g.height=t.uint16("x600"+n+"0010"),g.width=t.uint16("x600"+n+"0011"),g.mark=[],g.showName="Overlay",g.hideName=g.showName+"x60"+s+"1500",t.string("x60"+s+"1500")&&(g.showName=t.string("x60"+s+"1500")),g.mark.push({});var d=g.mark[g.mark.length-1];d.type="Overlay",d.pixelData=i.slice(0),d.canvas=document.createElement("CANVAS"),d.canvas.width=g.width,d.canvas.height=g.height,d.ctx=d.canvas.getContext("2d"),r=d.ctx.getImageData(0,0,g.width,g.height);for(var p=0,x=0;p<r.data.length;p+=4,x++)1==d.pixelData[x]&&(r.data[p]=0,r.data[p+1]=0,r.data[p+2]=255,r.data[p+3]=255);d.ctx.putImageData(r,0,0),a.push(g),refreshMark(g)}catch(e){console.log(e)}}}function readDicomRTSS(e,t,a){if(t.string("x30060039"))for(var n in t.elements.x30060039.items){var s,r=(""+t.elements.x30060039.items[n].dataSet.string("x3006002a")).split("\\");if(r&&(s="rgb("+parseInt(r[0])+", "+parseInt(r[1])+", "+parseInt(r[2])+")"),Object.prototype.hasOwnProperty.call(t.elements.x30060039.items[n].dataSet.elements,"x30060040"))for(var i in t.elements.x30060039.items[n].dataSet.elements.x30060040.items)for(var m in t.elements.x30060039.items[n].dataSet.elements.x30060040.items[i].dataSet.elements.x30060016.items){var o={};o.study=t.string("x0020000d"),o.series=t.string("x0020000e");try{o.series=t.elements.x30060010.items[0].dataSet.elements.x30060012.items[0].dataSet.elements.x30060014.items[0].dataSet.string("x0020000e")}catch(e){}o.color=s,o.mark=[];var l=getROINameList(e,t)[n];l&&(o.showName=l),o.hideName=o.showName,o.mark.push({}),o.sop=t.elements.x30060039.items[n].dataSet.elements.x30060040.items[i].dataSet.elements.x30060016.items[m].dataSet.string("x00081155");var g=o.mark[o.mark.length-1];g.type="RTSS",g.markX=[],g.markY=[],g.point=[];for(var d=(""+t.elements.x30060039.items[n].dataSet.elements.x30060040.items[i].dataSet.string("x30060050")).split("\\"),p=0;p<d.length;p+=3)g.markX.push(parseFloat(d[p])),g.markY.push(parseFloat(d[p+1])),g.point.push([parseFloat(d[p]),parseFloat(d[p+1])]),o.imagePositionZ=parseFloat(d[p+2]);a.push(o),refreshMark(o)}}}function getROINameList(e,t){var a=[];if(t.string("x30060020"))for(var n in t.elements.x30060020.items)t.elements.x30060020.items[n].dataSet.string("x30060026")&&a.push(""+t.elements.x30060020.items[n].dataSet.string("x30060026"));return a}function readDicom(e,t,a){var n=new XMLHttpRequest;try{n.open("get",e,!0);for(var s=ConfigLog.WADO.token,r=0;r<Object.keys(s).length;r++)""!=s[Object.keys(s)[r]]&&n.setRequestHeader(""+Object.keys(s)[r],""+s[Object.keys(s)[r]])}catch(e){}n.responseType="arraybuffer",n.onreadystatechange=function(e){if(4==n.readyState&&200==n.status){var a,s=new Uint8Array(n.response),r=dicomParser.parseDicom(s);if(readDicomOverlay(s,r,t),r.string("x00700001")&&r.string("x00081115"))for(var i in r.elements.x00081115.items)for(var m=r.elements.x00081115.items[i].dataSet.elements.x00081140.items,o=0;o<m.length;o++){a=m[o].dataSet.string("x00081155");var l="",g="";function d(e,n,s){if(""!=e){if(null!=s)var r=[s];else r=e;for(var i=0;i<r.length;i++){var m=r[i];if("POLYLINE"==e[m=null!=s?r[i]:i].dataSet.string("x00700023")||"INTERPOLATED"==e[m].dataSet.string("x00700023")){(f={}).sop=a,f.mark=[],f.mark.push({});var o=""+e[m].dataSet.string("x00700023");if(e[m].dataSet.elements.x00700232){var l=e[m].dataSet.elements.x00700232.items[0].dataSet;(c=ConvertGraphicColor(l.uint16("x00700251",0),l.uint16("x00700251",1),l.uint16("x00700251",2)))&&(f.color=c[0],o=c[1])}f.showName=o,""!=n&&null!=n&&(f.showName=n),f.hideName=f.showName,(k=f.mark[f.mark.length-1]).type=e[m].dataSet.string("x00700023"),k.markX=[],k.markY=[],k.point=[],k.RotationAngle=e[m].dataSet.double("x00710230"),k.GraphicFilled=e[m].dataSet.string("x00700024"),k.RotationPoint=[e[m].dataSet.float("x00710273",0),e[m].dataSet.float("x00710273",1)],""!=n&&null!=n&&(k.GSPS_Text=n);for(var g=e[m].dataSet.string("x00700022"),d=parseInt(e[m].dataSet.int16("x00700020"))*parseInt(e[m].dataSet.int16("x00700021")),p=0;p<d;p+=2){var x=(void 0,B=("("+(b="x00700022").substring(1,5)+","+b.substring(5,9)+")").toUpperCase(),TAG_DICT[B]),S=0,h=0;"US"==x.vr?(S=e[m].dataSet.uint16("x00700022",p),h=e[m].dataSet.uint16("x00700022",p+1)):"SS"===x.vr?(S=e[m].dataSet.int16("x00700022",p),h=e[m].dataSet.int16("x00700022",p+1)):"UL"===x.vr?(S=e[m].dataSet.uint32("x00700022",p),h=e[m].dataSet.uint32("x00700022",p+1)):"SL"===x.vr?(S=e[m].dataSet.int32("x00700022",p),h=e[m].dataSet.int32("x00700022",p+1)):"FD"===x.vr?(S=e[m].dataSet.double("x00700022",p),h=e[m].dataSet.double("x00700022",p+1)):(x.vr,S=e[m].dataSet.float("x00700022",p),h=e[m].dataSet.float("x00700022",p+1)),k.RotationAngle&&k.RotationPoint&&([S,h]=rotatePoint([S,h],-k.RotationAngle,k.RotationPoint)),k.markX.push(parseFloat(S)),k.markY.push(parseFloat(h)),k.point.push([parseFloat(S),parseFloat(h)])}t.push(f),refreshMark(f,!1)}if("CIRCLE"==e[m].dataSet.string("x00700023")){for((f={}).sop=a,f.mark=[],f.mark.push({}),o="CIRCLE",e[m].dataSet.elements.x00700232&&(l=e[m].dataSet.elements.x00700232.items[0].dataSet,(c=ConvertGraphicColor(l.uint16("x00700251",0),l.uint16("x00700251",1),l.uint16("x00700251",2)))&&(f.color=c[0],o=c[1])),f.showName=o,f.hideName=f.showName,(k=f.mark[f.mark.length-1]).type="CIRCLE",k.markX=[],k.markY=[],k.point=[],k.GraphicFilled=e[m].dataSet.string("x00700024"),g=e[m].dataSet.string("x00700022"),d=parseInt(e[m].dataSet.int16("x00700020"))*parseInt(e[m].dataSet.int16("x00700021")),p=0;p<d;p+=4){var u,y;S=0,h=0,S=e[m].dataSet.float("x00700022",p),h=e[m].dataSet.float("x00700022",p+1),u=e[m].dataSet.float("x00700022",p+2),y=e[m].dataSet.float("x00700022",p+3),k.markX.push(parseFloat(S)),k.markY.push(parseFloat(h)),k.point.push([parseFloat(S),parseFloat(h)]),k.markX.push(parseFloat(u)),k.markY.push(parseFloat(y)),k.point.push([parseFloat(u),parseFloat(y)])}t.push(f),refreshMark(f,!1)}if(e[m].dataSet.string("x00700015")&&"Y"==e[m].dataSet.string("x00700015")){var c;if((f={}).sop=a,f.mark=[],f.mark.push({}),o="Anchor",e[m].dataSet.elements.x00700232)l=e[m].dataSet.elements.x00700232.items[0].dataSet,(c=ConvertGraphicColor(l.uint16("x00700251",0),l.uint16("x00700251",1),l.uint16("x00700251",2)))&&(f.color=c[0],o=c[1]);f.showName=o,""!=n&&null!=n&&(f.showName=n),f.hideName=f.showName,(k=f.mark[f.mark.length-1]).type="POLYLINE",k.markX=[],k.markY=[],k.point=[],k.markX.push(e[m].dataSet.float("x00700010",0),e[m].dataSet.float("x00700011",0)),k.markY.push(e[m].dataSet.float("x00700010",1),e[m].dataSet.float("x00700011",1)),k.point.push([e[m].dataSet.float("x00700010",0),e[m].dataSet.float("x00700010",1)],[e[m].dataSet.float("x00700011",0),e[m].dataSet.float("x00700011",1)]),t.push(f),refreshMark(f,!1)}if(e[m].dataSet.string("x00700023")||""!=n||""==(n=e[m].dataSet.string("x00700006"))||((f={}).sop=a,f.mark=[],f.mark.push({}),o="TEXT",f.showName=o,f.hideName=f.showName,(k=f.mark[f.mark.length-1]).type="TEXT",k.markX=[],k.markY=[],k.point=[],""!=n&&null!=n&&(n=(""+n).replace("\r\n","\n"),k.GSPS_Text=n),k.markX.push(e[m].dataSet.float("x00700010",0)),k.markX.push(e[m].dataSet.float("x00700011",0)),k.markY.push(e[m].dataSet.float("x00700010",1)),k.markY.push(e[m].dataSet.float("x00700011",1)),k.point.push([e[m].dataSet.float("x00700010",0),e[m].dataSet.float("x00700010",1)]),k.point.push([e[m].dataSet.float("x00700011",0),e[m].dataSet.float("x00700011",1)]),t.push(f),refreshMark(f,!1)),"ELLIPSE"==e[m].dataSet.string("x00700023")){var f,k;(f={}).sop=a,f.mark=[],f.mark.push({}),o="ELLIPSE",f.showName=o,f.hideName=f.showName,(k=f.mark[f.mark.length-1]).type="ELLIPSE",k.markX=[],k.markY=[],k.point=[],k.GraphicFilled=e[m].dataSet.string("x00700024"),g=e[m].dataSet.string("x00700022");for(var v=!1,N=0;N<g.length;N+=4){var I=g[N].charCodeAt(0).toString(2)+"",E=g[N+1].charCodeAt(0).toString(2)+"",T=g[N+2].charCodeAt(0).toString(2)+"",A=g[N+3].charCodeAt(0).toString(2)+"",D=[parseInt(I,2),parseInt(E,2),parseInt(T,2),parseInt(A,2)],w=new ArrayBuffer(4),C=new DataView(w);D.forEach((function(e,t){C.setUint8(t,e,!0)}));var P=C.getFloat32(0,!0);0==v?k.markX.push(P):k.markY.push(P),v=!v}t.push(f),refreshMark(f,!1)}}var b,B}}try{for(var p in r.elements.x00700001.items)for(var x=0;x<r.elements.x00700001.items[p].dataSet.elements.x00081140.items.length;x++)if(r.elements.x00700001.items[p].dataSet.elements.x00081140.items[x].dataSet.string("x00081155")==a){l=r.elements.x00700001.items[p].dataSet.elements.x00700009.items;try{d(l,"",void 0)}catch(h){}try{for(var S=0;S<r.elements.x00700001.items[p].dataSet.elements.x00700008.items.length;S++)try{g=r.elements.x00700001.items[p].dataSet.elements.x00700008.items[S].dataSet.string("x00700006"),d(l=r.elements.x00700001.items[p].dataSet.elements.x00700008.items,"",S)}catch(u){}}catch(y){}}a&&refreshMarkFromSop(a)}catch(c){for(var p in r.elements.x00700001.items)try{d(l=r.elements.x00700001.items[p].dataSet.elements.x00700009.items,g)}catch(f){console.log(g);continue}a&&refreshMarkFromSop(a)}}readDicomRTSS(s,r,t)}},n.send()}function loadDicomSeg(e,t){var a=e.data,n=cornerstoneWADOImageLoader.getImageFrame(t),s=e.rows*e.columns;if(a.elements.x7fe00010.fragments){function r(t,r){try{for(var i=0;i<a.elements.x7fe00010.fragments.length;i++){var m=new Uint8Array(a.byteArray.buffer,a.elements.x7fe00010.fragments[i].position,a.elements.x7fe00010.fragments[i].length),o=decodeImageFrame(n,a.string("x00020010"),m,{usePDFJS:!1}).pixelData,l={};l.study=e.data.string("x0020000d"),l.series=e.data.elements.x00081115.items[0].dataSet.string("x0020000e");try{l.sop=t.items[i].dataSet.elements.x00089124.items[0].dataSet.elements.x00082112.items[0].dataSet.string("x00081155")}catch(e){l.sop=r.items[i].dataSet.elements.x00089124.items[0].dataSet.elements.x00082112.items[0].dataSet.string("x00081155")}try{l.ImagePositionPatient=t.items[i].dataSet.elements.x00209113.items[0].dataSet.string("x00200032")}catch(e){l.ImagePositionPatient=r.items[i].dataSet.elements.x00209113.items[0].dataSet.string("x00200032")}l.mark=[],l.showName="SEG",l.hideName=l.showName,l.mark.push({});var g=l.mark[l.mark.length-1];g.type="SEG",g.pixelData=new Uint8ClampedArray(s);for(var d=0;d<s;d++)g.pixelData[d]=o[d];g.canvas=document.createElement("CANVAS"),g.canvas.width=e.columns,g.canvas.height=e.rows,g.ctx=g.canvas.getContext("2d");for(var p=g.ctx.getImageData(0,0,e.columns,e.rows),x=(i=0,0);i<p.data.length;i+=4,x++)0!=g.pixelData[x]&&(p.data[i]=0,p.data[i+1]=0,p.data[i+2]=255,p.data[i+3]=255);g.ctx.putImageData(p,0,0),PatientMark.push(l),refreshMark(l)}}catch(e){}}r(e.data.elements.x52009230,e.data.elements.x52009229)}else{var i=new Uint8Array(a.byteArray.buffer,a.elements.x7fe00010.dataOffset,a.elements.x7fe00010.length);function r(t,a){try{for(var n=t.items.length,r=0;r<t.items.length;r++){var m={};m.study=e.data.string("x0020000d"),m.series=e.data.elements.x00081115.items[0].dataSet.string("x0020000e");try{m.sop=t.items[r].dataSet.elements.x00089124.items[0].dataSet.elements.x00082112.items[0].dataSet.string("x00081155")}catch(e){m.sop=a.items[0].dataSet.elements.x00089124.items[0].dataSet.elements.x00082112.items[r].dataSet.string("x00081155")}try{m.ImagePositionPatient=t.items[r].dataSet.elements.x00209113.items[0].dataSet.string("x00200032")}catch(e){m.ImagePositionPatient=a.items[r].dataSet.elements.x00209113.items[0].dataSet.string("x00200032")}m.mark=[],m.showName="SEG",m.hideName=m.showName,m.mark.push({});var o=m.mark[m.mark.length-1];if(o.type="SEG",o.pixelData=new Uint8ClampedArray(s),i.length==s*t.items.length)for(var l=0;l<s;l++)o.pixelData[l]=i[l+s*r];else for(l=0;l<s;l++)o.pixelData[l]=i[parseInt(l/(s/(i.length/n)))+i.length/n*r];o.canvas=document.createElement("CANVAS"),o.canvas.width=e.columns,o.canvas.height=e.rows,o.ctx=o.canvas.getContext("2d");for(var g=o.ctx.getImageData(0,0,e.columns,e.rows),d=0,p=0;d<g.data.length;d+=4,p++)0!=o.pixelData[p]&&(g.data[d]=0,g.data[d+1]=0,g.data[d+2]=255,g.data[d+3]=255);o.ctx.putImageData(g,0,0),PatientMark.push(m),refreshMark(m)}}catch(e){}}r(e.data.elements.x52009230,e.data.elements.x52009229)}}function loadUID(e){for(var t=e.study,a=e.series,n=e.sop,s=e.instance,r=e.imageId,i=e.patientId,m=e.image,o=e.pixelData,l=e.frames,g=e.pdf,d=0,p=-1,x=0;x<Patient.StudyAmount;x++)Patient.Study[x].StudyUID==t&&(p=x);if(-1==p){var S={};S.StudyUID=t,S.PatientId=i,S.SeriesAmount=1,S.Series=[],(u={}).SeriesUID=a,u.SopAmount=1,u.Sop=[],(y={}).InstanceNumber=s,y.SopUID=n,y.imageId=r,y.image=m,y.pixelData=o,y.pdf=g,y.frames=l,getPatientbyImageID[r]=y,u.Sop.push(y),u.Sop[y.SopUID]=y,S.Series.push(u),S.Series[u.SeriesUID]=u,Patient.Study.push(S),Patient.Study[S.StudyUID]=S,Patient.StudyAmount+=1}else{d=1;var h=-1;for(x=0;x<Patient.Study[p].SeriesAmount;x++)Patient.Study[p].Series[x].SeriesUID==a&&(h=x);if(-1==h){var u;(u={}).SeriesUID=a,u.SopAmount=1,u.Sop=[],(y={}).InstanceNumber=s,y.SopUID=n,y.imageId=r,y.image=m,y.pixelData=o,y.pdf=g,y.frames=l,getPatientbyImageID[r]=y,u.Sop.push(y),u.Sop[y.SopUID]=y,Patient.Study[p].Series.push(u),Patient.Study[p].Series[u.SeriesUID]=u,Patient.Study[p].SeriesAmount+=1}else{d=2;var y,c=-1;for(x=0;x<Patient.Study[p].Series[h].SopAmount;x++)Patient.Study[p].Series[h].Sop[x].SopUID==n&&(c=x);-1==c?((y={}).InstanceNumber=s,y.SopUID=n,y.imageId=r,y.image=m,y.pixelData=o,y.pdf=g,y.frames=l,Patient.Study[p].Series[h].Sop.push(y),Patient.Study[p].Series[h].Sop[y.SopUID]=y,Patient.Study[p].Series[h].SopAmount+=1,getPatientbyImageID[r]=y):d=-1}}return d}