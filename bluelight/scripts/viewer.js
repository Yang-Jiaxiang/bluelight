let VIEWPORT={};function displayImg2LefyCanvas(e,t,a){e.width=100,e.height=100,e.style.width="66px",e.style.height="66px";var i=e.getContext("2d");i.fillStyle="black",i.fillRect(0,0,100,100),i.fillStyle="gray",function(e,t,a,i,n,o=10){i<2*o&&(o=i/2),n<2*o&&(o=n/2),e.beginPath(),e.moveTo(t+o,a),e.arcTo(t+i,a,t+i,a+n,o),e.arcTo(t+i,a+n,t,a+n,o),e.arcTo(t,a+n,t,a,o),e.arcTo(t,a,t+i,a,o),e.closePath(),e.fill()}(i,10,10,80,80,10),i.beginPath(),i.fillStyle="white",i.font="32px serif",i.closePath(),i.fillText("PDF",20,59),i.closePath(),i.fill()}function displayLefyCanvas(e,t,a){e.width=t.width,e.height=t.height,e.style.width="66px",e.style.height="66px";var i=e.getContext("2d"),n=i.createImageData(t.width,t.height);if(null==t.data.elements.x00281050||null==t.data.elements.x00281051){var o=-99999999999,s=99999999999;if(null==t.MinPixel||null==t.MaxPixel){for(var r in a)a[r]>o&&(o=a[r]),a[r]<s&&(s=a[r]);t.MinPixel=s,t.MaxPixel=o}if((s=t.MinPixel)!=(o=t.MaxPixel)&&null!=s&&null!=o){if(1==t.color)for(r=n.data.length;r>=0;r-=4)n.data[r+0]=parseInt(a[r]/(o-s)*255),n.data[r+1]=parseInt(a[r+1]/(o-s)*255),n.data[r+2]=parseInt(a[r+2]/(o-s)*255),n.data[r+3]=255;else{r=n.data.length;for(var l=n.data.length/4;r>=0;r-=4,l--)n.data[r+0]=n.data[r+1]=n.data[r+2]=parseInt(a[l]/(o-s)*255),n.data[r+3]=255}i.putImageData(n,0,0)}}else{var d=t.windowCenter,g=t.windowWidth,p=d+g/2,m=d-g/2,c=t.intercept;CheckNull(c)&&(c=0);var u=t.slope;CheckNull(u)&&(u=1);var h=255/(p-m)*u,w=(-m+c)/(p-m)*255;if(1==t.color)for(r=n.data.length;r>=0;r-=4)n.data[r+0]=a[r]*h+w,n.data[r+1]=a[r+1]*h+w,n.data[r+2]=a[r+2]*h+w,n.data[r+3]=255;else for(r=n.data.length,l=n.data.length/4;r>=0;r-=4,l--)n.data[r+0]=n.data[r+1]=n.data[r+2]=a[l]*h+w,n.data[r+3]=255;i.putImageData(n,0,0)}var f=1==t.invert;1==f&&function(e,a,i=0,n=0,o=!1,s=!1){e.save(),e.setTransform(o?-1:1,0,0,s?-1:1,i+(o?t.width:0),n+(s?t.height:0)),1==f&&(e.filter="invert()"),e.drawImage(a,0,0),e.restore()}(i,e,0,0,GetViewport().openHorizontalFlip,GetViewport().openVerticalFlip)}function EnterRWD(){var e=1,t=getClass("page-header")[0].offsetWidth,a=!1;for(let i=0;i<getClass("page-header")[0].childNodes.length;i++)"IMG"==getClass("page-header")[0].childNodes[i].tagName&&e++,"輸出標記"!=getClass("page-header")[0].childNodes[i].alt&&"3dDisplay"!=getClass("page-header")[0].childNodes[i].alt&&"3dCave"!=getClass("page-header")[0].childNodes[i].alt&&"IMG"==getClass("page-header")[0].childNodes[i].tagName&&(e>=parseInt(t/document.querySelector(".img").offsetWidth)-2?(1==openRWD?getClass("page-header")[0].childNodes[i].style.display="none":getClass("page-header")[0].childNodes[i].style.display="",a=!0):getClass("page-header")[0].childNodes[i].style.display="");getByid("rwdImgTag").style.display=1==a?"":"none",SetTable()}function wadorsLoader(e,t){return function(){for(var a={"user-agent":"Mozilla/4.0 MDN Example","content-type":"multipart/related; type=application/dicom;"},i=ConfigLog.WADO.token,n=0;n<Object.keys(i).length;n++)""!=i[Object.keys(i)[n]]&&(a[Object.keys(i)[n]]=i[Object.keys(i)[n]]);fetch(e,{headers:a}).then((async function(e){let a=await e.arrayBuffer(),i=new Uint8Array(a);var n="";for(let e=0;e<i.length;e++)n+=String.fromCodePoint(i[e]);var o=await async function(e){let t=e,a=t.split("\r\n")[0],i=t.matchAll(new RegExp(a,"gi")),n=[],o=[];for(let e of i)n.push(e.index-2);n=n.slice(1);let s=t.split("\r\n"),r=[],l=[],d=[],g=[];for(let e in s){let t=s[e];if(t.includes("Content-Disposition")){d.push(t);let e=t.split("filename=");r.push(e[e.length-1].replace(/"/gm,""))}else t.includes("Content-Type")&&g.push(t)}d=_.uniq(d),g=_.uniq(g);let p=["Content-Type","Content-Length","MIME-Version"],m=[];for(let e of p){let a=t.matchAll(new RegExp(`${e}.*[\r\n|\r|\n]$`,"gim"));for(let e of a)m.push({index:e.index,length:e[0].length})}let c=_.maxBy(m,"index");o.push(c.index+c.length+3);for(let e in n){let a=t.substring(o[e],n[e]);l.push(a)}let u=function(e){for(var t=new ArrayBuffer(e.length),a=new Uint8Array(t),i=0,n=e.length;i<n;i++)a[i]=e.charCodeAt(i);return t}(l[0]);return document.createElement("a"),URL.createObjectURL(new Blob([u],{type:"application/dicom"}))}(n);1==t?onlyLoadImage("wadouri:"+o):loadAndViewImage("wadouri:"+o)})).catch((function(e){}))}()}function displayPDF(e){getClass("DicomCanvas")[viewportNumber].width=getClass("DicomCanvas")[viewportNumber].height=1,GetViewportMark(viewportNumber).width=GetViewportMark(viewportNumber).height=1;var t=GetViewport();for(var a in t.DicomTagsList)t[t.DicomTagsList[a][1]]=void 0;t.imageWidth=t.imageHeight=t.windowCenterList=t.windowWidthList=t.newMousePointX=t.newMousePointY=t.rotateValue=t.NowCanvasSizeWidth=t.NowCanvasSizeHeight=t.windowCenter=t.windowWidth=t.sop=void 0,VIEWPORT.delPDFView(t);var i=document.createElement("iframe");i.className="PDFView",i.id="PDFView_"+viewportNumber,i.src=e,i.style.width=i.style.height="100%",i.style.left="0px",i.style.position="absolute",t.appendChild(i),t.PDFView=i,getClass("labelWC")[viewportNumber].style.display="none",getClass("labelLT")[viewportNumber].style.display="none",getClass("labelRT")[viewportNumber].style.display="none",getClass("labelRB")[viewportNumber].style.display="none",getClass("labelWC")[viewportNumber].style.display="none",getClass("labelXY")[viewportNumber].style.display="none",getClass("leftRule")[viewportNumber].style.display="none",getClass("downRule")[viewportNumber].style.display="none"}function parseDicomWithoutImage(e,t){if("1.2.840.10008.5.1.4.1.1.104.1"==e.string("x00020002")){var a=e.elements.x00420011,i=e.byteArray.slice(a.dataOffset,a.dataOffset+a.length),n=new Blob([i],{type:"application/pdf"}),o=URL.createObjectURL(n),s={study:e.string("x0020000d"),series:e.string("x0020000e"),sop:e.string("x00080018"),instance:e.string("x00200013"),imageId:t,image:null,pdf:o,pixelData:null,patientId:e.string("x00100020")};loadUID(s);var r=-1;for(var l in leftCanvasStudy)leftCanvasStudy[l]==e.string("x0020000e")&&(r=l);if(-1==r){var d=SetToLeft(e.string("x0020000e"),-1,"patientID:"+securePassword(0,99999,1));leftCanvasStudy.push(e.string("x0020000e"));var g=document.createElement("CANVAS");g.className="LeftCanvas",d.appendChild(g),displayImg2LefyCanvas(g)}else{for(var p,m=0;m<=dicomImageCount;m++)if(getByid("dicomDivListDIV"+m)&&getByid("dicomDivListDIV"+m).series==image.data.string("x0020000e")){p=m;break}null!=p&&SetToLeft(e.string("x0020000e"),p,"patientID:"+securePassword(0,99999,1))}dicomImageCount+=1,displayPDF(o)}}function loadDicomMultiFrame(e,t,a){var i=e.data,n=(e.width,e.height,e.data.int16("x00280100"));if(!(16==n?new Int16Array(i.byteArray.buffer,i.elements.x7fe00010.dataOffset,i.elements.x7fe00010.length/2):32==n?new Int32Array(i.byteArray.buffer,i.elements.x7fe00010.dataOffset,i.elements.x7fe00010.length/4):8==n?new Int8Array(i.byteArray.buffer,i.elements.x7fe00010.dataOffset,i.elements.x7fe00010.length/1):new Int16Array(i.byteArray.buffer,i.elements.x7fe00010.dataOffset,i.elements.x7fe00010.length/2)))return;let o=[],s=e.data.intString("x00280008");for(let e=0;e<s;e++){let a=`${t}?frame=${e}`;cornerstone.loadImage(a).then((e=>{o.push(e.getPixelData())}))}let r=setInterval((()=>{if(o.length===s){let i={study:e.data.string("x0020000d"),series:e.data.string("x0020000e"),sop:e.data.string("x00080018"),instance:e.data.string("x00200013"),imageId:t,image:e,pixelData:o[0],frames:o,patientId:e.data.string("x00100020")};loadUID(i),parseDicom(e,i.frames[0],a),clearInterval(r)}}),200)}function parseDicom(e,t,a){var i;if(i=a>=0?a:viewportNumber,!VIEWPORT.lockViewportList||!VIEWPORT.lockViewportList.includes(i)){var n=GetViewport(i),o=GetViewportMark(i);if("1.2.840.10008.5.1.4.1.1.66.4"!=e.data.string("x00080016"))if("1.2.840.10008.5.1.4.1.1.104.1"!=e.data.string("x00020002")){var s=null==n.SeriesInstanceUID?"undefined":n.SeriesInstanceUID;if(function(a){a.width=e.width,a.height=e.height;var i=a.getContext("2d"),o=i.createImageData(e.width,e.height);if(n.SeriesInstanceUID&&n.SeriesInstanceUID!=e.data.string("x0020000e")&&(n.windowCenterList=n.windowWidthList=null),null==e.data.elements.x00281050||null==e.data.elements.x00281051){var s=-99999999999,r=99999999999;if(null==e.MinPixel||null==e.MaxPixel){for(var l in t)t[l]>s&&(s=t[l]),t[l]<r&&(r=t[l]);e.MinPixel=r,e.MaxPixel=s}if((r=e.MinPixel)!=(s=e.MaxPixel)&&null!=r&&null!=s){if(1==e.color)for(l=o.data.length;l>=0;l-=4)o.data[l+0]=parseInt(t[l]/(s-r)*255),o.data[l+1]=parseInt(t[l+1]/(s-r)*255),o.data[l+2]=parseInt(t[l+2]/(s-r)*255),o.data[l+3]=255;else{l=o.data.length;for(var d=o.data.length/4;l>=0;l-=4,d--)o.data[l+0]=o.data[l+1]=o.data[l+2]=parseInt(t[d]/(s-r)*255),o.data[l+3]=255}i.putImageData(o,0,0)}}else{var g=n.windowCenterList?n.windowCenterList:e.windowCenter,p=n.windowWidthList?n.windowWidthList:e.windowWidth,m=g+p/2,c=g-p/2,u=e.intercept;CheckNull(u)&&(u=0);var h=e.slope;CheckNull(h)&&(h=1);var w=255/(m-c)*h,f=(-c+u)/(m-c)*255;if(1==e.color)for(l=o.data.length;l>=0;l-=4)o.data[l+0]=t[l]*w+f,o.data[l+1]=t[l+1]*w+f,o.data[l+2]=t[l+2]*w+f,o.data[l+3]=255;else for(l=o.data.length,d=o.data.length/4;l>=0;l-=4,d--)o.data[l+0]=o.data[l+1]=o.data[l+2]=t[d]*w+f,o.data[l+3]=255;i.putImageData(o,0,0)}var v=1!=e.invert&&1==n.openInvert||1==e.invert&&0==n.openInvert;1!=v&&1!=n.openHorizontalFlip&&1!=n.openVerticalFlip||function(t,a,i=0,n=0,o=!1,s=!1){t.save(),t.setTransform(o?-1:1,0,0,s?-1:1,i+(o?e.width:0),n+(s?e.height:0)),1==v&&(t.filter="invert()"),t.drawImage(a,0,0),t.restore()}(i,a,0,0,n.openHorizontalFlip,n.openVerticalFlip)}(getClass("DicomCanvas")[i]),n.DicomTagsList)for(var r of n.DicomTagsList)n[r[1]]=void 0;for(el in n.DicomTagsList=[],n.imageId=e.imageId?e.imageId:"",e.data.elements)try{var l=("("+el.substring(1,5)+","+el.substring(5,9)+")").toUpperCase(),d=I(el);d.tag=""+el;var g=dicomParser.explicitElementToString(e.data,d);if(g)n.DicomTagsList.push([l,d.name,g]),n[d.name]=g;else{var p=(""+d.name).toLowerCase();e[p]?(n.DicomTagsList.push([l,d.name,e[p]]),n[d.name]=e[p]):"US"==d.vr?(n.DicomTagsList.push([l,d.name,e.data.uint16(el)]),n[d.name]=e.data.uint16(el)):"SS"===d.vr?(n.DicomTagsList.push([l,d.name,e.data.int16(el)]),n[d.name]=e.data.int16(el)):"UL"===d.vr?(n.DicomTagsList.push([l,d.name,e.data.uint32(el)]),n[d.name]=e.data.uint32(el)):"SL"===d.vr?(n.DicomTagsList.push([l,d.name,e.data.int32(el)]),n[d.name]=e.data.int32(el)):"FD"===d.vr?(n.DicomTagsList.push([l,d.name,e.data.double(el)]),n[d.name]=e.data.double(el)):"FL"===d.vr?(n.DicomTagsList.push([l,d.name,e.data.float(el)]),n[d.name]=e.data.float(el)):(n.DicomTagsList.push([l,d.name,""]),n[d.name]="")}}catch(e){}VIEWPORT.loadViewport(n,e,i),n.imageWidth=e.width,n.imageHeight=e.height,s==n.SeriesInstanceUID&&0!=n.windowWidthList&&0!=WindowOpen||(n.windowCenterList=e.windowCenter,n.windowWidthList=e.windowWidth),s!=n.SeriesInstanceUID?(n.newMousePointX=n.newMousePointY=n.rotateValue=0,s=n.SeriesInstanceUID,n.NowCanvasSizeWidth=n.NowCanvasSizeHeight=null):null==n.newMousePointX&&(n.newMousePointX=n.newMousePointY=0);var m=-1;for(var c in leftCanvasStudy)leftCanvasStudy[c]==e.data.string("x0020000e")&&(m=c);if(-1==m){var u=SetToLeft(e.data.string("x0020000e"),-1,e.data.string("x00100020"));leftCanvasStudy.push(e.data.string("x0020000e"));var h=document.createElement("CANVAS");h.className="LeftCanvas",u.appendChild(h),displayLefyCanvas(h,e,t)}else{for(var w,f=0;f<=dicomImageCount;f++)if(getByid("dicomDivListDIV"+f)&&getByid("dicomDivListDIV"+f).series==e.data.string("x0020000e")){w=f;break}null!=w&&SetToLeft(e.data.string("x0020000e"),w,e.data.string("x00100020"))}DisplaySeriesCount(i);var v=getStretchSize(n.imageWidth,n.imageHeight,n);n.style="position:block;left:100px;width:"+n.imageWidth+"px;height:"+n.imageHeight+"px;overflow:hidden;border:"+bordersize+"px #D3D9FF groove;",n.sop=n.SOPInstanceUID,n.windowCenter=e.windowCenter,n.windowWidth=e.windowWidth,textWC=getByid("textWC"),textWW=getByid("textWW"),labelWC=getClass("labelWC");var y=n.canvas();SetTable(),GetViewport().style.backgroundColor="rgb(10,6,6)",GetViewport().style.border=bordersize+"px #FFC3FF groove",v=getViewprtStretchSize(n.imageWidth,n.imageHeight,n),y.style="width:"+v[0]+"px;height:"+v[1]+"px;display:block;position:absolute;top:50%;left:50%",y.style.margin="-"+v[1]/2+"px 0 0 -"+v[0]/2+"px",o.width=y.width,o.height=y.height,o.getContext("2d").save(),Css(y,"zIndex","6"),o.style=y.style.cssText,Css(o,"zIndex","8"),Css(o,"pointerEvents","none"),a>=0||initNewCanvas(y),dicomImageCount+=1,a>=0?displayWindowLevel(i):displayWindowLevel(),isNaN(n.NowCanvasSizeHeight)||isNaN(n.NowCanvasSizeWidth)||(Css(y,"width",Fpx(n.NowCanvasSizeWidth)),Css(y,"height",Fpx(n.NowCanvasSizeHeight)),Css(o,"width",Fpx(n.NowCanvasSizeWidth)),Css(o,"height",Fpx(n.NowCanvasSizeHeight))),setTransform(i),0==openWindow&&0==openZoom&&(openMouseTool=!0),getByid("TableSelectNone").selected=!0,a>=0?displayMark(i):displayMark(),displayRuler(i),putLabel(),displayAIM(),displayAnnotation();for(var x=0;x<Viewport_Total;x++)displayRuler(x)}else parseDicomWithoutImage(e.data,e.imageId);else loadDicomSeg(e,e.imageId)}function I(e){var t=("("+e.substring(1,5)+","+e.substring(5,9)+")").toUpperCase();return TAG_DICT[t]}}function onlyLoadImage(e){if(!getPatientbyImageID[e])try{cornerstone.loadImage(e,{usePDFJS:!0}).then((function(t){if(t.data.intString("x00280008")>1)loadDicomMultiFrame(t,t.imageId,viewportNum0);else{var a={study:t.data.string("x0020000d"),series:t.data.string("x0020000e"),sop:t.data.string("x00080018"),instance:t.data.string("x00200013"),imageId:e,image:t,pixelData:t.getPixelData(),patientId:t.data.string("x00100020")};loadUID(a)}}),(function(t){t.dataSet&&parseDicomWithoutImage(t.dataSet,e)}))}catch(e){}}function loadAndViewImage(e,t,a){var i=t>=0?t:viewportNumber;GetViewport(i),GetViewportMark(i),labelLT=getClass("labelLT"),labelRT=getClass("labelRT"),labelRB=getClass("labelRB");var n=getPatientbyImageID[e];if(n)null!=a?(GetViewport(i).framesNumber=a,parseDicom(n.image,n.frames[a],t)):parseDicom(n.image,n.pixelData,t);else try{cornerstone.loadImage(e,{usePDFJS:!0}).then((function(a){if(a.data.intString("x00280008")>1)loadDicomMultiFrame(a,a.imageId,t);else{var i={study:a.data.string("x0020000d"),series:a.data.string("x0020000e"),sop:a.data.string("x00080018"),instance:a.data.string("x00200013"),imageId:e,image:a,pixelData:a.getPixelData(),patientId:a.data.string("x00100020")};loadUID(i),parseDicom(a,i.pixelData,t)}}),(function(t){t.dataSet&&parseDicomWithoutImage(t.dataSet,e)}))}catch(e){}}function initNewCanvas(e){e.getContext("2d");var t=viewportNumber+1;t>3&&(t=0);try{for(var a=0;a<Viewport_Total;a++)GetViewport(a).removeEventListener("contextmenu",contextmenuF,!1),GetViewport(a).removeEventListener("mousemove",Mousemove,!1),GetViewport(a).removeEventListener("mousedown",Mousedown,!1),GetViewport(a).removeEventListener("mouseup",Mouseup,!1),GetViewport(a).removeEventListener("mouseout",Mouseout,!1),GetViewport(a).removeEventListener("wheel",Wheel,!1),GetViewport(a).removeEventListener("mousedown",thisF,!1),GetViewport(a).removeEventListener("touchstart",touchstartF,!1),GetViewport(a).removeEventListener("touchend",touchendF,!1),GetViewport(a).addEventListener("touchstart",thisF,!1),GetViewport(a).addEventListener("mousedown",thisF,!1),GetViewport(a).addEventListener("wheel",Wheel,!1);GetViewport().removeEventListener("touchstart",thisF,!1),GetViewport().removeEventListener("mousedown",thisF,!1),GetViewport().addEventListener("contextmenu",contextmenuF,!1),GetViewport().addEventListener("mousemove",Mousemove,!1),GetViewport().addEventListener("mousedown",Mousedown,!1),GetViewport().addEventListener("mouseup",Mouseup,!1),GetViewport().addEventListener("mouseout",Mouseout,!1),GetViewport().addEventListener("touchstart",touchstartF,!1),GetViewport().addEventListener("touchmove",touchmoveF,!1),GetViewport().addEventListener("touchend",touchendF,!1)}catch(e){console.log(e)}}function DivDraw(e){if(0!=openZoom||0!=openMeasure||0!=MouseDownCheck||0!=openAngle){if(x_out=-parseInt(magnifierCanvas.style.width)/2,y_out=-parseInt(magnifierCanvas.style.height)/2,openAngle>=2?(getByid("AngleLabel").style.display="",AngleXY2[0]>AngleXY0[0]?x_out=20:x_out=-20,AngleXY2[1]>AngleXY0[1]?y_out=20:y_out=-20):getByid("AngleLabel").style.display="none",document.body.scrollTop&&0!=document.body.scrollTop?(dbst=document.body.scrollTop,dbsl=document.body.scrollLeft):(dbst=document.getElementsByTagName("html")[0].scrollTop,dbsl=document.getElementsByTagName("html")[0].scrollLeft),openZoom?dgs=document.getElementById("magnifierDiv").style:openMeasure?dgs=document.getElementById("MeasureLabel").style:dgs=document.getElementById("AngleLabel").style,y=e.clientY,x=e.clientX,y&&x||(y=e.touches[0].clientY,x=e.touches[0].clientX),1!=MouseDownCheck&&1!=TouchDownCheck&&2!=openAngle||(dgs.top=y+dbst+y_out+"px",dgs.left=x+dbsl+x_out+"px"),openMeasure);else if(2==openAngle){var t=(({x:e,y:t},{x:a,y:i})=>{const n=e*a+t*i,o=e*i-t*a;return(Math.atan2(o,n)/Math.PI*180+360)%360})({x:AngleXY0[0]-AngleXY2[0],y:AngleXY0[1]-AngleXY2[1]},{x:AngleXY0[0]-AngleXY1[0],y:AngleXY0[1]-AngleXY1[1]});t>180&&(t=360-t),getByid("AngleLabel").innerText=parseInt(t)+"°"}parseInt(getByid("MeasureLabel").innerText)<=1&&(getByid("MeasureLabel").style.display="none")}}function SetTable(e,t){let a=Viewport_row,i=Viewport_col;e&&t&&(a=e,i=t),VIEWPORT.fixRow&&(a=VIEWPORT.fixRow),VIEWPORT.fixCol&&(i=VIEWPORT.fixCol);try{for(var n=getViewportFixSize(window.innerWidth,window.innerHeight,a,i),o=0;o<Viewport_Total;o++)GetViewport(o).style="position:relative;float: left;left:100px;overflow:hidden;border:"+bordersize+"px #D3D9FF groove;margin:0px";for(var s=0;s<a;s++)for(var r=0;r<i;r++)GetViewport(s*i+r).style.width="calc("+parseInt(100/i)+"% - "+(parseInt(100/i)+2*bordersize)+"px)",GetViewport(s*i+r).style.height=n[1]-2*bordersize+"px"}catch(e){}for(o=a*i;o<Viewport_Total;o++)try{GetViewport(o).style="position:relative;float: right;;width:0px;height:0px;overflow:hidden;border:0px #D3D9FF groove;margin:0px"}catch(e){}}VIEWPORT.fixRow=null,VIEWPORT.fixCol=null,VIEWPORT.delPDFView=function(e){e&&e.PDFView&&(e.removeChild(e.PDFView),e.PDFView=void 0)},VIEWPORT.initPixelSpacing=function(e){e.PixelSpacing?(e.PixelSpacingX=1/parseFloat(e.PixelSpacing.split("\\")[0]),e.PixelSpacingY=1/parseFloat(e.PixelSpacing.split("\\")[1])):e.PixelSpacingX=e.PixelSpacingY=1},VIEWPORT.initImageOrientation=function(e){e.ImageOrientationPatient?(e.imageOrientationX=e.ImageOrientationPatient.split("\\")[0],e.imageOrientationY=e.ImageOrientationPatient.split("\\")[1],e.imageOrientationZ=e.ImageOrientationPatient.split("\\")[2],e.imageOrientationX2=e.ImageOrientationPatient.split("\\")[3],e.imageOrientationY2=e.ImageOrientationPatient.split("\\")[4],e.imageOrientationZ2=e.ImageOrientationPatient.split("\\")[5]):(e.imageOrientationX=e.imageOrientationY=e.imageOrientationZ=0,e.imageOrientationX2=e.imageOrientationY2=e.imageOrientationZ2=0)},VIEWPORT.initImagePosition=function(e){e.ImagePositionPatient?(e.imagePositionX=parseFloat(e.ImagePositionPatient.split("\\")[0]),e.imagePositionY=parseFloat(e.ImagePositionPatient.split("\\")[1]),e.imagePositionZ=parseFloat(e.ImagePositionPatient.split("\\")[2])):e.imagePositionX=e.imagePositionY=e.imagePositionZ=0},VIEWPORT.putLabel2Element=function(e,t,a){labelLT=getClass("labelLT"),labelRT=getClass("labelRT"),labelRB=getClass("labelRB");var i=e.StudyDate,n=e.StudyTime;function o(e){return e=Null2Empty(e),String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace("\r\n","<br/>").replace("\n","<br/>")}i=(i=(""+i).replace(/^(\d{4})(\d\d)(\d\d)$/,"$1/$2/$3"))+" "+(n=(""+n).replace(/^(\d{2})(\d\d)(\d\d)/,"$1:$2:$3")).substr(0,8),labelLT[a].innerHTML=labelRT[a].innerHTML="";for(var s=0;s<DicomTags.LT.name.length;s++)labelLT[a].innerHTML+=DicomTags.LT.name[s]+" "+o(t.data.string("x"+DicomTags.LT.tag[s]))+"<br/>";for(s=0;s<DicomTags.RT.name.length;s++)labelRT[a].innerHTML+=DicomTags.RT.name[s]+" "+o(t.data.string("x"+DicomTags.RT.tag[s]))+"<br/>"},VIEWPORT.loadViewport=function(e,t,a){for(var i=0;i<VIEWPORT.loadViewportList.length;i++)VIEWPORT[VIEWPORT.loadViewportList[i]](e,t,a)},VIEWPORT.loadViewportList=["initImagePosition","initPixelSpacing","initImageOrientation","putLabel2Element","delPDFView"],VIEWPORT.lockViewportList=[],window.onresize=function(){for(getByid("LeftPicture").style="display: flex;flex-direction: column;position: absolute;z-index: 9",parseInt(getByid("LeftPicture").offsetHeight)+10>=window.innerHeight-document.getElementsByClassName("container")[0].offsetTop-2*bordersize&&(getByid("LeftPicture").style="overflow-y: scroll;display: flex;flex-direction: column;position: absolute;z-index: 9;height:"+(window.innerHeight-document.getElementsByClassName("container")[0].offsetTop-2*bordersize)+"px;"),i=0;i<Viewport_Total;i++)try{var e=GetViewport(i).sop,t=SearchUid2Json(e);GetViewport().NowCanvasSizeWidth=GetViewport().NowCanvasSizeHeight=null,loadAndViewImage(Patient.Study[t.studyuid].Series[t.sreiesuid].Sop[t.sopuid].imageId,i)}catch(e){}try{for(var a=window.innerHeight;a>window.innerHeight-document.getElementsByClassName("container")[0].offsetTop-2*bordersize&&a>=10;)a-=5;getByid("cornerstonePenCanvas").getElementsByClassName("CornerstoneViewport")[0].getElementsByClassName("viewport-element")[0].getElementsByClassName("cornerstone-canvas")[0].style.height=a+"px"}catch(e){}EnterRWD()};