var WindowOpen=!1;function windowlevel(){"windowlevel"==BL_mode&&(DeleteMouseEvent(),getByid("textWC").style.display="",getByid("textWW").style.display="",getByid("WindowLevelDiv").style.display="",openWindow=!0,set_BL_model.onchange1=function(){openWindow=!1,getByid("WindowLevelDiv").style.display="none",set_BL_model.onchange1=function(){return 0}},SetTable(),Mousedown=function(e){1==e.which?MouseDownCheck=!0:3==e.which&&(rightMouseDown=!0),windowMouseX=GetmouseX(e),windowMouseY=GetmouseY(e),GetViewport().originalPointX=getCurrPoint(e)[0],GetViewport().originalPointY=getCurrPoint(e)[1]},Mousemove=function(e){var t=getCurrPoint(e)[0],i=getCurrPoint(e)[1],o=getClass("labelXY");{let t=rotateCalculation(e);o[viewportNumber].innerText="X: "+parseInt(t[0])+" Y: "+parseInt(t[1])}if(1==rightMouseDown&&scale_size(e,t,i),1==openLink)for(var n=0;n<Viewport_Total;n++)GetViewport(n).newMousePointX=GetViewport().newMousePointX,GetViewport(n).newMousePointY=GetViewport().newMousePointY;for(putLabel(),n=0;n<Viewport_Total;n++)displayRuler(n);if(MouseDownCheck){if(GetmouseX(e),GetmouseY(e),1==openWindow){if(getByid("WindowCustom").selected=!0,Math.abs(i-GetViewport().originalPointY)>Math.abs(t-GetViewport().originalPointX)?i<GetViewport().originalPointY-3?GetViewport().windowCenterList=parseInt(GetViewport().windowCenterList)+Math.abs(GetmouseY(e)-windowMouseY):i>GetViewport().originalPointY+3&&(GetViewport().windowCenterList=parseInt(GetViewport().windowCenterList)-Math.abs(GetmouseY(e)-windowMouseY)):t<GetViewport().originalPointX-3?GetViewport().windowWidthList=parseInt(GetViewport().windowWidthList)-Math.abs(GetmouseX(e)-windowMouseX):t>GetViewport().originalPointX+3&&(GetViewport().windowWidthList=parseInt(GetViewport().windowWidthList)+Math.abs(GetmouseX(e)-windowMouseX)),GetViewport().windowWidthList<1&&(GetViewport().windowWidthList=1),getByid("textWC").value=""+parseInt(GetViewport().windowCenterList),getByid("textWW").value=""+parseInt(GetViewport().windowWidthList),1==openLink)for(var r=0;r<4;r++)GetViewport(r).windowWidthList=GetViewport().windowWidthList;displayWindowLevel(),SetWindowWL(),WindowOpen=!0}windowMouseX=GetmouseX(e),windowMouseY=GetmouseY(e),GetViewport().originalPointX=t,GetViewport().originalPointY=i}},Mouseup=function(e){if(getCurrPoint(e)[0],getCurrPoint(e)[1],1==openMouseTool&&1==rightMouseDown&&displayMark(),MouseDownCheck=!1,rightMouseDown=!1,magnifierDiv.style.display="none",openLink)for(var t=0;t<Viewport_Total;t++)displayRuler(t)},Touchstart=function(e,t){t?rightTouchDown=!0:TouchDownCheck=!0,windowMouseX=GetmouseX(e),windowMouseY=GetmouseY(e),1==rightTouchDown&&t&&(windowMouseX2=GetmouseX(t),windowMouseY2=GetmouseY(t)),GetViewport().originalPointX=getCurrPoint(e)[0],GetViewport().originalPointY=getCurrPoint(e)[1],1==rightTouchDown&&t&&(GetViewport().originalPointX2=getCurrPoint(t)[0],GetViewport().originalPointY2=getCurrPoint(t)[1])},Touchmove=function(e,t){if(!openDisplayMarkup||!getByid("DICOMTagsSelect").selected&&!getByid("AIMSelect").selected){var i=getCurrPoint(e)[0],o=getCurrPoint(e)[1];if(t&&(getCurrPoint(t)[0],getCurrPoint(t)[1]),getClass("labelXY")[viewportNumber].innerText="X: "+Math.floor(i)+" Y: "+Math.floor(o),0==rightTouchDown){if(getByid("WindowCustom").selected=!0,Math.abs(o-GetViewport().originalPointY)>Math.abs(i-GetViewport().originalPointX)?o<GetViewport().originalPointY-3?GetViewport().windowCenterList=parseInt(GetViewport().windowCenterList)+Math.abs(GetmouseY(e)-windowMouseY):o>GetViewport().originalPointY+3&&(GetViewport().windowCenterList=parseInt(GetViewport().windowCenterList)-Math.abs(GetmouseY(e)-windowMouseY)):i<GetViewport().originalPointX-3?GetViewport().windowWidthList=parseInt(GetViewport().windowWidthList)-Math.abs(GetmouseX(e)-windowMouseX):i>GetViewport().originalPointX+3&&(GetViewport().windowWidthList=parseInt(GetViewport().windowWidthList)+Math.abs(GetmouseX(e)-windowMouseX)),GetViewport().windowWidthList<1&&(GetViewport().windowWidthList=1),getByid("textWC").value=""+parseInt(GetViewport().windowCenterList),getByid("textWW").value=""+parseInt(GetViewport().windowWidthList),1==openLink)for(var n=0;n<Viewport_Total;n++)windowWidthList[n]=GetViewport().windowWidthList;displayWindowLevel(),SetWindowWL(),GetViewport().originalPointX=i,GetViewport().originalPointY=o,WindowOpen=!0}}},Touchend=function(e,t){1==TouchDownCheck&&(1==openAngle?openAngle=2:2==openAngle&&(openAngle=3)),TouchDownCheck=!1,rightTouchDown=!1,magnifierDiv.style.display="none"},AddMouseEvent())}function parseDicomW(e,t,i,o){var n=o.windowcenter,r=o.windowwidth,w=(o.openOrigin,i>=0?i:viewportNumber),a=GetViewport(w);!function(i){i.width=e.width,i.height=e.height;var n=i.getContext("2d"),w=n.createImageData(e.width,e.height),s=o.windowcenter+r/2,d=o.windowcenter-r/2,p=e.intercept;CheckNull(p)&&(p=0);var l=e.slope;CheckNull(l)&&(l=1);var h=255/(s-d)*l,g=(-d+p)/(s-d)*255;if(1==e.color)for(var u=w.data.length;u>=0;u-=4)w.data[u+0]=t[u]*h+g,w.data[u+1]=t[u+1]*h+g,w.data[u+2]=t[u+2]*h+g,w.data[u+3]=255;else{u=w.data.length;for(var G=w.data.length/4;u>=0;u-=4,G--)w.data[u+0]=w.data[u+1]=w.data[u+2]=t[G]*h+g,w.data[u+3]=255}n.putImageData(w,0,0);var c=1!=e.invert&&1==a.openInvert||1==e.invert&&0==a.openInvert;1!=c&&1!=a.openHorizontalFlip&&1!=a.openVerticalFlip||function(t,i,o=0,n=0,r=!1,w=!1){t.save(),t.setTransform(r?-1:1,0,0,w?-1:1,o+(r?e.width:0),n+(w?e.height:0)),1==c&&(t.filter="invert()"),t.drawImage(i,0,0),t.restore()}(n,i,0,0,a.openHorizontalFlip,a.openVerticalFlip)}(getClass("DicomCanvas")[w]),a.imageWidth=e.width,a.imageHeight=e.height;var s=getViewprtStretchSize(a.imageWidth,a.imageHeight,a);a.style="position:block;left:100px;width:"+a.imageWidth+"px;height:"+a.imageHeight+"px;overflow:hidden;border:"+bordersize+"px #D3D9FF groove;",a.sop=a.SOPInstanceUID,a.windowWidthList=r,a.windowCenterList=n;var d=getFixSize(window.innerWidth,window.innerHeight,a);a.style="position:absolute;left:100px;width:calc(100% - "+(100+2*bordersize)+"px);height:"+d[1]+"px;overflow:hidden;border:"+bordersize+"px #D3D9FF groove;",a.sop=a.SOPInstanceUID,SetTable(),GetViewport().style.backgroundColor="rgb(10,6,6)",GetViewport().style.border=bordersize+"px #FFC3FF groove";var p=a.canvas(),l=GetViewportMark(w);if(p.style="width:"+s[0]+"px;height:"+s[1]+"px;display:block;position:absolute;top:50%;left:50%",p.style.margin="-"+s[1]/2+"px 0 0 -"+s[0]/2+"px",Css(p,"zIndex","6"),l.style=p.style.cssText,Css(l,"zIndex","8"),Css(l,"pointerEvents","none"),i>=0)for(var h=0;h<Viewport_Total;h++)displayWindowLevel(h);else displayWindowLevel();for(isNaN(a.NowCanvasSizeHeight)||isNaN(a.NowCanvasSizeWidth)||(Css(p,"width",Fpx(a.NowCanvasSizeWidth)),Css(p,"height",Fpx(a.NowCanvasSizeHeight)),Css(l,"width",Fpx(a.NowCanvasSizeWidth)),Css(l,"height",Fpx(a.NowCanvasSizeHeight))),setTransform(w),putLabel(),h=0;h<Viewport_Total;h++)displayRuler(h),displayMark(h);getByid("TableSelectNone").selected=!0}function loadAndViewImageByWindowLevwl(e,t,i,o,n){var r=getPatientbyImageID[e];WindowLevelObj={windowcenter:t,windowwidth:i,openOrigin:o},r&&parseDicomW(r.image,r.pixelData,n,WindowLevelObj)}