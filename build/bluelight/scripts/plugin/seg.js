var openWriteSEG=!1;function loadWriteSEG(){var e;(e=document.createElement("SPAN")).innerHTML='<img class="img SEG" alt="writeSEG" id="writeSEG" src="../image/icon/black/seg_off.png" width="50" height="50">',getByid("icon-list").appendChild(e),(e=document.createElement("SPAN")).innerHTML='<div id="SegStyleDiv" style="background-color:#30306044;">\n    <font color="white">ManufacturerModelName：</font><input type="text" id="SegManufacturerModelName"\n      value="ModelName" size="8" />\n    <font color="white">SeriesDescription：</font><input type="text" id="SegSeriesDescription" value="Research"\n      size="8" />\n    <font color="white">SegmentLabel</font><input type="text" id="SegSegmentLabel" value="SegmentLabel" size="8" />\n    <font color="white">Brush Size</font><input type="text" id="SegBrushSizeText" value="10" size="2" />\n    &nbsp;&nbsp;<button id="overlay2seg" sytle="">OverLay to Seg</button>\n  </div>',getByid("page-header").appendChild(e),getByid("SegStyleDiv").style.display="none"}loadWriteSEG(),getByid("overlay2seg").onclick=function(){getByid("overlay2seg").style.display="none";var e=GetViewport().sop;let n=SearchUid2Index(e);if(!n)return;let t=n[0],a=n[1];n[2];for(var i=0;i<PatientMark.length;i++)if(PatientMark[i].series==Patient.Study[t].Series[a].SeriesUID)for(var r=0;r<Patient.Study[t].Series[a].SopAmount;r++)for(var m=0;m<PatientMark[i].mark.length;m++)if("Overlay"==PatientMark[i].mark[m].type&&PatientMark[i].sop==Patient.Study[t].Series[a].Sop[r].SopUID){let e=GetNowUid();var l={};l.study=e.study,l.series=e.sreies,l.ImagePositionPatient=GetViewport().ImagePositionPatient,l.mark=[],l.showName="SEG",l.hideName=l.showName,l.mark.push({}),l.sop=Patient.Study[t].Series[a].Sop[r].SopUID;var _=l.mark.length-1;l.mark[_].type="SEG",l.mark[_].canvas=PatientMark[i].mark[m].canvas,PatientMark.push(l),refreshMark(l),SEG_now_choose=l.mark[_]}refreshMarkFromSop(GetNowUid().sop)},getByid("writeSEG").onclick=function(){0!=this.enable&&(cancelTools(),openWriteSEG=!openWriteSEG,img2darkByClass("SEG",!openWriteSEG),openLeftImgClick=!openWriteSEG,this.src=1==openWriteSEG?"../image/icon/black/seg_on.png":"../image/icon/black/seg_off.png",1==openWriteSEG?(getByid("overlay2seg").style.display="",getByid("SegStyleDiv").style.display="flex",set_BL_model("writeSeg"),openWheel=!0,writeSeg()):getByid("SegStyleDiv").style.display="none",displayMark(),1!=openWriteSEG&&(set_SEG_context(),1==ConfigLog.Xml2Dcm.enableXml2Dcm?function(e,n,t){document.createElement("a");let a=new File([e],n+".xml",{type:"text/plain"});var i=new XMLHttpRequest;i.open("POST",ConfigLog.Xml2Dcm.Xml2DcmUrl,!0),i.setRequestHeader("enctype","multipart/form-data");var r=new FormData;r.append("files",a),i.send(r),i.onload=function(){if(200==i.status){let e=JSON.parse(i.responseText);for(let n of e)window.open(n)}}}(String(get_SEG_context()),""+CreateSecurePassword()):function(e,n,t){let a=document.createElement("a"),i=new Blob([e],{type:"text/plain"});a.href=window.URL.createObjectURL(i),a.download="filename_SEG.xml",a.click()}(String(get_SEG_context())),getByid("MouseOperation").click()))};var SEG_format='<?xml version="1.0" encoding="UTF-8"?>\n    <file-format>\n        <meta-header xfer="1.2.840.10008.1.2.1" name="Little Endian Explicit">\n            <element tag="0002,0000" vr="UL" vm="1" len="___FileMetaInformationGroupLength(len)___" name="FileMetaInformationGroupLength">___FileMetaInformationGroupLength___</element>\n            <element tag="0002,0001" vr="OB" vm="1" len="2" name="FileMetaInformationVersion" binary="yes">00\\01</element>\n            <element tag="0002,0002" vr="UI" vm="1" len="28" name="MediaStorageSOPClassUID">1.2.840.10008.5.1.4.1.1.66.4</element>\n            <element tag="0002,0003" vr="UI" vm="1" len="___SOPInstanceUID(len)___" name="MediaStorageSOPInstanceUID">___SOPInstanceUID___</element>\n            <element tag="0002,0010" vr="UI" vm="1" len="20" name="TransferSyntaxUID">1.2.840.10008.1.2.1</element>\n            <element tag="0002,0012" vr="UI" vm="1" len="48" name="ImplementationClassUID">1.2.826.0.1.3680043.2.1143.107.104.103.115.3.0.1</element>\n            <element tag="0002,0013" vr="SH" vm="1" len="10" name="ImplementationVersionName">BlueLight</element>\n            <element tag="0002,0016" vr="AE" vm="1" len="8" name="SourceApplicationEntityTitle">gdcmconv</element>\n        </meta-header>\n        <data-set xfer="1.2.840.10008.1.2.1" name="Little Endian Explicit">\n            <element tag="0008,0008" vr="CS" vm="2" len="___ImageType(len)___" name="ImageType">___ImageType___</element>\n            <element tag="0008,0016" vr="UI" vm="1" len="28" name="SOPClassUID">1.2.840.10008.5.1.4.1.1.66.4</element>\n            <element tag="0008,0018" vr="UI" vm="1" len="___SOPInstanceUID(len)___" name="SOPInstanceUID">___SOPInstanceUID___</element>\n            <element tag="0008,0020" vr="DA" vm="1" len="8" name="StudyDate">___StudyDate___</element>\n            <element tag="0008,0021" vr="DA" vm="1" len="8" name="SeriesDate">___SeriesDate___</element>\n            <element tag="0008,0023" vr="DA" vm="1" len="8" name="ContentDate">___SeriesDate___</element>\n            <element tag="0008,0030" vr="TM" vm="1" len="10" name="StudyTime">___StudyTime___</element>\n            <element tag="0008,0031" vr="TM" vm="1" len="10" name="SeriesTime">___SeriesTime___</element>\n            <element tag="0008,0033" vr="TM" vm="1" len="10" name="ContentTime">___SeriesTime___</element>\n            <element tag="0008,0050" vr="SH" vm="1" len="___AccessionNumber(len)___" name="AccessionNumber">___AccessionNumber___</element>\n            <element tag="0008,0060" vr="CS" vm="1" len="4" name="Modality">SEG</element>\n            <element tag="0008,0070" vr="LO" vm="1" len="10" name="Manufacturer">bluelight</element>\n            <element tag="0008,0090" vr="PN" vm="1" len="___ReferringPhysicianName(len)___" name="ReferringPhysicianName">___ReferringPhysicianName___</element>\n            <element tag="0008,103e" vr="LO" vm="1" len="___SeriesDescription(len)___" name="SeriesDescription">___SeriesDescription___</element>\n            <element tag="0008,1090" vr="LO" vm="1" len="___ManufacturerModelName(len)___" name="ManufacturerModelName">___ManufacturerModelName___</element>\n            <sequence tag="0008,1115" vr="SQ" card="1" name="ReferencedSeriesSequence">\n                <item card="2">\n                    <sequence tag="0008,114a" vr="SQ" card="44" name="ReferencedInstanceSequence">\n___item2___\n                    </sequence>\n            <element tag="0020,000e" vr="UI" vm="1" len="___ReferencedSeriesInstanceUID(len)___" name="SeriesInstanceUID">___ReferencedSeriesInstanceUID___</element>\n                </item>\n            </sequence>\n            <element tag="0010,0010" vr="PN" vm="1" len="___PatientName(len)___" name="PatientName">___PatientName___</element>\n            <element tag="0010,0020" vr="LO" vm="1" len="___PatientID(len)___" name="PatientID">___PatientID___</element>\n            <element tag="0010,0030" vr="DA" vm="0" len="___PatientBirthDate(len)___" name="PatientBirthDate">___PatientBirthDate___</element>\n            <element tag="0010,0040" vr="CS" vm="0" len="___PatientSex(len)___" name="PatientSex">___PatientSex___</element>\n            <element tag="0010,1010" vr="AS" vm="0" len="___PatientAge(len)___" name="PatientAge">___PatientAge___</element>\n            <element tag="0018,1000" vr="LO" vm="1" len="4" name="DeviceSerialNumber">1799</element>\n            <element tag="0018,1020" vr="LO" vm="1" len="4" name="SoftwareVersions">1.0</element>\n            <element tag="0018,9004" vr="CS" vm="1" len="8" name="ContentQualification">RESEARCH</element> \n            <element tag="0020,000d" vr="UI" vm="1" len="___StudyInstanceUID(len)___" name="StudyInstanceUID">___StudyInstanceUID___</element>\n            <element tag="0020,000e" vr="UI" vm="1" len="___SeriesInstanceUID(len)___" name="SeriesInstanceUID">___SeriesInstanceUID___</element>\n            <element tag="0020,0010" vr="SH" vm="1" len="___StudyID(len)___" name="StudyID">___StudyID___</element>\n            <element tag="0020,0011" vr="IS" vm="1" len="___SeriesNumber(len)___" name="SeriesNumber">___SeriesNumber___</element>\n            <element tag="0020,0013" vr="IS" vm="1" len="0" name="InstanceNumber"></element>\n            <element tag="0020,0052" vr="UI" vm="1" len="___FrameOfReferenceUID(len)___" name="FrameOfReferenceUID">___FrameOfReferenceUID___</element>\n            <element tag="0020,1040" vr="LO" vm="0" len="0" name="PositionReferenceIndicator"></element>\n            <sequence tag="0020,9221" vr="SQ" card="1" name="DimensionOrganizationSequence">\n                <item card="1">\n                    <element tag="0020,9164" vr="UI" vm="1" len="44" name="DimensionOrganizationUID">2.25.521890920689168201386532254542531936629</element>\n                </item>\n            </sequence>\n            <sequence tag="0020,9222" vr="SQ" card="2" name="DimensionIndexSequence">\n                <item card="4">\n                    <element tag="0020,9164" vr="UI" vm="1" len="44" name="DimensionOrganizationUID">2.25.521890920689168201386532254542531936629</element>\n                    <element tag="0020,9165" vr="AT" vm="1" len="4" name="DimensionIndexPointer">(000b,0062)</element>\n                    <element tag="0020,9167" vr="AT" vm="1" len="4" name="FunctionalGroupPointer">(000a,0062)</element>\n                    <element tag="0020,9421" vr="LO" vm="1" len="24" name="DimensionDescriptionLabel">ReferencedSegmentNumber</element>\n                </item>\n                <item card="4">\n                    <element tag="0020,9164" vr="UI" vm="1" len="44" name="DimensionOrganizationUID">2.25.521890920689168201386532254542531936629</element>\n                    <element tag="0020,9165" vr="AT" vm="1" len="4" name="DimensionIndexPointer">(0032,0020)</element>\n                    <element tag="0020,9167" vr="AT" vm="1" len="4" name="FunctionalGroupPointer">(9113,0020)</element>\n                    <element tag="0020,9421" vr="LO" vm="1" len="20" name="DimensionDescriptionLabel">ImagePositionPatient</element>\n                </item>\n            </sequence>\n            <element tag="0028,0002" vr="US" vm="1" len="2" name="SamplesPerPixel">1</element> \n            <element tag="0028,0004" vr="CS" vm="1" len="___PhotometricInterpretation(len)___" name="PhotometricInterpretation">___PhotometricInterpretation___</element>\n            <element tag="0028,0008" vr="IS" vm="1" len="___NumberOfFrames(len)___" name="NumberOfFrames">___NumberOfFrames___</element> \n            <element tag="0028,0010" vr="US" vm="1" len="___Rows(len)___" name="Rows">___Rows___</element> \n            <element tag="0028,0011" vr="US" vm="1" len="___Columns(len)___" name="Columns">___Columns___</element>\n            <element tag="0028,0100" vr="US" vm="1" len="___BitsAllocated(len)___" name="BitsAllocated">___BitsAllocated___</element>\n            <element tag="0028,0101" vr="US" vm="1" len="___BitsStored(len)___" name="BitsStored">___BitsStored___</element>\n            <element tag="0028,0102" vr="US" vm="1" len="___HighBit(len)___" name="HighBit">___HighBit___</element>\n            <element tag="0028,0103" vr="US" vm="1" len="___PixelRepresentation(len)___" name="PixelRepresentation">___PixelRepresentation___</element> \n            <element tag="0062,0001" vr="CS" vm="1" len="10" name="SegmentationType">FRACTIONAL</element>\n            <sequence tag="0062,0002" vr="SQ" card="1" name="SegmentSequence">\n                <item card="7">\n                    <sequence tag="0062,0003" vr="SQ" card="1" name="SegmentedPropertyCategoryCodeSequence">\n                        <item card="3">\n                            <element tag="0008,0100" vr="SH" vm="1" len="8" name="CodeValue">T-D0050</element> \n                            <element tag="0008,0102" vr="SH" vm="1" len="4" name="CodingSchemeDesignator">SRT</element>\n                            <element tag="0008,0104" vr="LO" vm="1" len="6" name="CodeMeaning">Tissue</element>\n                        </item>\n                    </sequence>\n                    <element tag="0062,0004" vr="US" vm="1" len="___SegmentNumber(len)___" name="SegmentNumber">___SegmentNumber___</element>\n                    <element tag="0062,0005" vr="LO" vm="1" len="___SegmentLabel(len)___" name="SegmentLabel">___SegmentLabel___</element>\n                    <element tag="0062,0008" vr="CS" vm="1" len="14" name="SegmentAlgorithmType">SEMIAUTOMATIC</element>\n                    <element tag="0062,0009" vr="LO" vm="1" len="16" name="SegmentAlgorithmName">Slicer Prototype</element>\n                    <element tag="0062,000d" vr="US" vm="3" len="6" name="RecommendedDisplayCIELabValue">34885\\53485\\50171</element>\n                    <sequence tag="0062,000f" vr="SQ" card="1" name="SegmentedPropertyTypeCodeSequence">\n                        <item card="3">\n                            <element tag="0008,0100" vr="SH" vm="1" len="8" name="CodeValue">T-D0050</element>\n                            <element tag="0008,0102" vr="SH" vm="1" len="4" name="CodingSchemeDesignator">SRT</element>\n                            <element tag="0008,0104" vr="LO" vm="1" len="6" name="CodeMeaning">Tissue</element>\n                        </item>\n                    </sequence>\n                </item>\n            </sequence>\n        <element tag="0062,000e" vr="US" vm="1" len="2" name="MaximumFractionalValue">255</element>\n        <element tag="0062,0010" vr="CS" vm="1" len="12" name="SegmentationFractionalType">PROBABILITY</element>\n        <element tag="0070,0080" vr="CS" vm="1" len="12" name="ContentLabel">SEGMENTATION</element>\n        <element tag="0070,0081" vr="LO" vm="0" len="0" name="ContentDescription"></element>\n        <element tag="0070,0084" vr="PN" vm="0" len="0" name="ContentCreatorName"></element>\n        <sequence tag="5200,9229" vr="SQ" card="1" name="SharedFunctionalGroupsSequence">\n        <item card="2">\n            <sequence tag="0020,9116" vr="SQ" card="1" name="PlaneOrientationSequence">\n                <item card="1">\n                    <element tag="0020,0037" vr="DS" vm="6" len="12" name="ImageOrientationPatient">1\\0\\0\\0\\1\\0</element>\n                </item>\n            </sequence>\n            <sequence tag="0028,9110" vr="SQ" card="1" name="PixelMeasuresSequence">\n                <item card="3">\n                    <element tag="0018,0050" vr="DS" vm="1" len="___SliceThickness(len)___" name="SliceThickness">___SliceThickness___</element>\n                    <element tag="0018,0088" vr="DS" vm="1" len="___SpacingBetweenSlices(len)___" name="SpacingBetweenSlices">___SpacingBetweenSlices___</element>\n                    <element tag="0028,0030" vr="DS" vm="2" len="___PixelSpacing(len)___" name="PixelSpacing">___PixelSpacing___</element>\n                </item>\n            </sequence>\n        </item>\n    </sequence>\n    <sequence tag="5200,9230" vr="SQ" card="3" name="PerFrameFunctionalGroupsSequence">\n___item4___\n    </sequence>\n    <element tag="7fe0,0010" vr="OB" vm="1" len="___PixelData(len)___" name="PixelData" binary="yes">___PixelData___</element>\n    </data-set>\n    </file-format>\n    ',SEG_format_object_list=[],SEG_format_tail_2='\n                    <item card="2">\n                        <element tag="0008,1150" vr="UI" vm="1" len="26" name="ReferencedSOPClassUID">1.2.840.10008.5.1.4.1.1.2</element>\n                        <element tag="0008,1155" vr="UI" vm="1" len="___ReferencedSOPInstanceUID(len)___" name="ReferencedSOPInstanceUID">___ReferencedSOPInstanceUID___</element>\n                    </item>',SEG_format_tail_4='\n    <item card="4">\n    <sequence tag="0008,9124" vr="SQ" card="1" name="DerivationImageSequence">\n        <item card="2">\n            <sequence tag="0008,2112" vr="SQ" card="1" name="SourceImageSequence">\n                <item card="3">\n                    <element tag="0008,1150" vr="UI" vm="1" len="26" name="ReferencedSOPClassUID">1.2.840.10008.5.1.4.1.1.2</element>\n                    <element tag="0008,1155" vr="UI" vm="1" len="___ReferencedSOPInstanceUID(len)___" name="ReferencedSOPInstanceUID">___ReferencedSOPInstanceUID___</element>\n                    <sequence tag="0040,a170" vr="SQ" card="1" name="PurposeOfReferenceCodeSequence">\n                        <item card="3">\n                            <element tag="0008,0100" vr="SH" vm="1" len="6" name="CodeValue">121322</element>\n                            <element tag="0008,0102" vr="SH" vm="1" len="4" name="CodingSchemeDesignator">DCM</element>\n                            <element tag="0008,0104" vr="LO" vm="1" len="44" name="CodeMeaning">Source image for image processing operation</element>\n                        </item>\n                    </sequence>\n                </item>\n            </sequence>\n            <sequence tag="0008,9215" vr="SQ" card="1" name="DerivationCodeSequence">\n                <item card="3">\n                    <element tag="0008,0100" vr="SH" vm="1" len="6" name="CodeValue">113076</element>\n                    <element tag="0008,0102" vr="SH" vm="1" len="4" name="CodingSchemeDesignator">DCM</element>\n                    <element tag="0008,0104" vr="LO" vm="1" len="12" name="CodeMeaning">Segmentation</element>\n                </item>\n            </sequence>\n        </item>\n    </sequence>\n    <sequence tag="0020,9111" vr="SQ" card="1" name="FrameContentSequence">\n        <item card="1">\n            <element tag="0020,9157" vr="UL" vm="2" len="___DimensionIndexValues(len)___" name="DimensionIndexValues">___DimensionIndexValues___</element>\n        </item>\n    </sequence>\n    <sequence tag="0020,9113" vr="SQ" card="1" name="PlanePositionSequence">\n        <item card="1">\n            <element tag="0020,0032" vr="DS" vm="3" len="___ImagePositionPatient(len)___" name="ImagePositionPatient">___ImagePositionPatient___</element>\n        </item>\n    </sequence>\n    <sequence tag="0062,000a" vr="SQ" card="1" name="SegmentIdentificationSequence">\n        <item card="1">\n            <element tag="0062,000b" vr="US" vm="1" len="2" name="ReferencedSegmentNumber">1</element>\n        </item>\n    </sequence>\n    </item>',SEG_now_choose=null,temp_SEG_format="";function set_SEG_context(){SEG_format_object_list=[];let e="",n="",t="",a=SearchUid2Index(GetViewport().sop),i=a[0],r=a[1];function m(e,n,t,a){t=""+(t=Null2Empty(t)),e=e.replace("___"+n+"___",""+t);var i=(""+t).length;return i%2!=0&&i++,1==a&&(e=e.replace("___"+n+"(len)___",i)),e}function l(e,n){return n?e<10?"00"+e:e<100?"0"+e:""+e:(e<10?"0":"")+e}a[2],e=""+SEG_format;for(var _=getAllSop(),o=0;o<_.length;o++){let y=""+SEG_format_tail_2;y=m(y,"ReferencedSOPInstanceUID",_[o],!0),t+=y}for(var s=0,c=0;c<PatientMark.length;c++)for(var S=0;S<PatientMark[c].mark.length;S++)PatientMark[c].series==Patient.Study[i].Series[r].SeriesUID&&"SEG"==PatientMark[c].mark[S].type&&s++;if(0!=s){e=m(e,"NumberOfFrames",s,!0),e=m(e,"SegmentNumber",s,!0);var g="",v=0;for(c=0;c<PatientMark.length;c++){if(PatientMark[c].series==Patient.Study[i].Series[r].SeriesUID)for(S=0;S<PatientMark[c].mark.length;S++)if("SEG"==PatientMark[c].mark[S].type){v++;for(var u=""+SEG_format_tail_4,d=PatientMark[c].mark[S],p=0;p<d.pixelData.length;p+=1)g+=0==p&&1==v?"0"+d.pixelData[p]:"\\0"+d.pixelData[p];u=m(u,"ReferencedSOPInstanceUID",PatientMark[c].sop,!0),u=m(u,"ImagePositionPatient",""+PatientMark[c].ImagePositionPatient,!0),n+=u=m(u,"DimensionIndexValues","1\\"+v,!0)}for(var I=CreateUid("sop"),f=CreateUid("series"),P=0;P<5;P++){function D(e,n,t){for(var a=0;a<GetViewport().DicomTagsList.length;a++)if(GetViewport().DicomTagsList[a][1]==n){e=(""+e).replace("___"+n+"___",""+GetViewport().DicomTagsList[a][2]);var i=(""+GetViewport().DicomTagsList[a][2]).length;return i%2!=0&&i++,1==t&&(e=e.replace("___"+n+"(len)___",i)),e}return e}e=m(e,"StudyDate",GetViewport().StudyDate,!0),e=m(e,"StudyTime",GetViewport().StudyTime,!0),e=m(e,"StudyInstanceUID",Patient.Study[i].StudyUID,!0),e=m(e,"SeriesInstanceUID",f,!0),e=m(e,"SOPInstanceUID",I,!0),e=m(e,"PatientID",GetViewport().PatientID,!0),e=m(e,"PatientName",GetViewport().PatientName,!0),e=m(e,"ReferencedSOPInstanceUID",PatientMark[c].sop,!0),e=m(e,"ImageType",GetViewport().ImageType,!0),e=m(e,"ReferencedSeriesInstanceUID",Patient.Study[i].Series[r].SeriesUID,!0),e=m(e,"AccessionNumber",GetViewport().AccessionNumber,!0),e=m(e,"StudyID",GetViewport().StudyID,!0),e=m(e,"PatientSex",GetViewport().PatientSex,!0),e=m(e,"PatientBirthDate",GetViewport().PatientBirthDate,!0),e=m(e,"PatientAge",GetViewport().PatientAge,!0),e=m(e,"Manufacturer",GetViewport().Manufacture,!0),e=m(e,"PhotometricInterpretation",GetViewport().PhotometricInterpretation,!0),e=m(e,"ReferringPhysicianName",GetViewport().ReferringPhysicianName,!0),e=m(e,"SliceThickness",GetViewport().SliceThickness,!0),e=m(e,"SpacingBetweenSlices",GetViewport().SpacingBetweenSlices,!0),e=m(e,"SeriesDescription",getByid("SegSeriesDescription").value,!0),e=m(e,"SeriesNumber",GetViewport().SeriesNumber+"03",!0),e=m(e,"PixelSpacing",""+GetViewport().PixelSpacing,!0),e=m(e,"ImagePositionPatient",""+GetViewport().ImagePositionPatient,!0),e=m(e,"BitsAllocated","8",!0),e=m(e,"BitsStored","8",!0),e=m(e,"HighBit","7",!0),e=D(e,"SpacingBetweenSlices",!0),e=D(e,"SliceThickness",!0),e=D(e,"ImageType",!0),e=D(e,"PatientBirthDate",!0),e=D(e,"PatientSex",!0),e=D(e,"PatientAge",!0),e=D(e,"FrameOfReferenceUID",!0),e=D(e,"PhotometricInterpretation",!0),e=D(e,"Rows",!0),e=D(e,"Columns",!0),e=D(e,"PixelRepresentation",!0),e=D(e,"LossyImageCompression",!0),e=D(e,"PixelSpacing",!0),e=m(e,"ManufacturerModelName",getByid("SegManufacturerModelName").value,!0),e=m(e,"SegmentLabel",getByid("SegSegmentLabel").value,!0);var h=new Date;e=m(e,"SeriesDate",""+h.getFullYear()+l(h.getMonth()+1)+l(h.getDate()),!0),e=m(e,"SeriesTime",""+l(h.getHours()+1)+l(h.getMinutes())+l(h.getSeconds())+"."+l(h.getMilliseconds(),!0)),e=m(e,"FileMetaInformationGroupLength",""+(60+(116+I.length)),!0)}}e=m(e,"PixelData",""+g,!0),e=e.replace("___item4___",n),e=e.replace("___item2___",t),SEG_format_object_list.push(e)}}function get_SEG_context(){for(var e="",n=0;n<SEG_format_object_list.length;n++)e+=SEG_format_object_list[n];return e}function Line_setSEG2PixelData(e,n){if(e&&n){var t=Math.sqrt((e[0]-n[0])*(e[0]-n[0])+(e[1]-n[1])*(e[1]-n[1])),a=e[0]>n[0]?n[0]:e[0],i=e[1]>n[1]?n[1]:e[1],r=e[0]<n[0]?n[0]:e[0],m=e[1]<n[1]?n[1]:e[1];if(e[0]==a&&e[1]==i)for(var l=0;l<parseInt(t);l++)setSEG2PixelData([parseInt(a+(r-a)/t*l),parseInt(i+(m-i)/t*l)]);else if(e[0]==r&&e[1]==m)for(l=0;l<parseInt(t);l++)setSEG2PixelData([parseInt(r-(r-a)/t*l),parseInt(m-(m-i)/t*l)]);else if(e[0]==a&&e[1]==m)for(l=0;l<parseInt(t);l++)setSEG2PixelData([parseInt(a+(r-a)/t*l),parseInt(m-(m-i)/t*l)]);else if(e[0]==r&&e[1]==i)for(l=0;l<parseInt(t);l++)setSEG2PixelData([parseInt(r-(r-a)/t*l),parseInt(i+(m-i)/t*l)])}}function writeSeg(){var e;if("writeSeg"==BL_mode)return DeleteMouseEvent(),Mousedown=function(e){if(1==e.which?MouseDownCheck=!0:3==e.which&&(rightMouseDown=!0),windowMouseX=GetmouseX(e),windowMouseY=GetmouseY(e),GetViewport().originalPointX=getCurrPoint(e)[0],GetViewport().originalPointY=getCurrPoint(e)[1],1!=openWindow){var n=GetViewport().sop,t=SearchUid2Index(n);if(!t)return;let c=t[0],S=t[1],g=t[2];for(var a=!1,i=0;i<PatientMark.length;i++)if(PatientMark[i].sop==Patient.Study[c].Series[S].Sop[g].SopUID)for(var r=0;r<PatientMark[i].mark.length&&1!=a;r++)"SEG"==PatientMark[i].mark[r].type&&(SEG_now_choose=PatientMark[i].mark[r],a=!0);if(0==a){let n=GetNowUid();var m={};m.study=n.study,m.series=n.sreies,m.ImagePositionPatient=GetViewport().ImagePositionPatient,m.mark=[],m.showName="SEG",m.hideName=m.showName,m.mark.push({}),m.sop=n.sop;var l=m.mark.length-1;if(m.mark[l].type="SEG",m.mark[l].pixelData=new Uint8ClampedArray(GetViewport().imageWidth*GetViewport().imageHeight),!m.mark[l].canvas){m.mark[l].canvas=document.createElement("CANVAS"),m.mark[l].canvas.width=GetViewport().imageWidth,m.mark[l].canvas.height=GetViewport().imageHeight,m.mark[l].ctx=m.mark[l].canvas.getContext("2d");for(var _=m.mark[l].ctx.getImageData(0,0,m.mark[l].canvas.width,m.mark[l].canvas.height),o=0,s=0;o<_.data.length;o+=4,s++)0!=m.mark[l].pixelData[s]&&(_.data[o]=0,_.data[o+1]=0,_.data[o+2]=255,_.data[o+3]=255);m.mark[l].ctx.putImageData(_,0,0)}let t=rotateCalculation(e);PatientMark.push(m),refreshMark(m),SEG_now_choose=m.mark[l],setSEG2PixelData(t),refreshMark(m)}for(o=0;o<Viewport_Total;o++)displayMark(o)}},Mousemove=function(n){getCurrPoint(n)[0],getCurrPoint(n)[1];var t=getClass("labelXY");{let e=rotateCalculation(n);t[viewportNumber].innerText="X: "+parseInt(e[0])+" Y: "+parseInt(e[1])}if(MouseDownCheck&&!rightMouseDown&&SEG_now_choose&&1!=openWindow){let t=rotateCalculation(n);if(e&&(e[0]!=t[0]||e[1]!=t[1])){setSEG2PixelData(t),Line_setSEG2PixelData(e,t);let n=GetNowUid();refreshMark(n.sop);for(var a=0;a<Viewport_Total;a++)displayMark(a)}e=t}if(!rightMouseDown&&1!=openWindow){var i=getByid("SegBrushSizeText").value;i=parseInt(i),(isNaN(i)||i<1||i>1024)&&(i=getByid("SegBrushSizeText").value=10),refreshMarkFromSop(GetNowUid().sop);let e=rotateCalculation(n);var r=GetViewportMark().getContext("2d");r.beginPath(),r.strokeStyle="#FFFF00",r.lineWidth="3",r.arc(e[0],e[1],i,0,2*Math.PI),r.stroke(),r.closePath()}},Mouseup=function(n){if(e=void 0,getCurrPoint(n)[0],getCurrPoint(n)[1],1==openMouseTool&&1==rightMouseDown&&displayMark(),MouseDownCheck=!1,rightMouseDown=!1,magnifierDiv.style.display="none",openLink)for(var t=0;t<Viewport_Total;t++)displayRuler(t)},void AddMouseEvent()}function setSEG2PixelData(e){var n=getByid("SegBrushSizeText").value;n=parseInt(n),(isNaN(n)||n<1||n>1024)&&(n=getByid("SegBrushSizeText").value=10);var t=SEG_now_choose.ctx.getImageData(parseInt(e[0])-n,parseInt(e[1])-n,2*n,2*n),a=0;if(1==KeyCode_ctrl)for(var i=-n;i<n;i++)for(var r=-n;r<n;r++)i*i+r*r<n*n&&(SEG_now_choose.pixelData[Math.floor(e[1]+i)*GetViewport().imageWidth+Math.floor(e[0]+r)]=0,t.data[a]=0,t.data[a+1]=0,t.data[a+2]=0,t.data[a+3]=0),a+=4;else for(i=-n;i<n;i++)for(r=-n;r<n;r++)i*i+r*r<n*n&&(SEG_now_choose.pixelData[Math.floor(e[1]+i)*GetViewport().imageWidth+Math.floor(e[0]+r)]=1,t.data[a]=0,t.data[a+1]=0,t.data[a+2]=255,t.data[a+3]=255),a+=4;SEG_now_choose.ctx.putImageData(t,parseInt(e[0])-n,parseInt(e[1])-n)}