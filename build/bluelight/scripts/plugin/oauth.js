var OAuthConfig={},keycloakAPI="";async function auth(){if((OAuthConfig=await loadOAuthConfig("../data/configOAuth.json")).enabled){let e=getCookie("access_token"),o=new URL(window.location.href).searchParams,t=o.get("code"),n=o.get("session_state"),i=""!=OAuthConfig.port?`:${OAuthConfig.port}`:"";if(keycloakAPI=`${OAuthConfig.http}://${OAuthConfig.hostname}${i}/`,""==e&&null!=t&&(e=await requestToken(t,n)),await isTokenVaild(e)){if(-1!=window.location.href.indexOf("code=")){let e=removeURLParameter(window.location.href,"code");e=removeURLParameter(e,"session_state"),window.location.href=e}return 1==OAuthConfig.tokenInRequest&&(ConfigLog.QIDO.token.Authorization="Bearer "+e,ConfigLog.WADO.token.Authorization="Bearer "+e,ConfigLog.STOW.token.Authorization="Bearer "+e,readAllJson(readJson)),console.log(ConfigLog),!0}{setCookie("access_token","",7);let e=removeURLParameter(window.location.href,"code");e=removeURLParameter(e,"session_state");let o=`${keycloakAPI}${OAuthConfig.endpoints.auth}?client_id=${OAuthConfig.client_id}&grant_type=authorization_code&response_type=code&redirect_uri=${e}`;return window.location.href=o,!1}}return!0}function getCookie(e){const o=`; ${document.cookie}`.split(`; ${e}=`);return 2===o.length?o.pop().split(";").shift():""}function setCookie(e,o,t){var n="";if(t){var i=new Date;i.setTime(i.getTime()+24*t*60*60*1e3),n="; expires="+i.toUTCString()}document.cookie=e+"="+(o||"")+n+"; path=/"}function isTokenVaild(e){return new Promise(((o,t)=>{let n=`${keycloakAPI}${OAuthConfig.endpoints.validation}`,i=new XMLHttpRequest;i.open("GET",n),i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),i.setRequestHeader("Authorization","Bearer "+e),i.responseType="json",i.onerror=function(e){console.log(e),o(!1)},i.onload=function(){"200"==i.status?o(!0):o(!1)},i.send()}))}function requestToken(e,o){return new Promise(((t,n)=>{let i=`${keycloakAPI}${OAuthConfig.endpoints.token}`,r=removeURLParameter(window.location.href,"code");r=removeURLParameter(r,"session_state");let a="",s=`grant_type=authorization_code&client_id=${OAuthConfig.client_id}&code=${e}&session_state=${o}&redirect_uri=${r}`,u=new XMLHttpRequest;u.open("POST",i),u.setRequestHeader("Content-type","application/x-www-form-urlencoded"),u.responseType="json",u.send(s),u.onload=function(){let e=u.response;a=e.access_token,setCookie("access_token",a,7),t(a)}}))}function loadOAuthConfig(e){return new Promise(((o,t)=>{let n={},i=e,r=new XMLHttpRequest;r.open("GET",i),r.responseType="json",r.send(),r.onload=function(){return n=r.response,o(n)}}))}function removeURLParameter(e,o){let t=e.split("?");if(t.length>=2){let e=encodeURIComponent(o)+"=",n=t[1].split(/[&;]/g);for(let o=n.length;o-- >0;)-1!==n[o].lastIndexOf(e,0)&&n.splice(o,1);return t[0]+(n.length>0?"?"+n.join("&"):"")}return e}auth(),window.addEventListener("load",(function(e){auth()}));