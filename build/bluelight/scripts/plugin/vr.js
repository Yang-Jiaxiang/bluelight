var openVR=!1,openRendering=!1,o3Dcount=0,o3d_3degree=-1,o3DListLength=0,o3DAlphaValue=100,openCave=!1,Thickness=1,degerrX=0,degerrY=0,degerrX_2=0,degerrY_2=90,Direction_VR=(degerrX_2=90,degerrY_2=0,1),rotateStep=3,rotateSpeed=12,zoomRatio3D=1;function loadVR(){var e;(e=document.createElement("SPAN")).innerHTML='<img class="img VR" alt="3d" id="ImgVR" src="../image/icon/black/b_3D_off.png" width="50" height="50">\n    <img class="img VR MPR" alt="3dDisplay" id="3dDisplay" src="../image/icon/black/b_DisplayReset.png"\n    style="display:none;" width="50" height="50">\n    <img class="img VR" alt="3dCave" id="3dCave" src="../image/icon/black/b_Cross-hair_OFF.png" style="display:none;"\n    width="50" height="50">',getByid("icon-list").appendChild(e),(e=document.createElement("SPAN")).innerHTML='<div id="VR_setup" style="background-color:#84420044;">\n      <label style="color: #ffffff;" id="o3dPresetLabel">Preset：</label>\n      <select id="o3DStyle">\n        <option selected="selected">Auto</option>\n        <option id="o3DAngio">Angio</option>\n        <option id="o3DAirways">Airways</option>\n        <option id="o3DcomCombine">Combine</option>\n        <option id="o3DcomCombine2">Combine2</option>\n        <option id="o3DMip">MIP</option>\n        <option id="o3DMinIP">MinIP</option>\n      </select>\n      <font color="white" id="o3dAlphaValueLabel">Alpha：</font><input type="text" id="o3dAlphaValueText" size="3"\n        value="100" />\n      <label style="color: #ffffff;" id="smoothLabel">Smooth<input type="checkbox" name="3dSmooth"\n          id="3dSmooth"></label>\n      <label style="color: #ffffff;" id="yellowColorLabel">Color<input type="checkbox" name="3dYellow"\n          id="3dYellow"></label>\n      <label style="color: #ffffff;" id="3dShadowLabel">shadow\n        \x3c!--<input type="checkbox" name="3dShadow" id="3dShadow">--\x3e\n        <select name="3dShadow" id="3dShadow">\n          <option id="3dShadow_0">None</option>\n          <option id="3dShadow_05">0.005</option>\n          <option id="3dShadow_1">0.01</option>\n          <option id="3dShadow_2">0.02</option>\n          <option id="3dShadow_3" selected="selected">0.03</option>\n          <option id="3dShadow_4">0.04</option>\n          <option id="3dShadow_5">0.05</option>\n          <option id="3dShadow_6">0.06</option>\n          <option id="3dShadow_7">0.07</option>\n          <option id="3dShadow_8">0.08</option>\n          <option id="3dShadow_12">0.12</option>\n        </select>\n      </label>\n      <label style="color: #ffffff;display:none" id="3dInsertLabel">Insert(hide)：<input type="text" id="3dInsertText"\n          size="1" value="0" /></label>\n      <label style="color: #ffffff;" id="3Dskin">Skin：<input type="text" id="3DskinText" size="3" value="25" /></label>\n      <label style="color: #ffffff;" id="3dStrengthenLabel">3D Strengthen：\n        <select id="3dStrengthen">\n          <option selected="selected" id="3dStrengthenAuto">Auto</option>\n          <option id="3dStrengthenAlways">Always</option>\n          <option id="3dStrengthenNone">None</option>\n        </select>\n      </label>\n      <label style="color: #ffffff;" id="3dZipLabel">3D Zip：<input type="checkbox" checked="true"\n          id="3dZipCheckbox"><input type="text" id="3dZipText" size="3" value="50" /></label>\n      <label style="color: #ffffff;display:none" id="3dPerspectiveLabel">perspective：<input type="text"\n          id="3dPerspective" value="10000" /></label>\n      <img width="25" height="25" src="../image/icon/black/download.png" onclick="VRscreenshot();">\n    </div>',getByid("page-header").appendChild(e),(e=document.createElement("SPAN")).innerHTML='<div id="WindowLevelDiv_VR" class="VR_div" style="background-color:#33666644;">\n    <font color="white" id="myWC_VR">WC：</font><input type="text" id="textWC_VR" value="520" />\n    <font color="white" id="myWW_VR">WW：</font><input type="text" id="textWW_VR" value="50" />\n    <select id="WindowLevelSelect_VR">\n      <option id="WindowDefault_VR" selected="selected">Default</option>\n      <option id="WindowCustom_VR">Custom</option>\n      <option class="WindowSelect_VR" id="WindowAbdomen_VR" wc="60" ww="400">Abdomen(60,400)</option>\n      <option class="WindowSelect_VR" id="WindowAngio_VR" wc="300" ww="600">Angio(300,600)</option>\n      <option class="WindowSelect_VR" id="WindowBone_VR" wc="300" ww="1500">Bone(300,1500)</option>\n      <option class="WindowSelect_VR" id="WindowBrain_VR" wc="40" ww="80">Brain(40,80)</option>\n      <option class="WindowSelect_VR" id="WindowChest_VR" wc="40" ww="400">Chest(40,400)</option>\n      <option class="WindowSelect_VR" id="WindowLungs_VR" wc="-400" ww="1500">Lungs(-400,1500)</option>\n    </select>\n  </div>',getByid("page-header").appendChild(e),getByid("WindowLevelDiv_VR").style.display="none",getByid("VR_setup").style.display="none",getByid("3dDisplay").style.display="none",getByid("3dCave").style.display="none"}function loadVR_UI(){var e;getByid("MouseOperation_VR")||((e=document.createElement("IMG")).src=getByid("MouseOperation").src,e.id="MouseOperation_VR",e.className="VR_icon",e.width=e.height="50",e.style.filter="sepia(100%)",getByid("MouseOperation_span").appendChild(e)),getByid("WindowRevision_VR")||((e=document.createElement("IMG")).src=getByid("WindowRevision").src,e.id="WindowRevision_VR",e.className="VR_icon",e.width=e.height="50",e.style.filter="sepia(100%)",getByid("WindowRevision_span").appendChild(e))}function enterVR_UI(){getByid("MouseOperation_VR").style.display="",getByid("WindowRevision_VR").style.display="",getByid("MouseOperation").style.display="none",getByid("WindowRevision").style.display="none",getByid("WindowLevelDiv").style.display="none",openLeftImgClick=!1}function exitVR_UI(){getByid("MouseOperation_VR").style.display="none",getByid("WindowRevision_VR").style.display="none",getByid("WindowLevelDiv_VR").style.display="none",getByid("MouseOperation").style.display="",getByid("WindowRevision").style.display="",getByid("WindowLevelDiv").style.display="",openLeftImgClick=!0}function drawBorderVR(e){for(var t=getClass("VR_icon"),i=0;i<t.length;i++)Css(t[i],"border","");Css(e,"border","3px #FFFFFF solid"),Css(e,"borderRadius","3px 3px 3px 3px")}function resizeVR(e){for(var t=0;t<Viewport_Total;t++)if(1==openVR||1==openMPR){for(var i=0;i<o3DListLength;i++){var o=getByid("3DDiv"+i),n=0;openVR?n=getViewportFixSize(window.innerWidth,window.innerHeight,1,1):openMPR&&(n=getViewportFixSize(window.innerWidth,window.innerHeight,2,2)),o.style.width=n[0]+"px",o.style.height=n[1]+"px"}for(i=0;i<o3d_3degree;i++){var a=getByid("3DDiv2_"+i);n=0,openVR?n=getViewportFixSize(window.innerWidth,window.innerHeight,1,1):openMPR&&(n=getViewportFixSize(window.innerWidth,window.innerHeight,2,2)),a.style.width=n[0]+"px",a.style.height=n[1]+"px";var d=getByid("3DDiv3_"+i);d.style.width=n[0]+"px",d.style.height=n[1]+"px"}if(t!=viewportNumber)continue}}function initVR(){if(0==openVR){exitVR_UI(),document.body.style.perspective="",document.body.style.transformStyle="",VIEWPORT.fixRow=VIEWPORT.fixCol=null,getByid("3dYellow").checked=!1;for(var e=0;e<o3DListLength;e++)try{(r=getByid("3DDiv"+e)).canvas().width=2,r.canvas().height=2,r.getElementsByClassName("VrCanvas")[0]=null,r.canvas(),r.parentElement.removeChild(r),delete r}catch(w){}for(e=0;e<o3d_3degree;e++)try{(r=getByid("3DDiv2_"+e)).canvas().width=2,r.canvas().height=2,r.getElementsByClassName("VrCanvas")[0]=null,(r=getByid("3DDiv3_"+e)).canvas().width=2,r.canvas().height=2,r.getElementsByClassName("VrCanvas")[0]=null}catch(u){}VIEWPORT.lockViewportList=[],window.removeEventListener("resize",resizeVR,!1),GetViewport(0).removeEventListener("mousemove",mousemove3D,!1),GetViewport(0).removeEventListener("mousedown",mousedown3D,!1),GetViewport(0).removeEventListener("mouseup",mouseup3D,!1),GetViewport(0).removeEventListener("touchstart",touchstart3D,!1),GetViewport(0).removeEventListener("touchmove",touchmove3D,!1),GetViewport(0).removeEventListener("touchend",touchend3D,!1);for(var t=0;t<Viewport_Total;t++)GetViewport(t).removeEventListener("contextmenu",contextmenuF,!1),GetViewport(t).removeEventListener("mousemove",Mousemove,!1),GetViewport(t).removeEventListener("mousedown",Mousedown,!1),GetViewport(t).removeEventListener("mouseup",Mouseup,!1),GetViewport(t).removeEventListener("mouseout",Mouseout,!1),GetViewport(t).removeEventListener("wheel",Wheel,!1),GetViewport(t).removeEventListener("mousedown",thisF,!1),GetViewport(t).removeEventListener("touchstart",touchstartF,!1),GetViewport(t).removeEventListener("touchend",touchendF,!1),GetViewport(t).addEventListener("touchstart",thisF,!1),GetViewport(t).addEventListener("mousedown",thisF,!1);cancelTools(),openMouseTool=!0,drawBorder(getByid("MouseOperation")),getByid("ImgVR").src="../image/icon/black/b_3D_off.png",getByid("3dDisplay").style.display="none",getByid("VR_setup").style.display="none",getByid("WindowLevelDiv_VR").style.display="none",getByid("3dCave").style.display="none",getByid("OutSide3dDiv")&&(getByid("OutSide3dDiv"),getByid("OutSide3dDiv").parentElement.removeChild(getByid("OutSide3dDiv")));try{getByid("MprCanvas1").style.display="none",getByid("MprCanvas2").style.display="none"}catch(m){}viewportNumber=0,window.onresize();var i=GetViewport(0).sop,o=SearchUid2Json(i);o&&loadAndViewImage(Patient.Study[o.studyuid].Series[o.sreiesuid].Sop[o.sopuid].imageId,0),o3DListLength=0}else if(1==openVR){enterVR_UI(),getByid("3dYellow").checked=!0,VIEWPORT.fixRow=VIEWPORT.fixCol=1,openLink=!1,changeLinkImg(),openAnnotation=!1,displayAnnotation(),getByid("3dDisplay").style.display="",getByid("SplitViewportDiv").style.display="none",getByid("VR_setup").style.display="",getByid("3dCave").style.display="",cancelTools(),getByid("ImgVR").src="../image/icon/black/b_3D_on.png";var n=GetViewport().sop;SetTable(1,1);var a=SearchUid2Json(n);GetViewport().NowCanvasSizeWidth=GetViewport().NowCanvasSizeHeight=null,loadAndViewImage(Patient.Study[a.studyuid].Series[a.sreiesuid].Sop[a.sopuid].imageId),GetViewport().canvas().style.display="none",GetViewportMark().style.display="none",GetViewport(0).canvas().style.display="none",GetViewportMark(0).style.display="none",VIEWPORT.lockViewportList=[0],window.addEventListener("resize",resizeVR,!1);for(var d=0;d<Viewport_Total;d++)GetViewport(d).removeEventListener("contextmenu",contextmenuF,!1),GetViewport(d).removeEventListener("mousemove",Mousemove,!1),GetViewport(d).removeEventListener("mousedown",Mousedown,!1),GetViewport(d).removeEventListener("mouseup",Mouseup,!1),GetViewport(d).removeEventListener("mouseout",Mouseout,!1),GetViewport(d).removeEventListener("wheel",Wheel,!1),GetViewport(d).removeEventListener("mousedown",thisF,!1),GetViewport(d).removeEventListener("touchstart",touchstartF,!1),GetViewport(d).removeEventListener("touchend",touchendF,!1),GetViewport(d).removeEventListener("touchstart",thisF,!1),GetViewport(d).removeEventListener("mousedown",thisF,!1);for(GetViewport(0).addEventListener("mousemove",mousemove3D,!1),GetViewport(0).addEventListener("mousedown",mousedown3D,!1),GetViewport(0).addEventListener("mouseup",mouseup3D,!1),GetViewport(0).addEventListener("touchstart",touchstart3D,!1),GetViewport(0).addEventListener("touchmove",touchmove3D,!1),GetViewport(0).addEventListener("touchend",touchend3D,!1),GetViewport(0).addEventListener("contextmenu",contextmenuF,!1),e=0;e<o3DListLength;e++){var r=getByid("3DDiv"+e);GetViewport(0).appendChild(r)}var s=sortInstance(n),g=getFixSize(window.innerWidth,window.innerHeight,GetViewport(0));if(o3DListLength!=s.length)for(e=0;e<o3DListLength;e++)try{(r=getByid("3DDiv"+e)).canvas().width=2,r.canvas().height=2,r.getElementsByClassName("VrCanvas")[0]=null,r.canvas(),r.parentElement.removeChild(r),delete r}catch(B){}if(o3d_3degree>=0)for(e=0;e<o3d_3degree;e++){try{(r=getByid("3DDiv2_"+e)).canvas().width=2,r.canvas().height=2,r.getElementsByClassName("VrCanvas")[0]=null,r.canvas(),r.parentElement.removeChild(r),delete r}catch(V){}try{(r=getByid("3DDiv3_"+e)).canvas().width=2,r.canvas().height=2,r.getElementsByClassName("VrCanvas")[0]=null,r.canvas(),r.parentElement.removeChild(r),delete r}catch(f){}}o3DListLength=s.length;var l=document.createElement("DIV");function h(e){return new Promise((t=>setTimeout(t,e)))}l.id="OutSide3dDiv",l.addEventListener("contextmenu",contextmenuF,!1),openRendering=!0,img2darkByClass("Rendering",!openRendering);var p=!1;GetViewport(0).appendChild(l),getByid("OutSide3dDiv").parentNode.replaceChild(l,getByid("OutSide3dDiv")),1==getByid("3dStrengthenAuto").selected||getByid("3dStrengthenAlways").selected||getByid("o3DMinIP").selected?getByid("OutSide3dDiv")&&(getByid("OutSide3dDiv").style.transformStyle="preserve-3d"):getByid("OutSide3dDiv")&&(getByid("OutSide3dDiv").style.transformStyle="");var y=1e19;Thickness=-(Thickness=0)+y;for(var c=0;c<s.length;c++){const x=c,_=getPatientbyImageID[s[x].imageId].image,C=getPatientbyImageID[s[x].imageId].pixelData;try{var v=document.createElement("DIV");v.addEventListener("contextmenu",contextmenuF,!1),v.id="3DDiv"+x,v.className="o3DDiv",v.sop=_.data.string("x00080018"),v.width=_.width,v.height=_.height,v.style.width=_.width+"px",v.style.height=_.height+"px",v.thickness=parseFloat(_.data.string("x00200032").split("\\")[2])*GetViewport().PixelSpacingX,v.thickness<Thickness&&(Thickness=v.thickness),v.thickness<y&&(y=v.thickness),o3Dcount=s.length,l.appendChild(v),getByid("3DDiv"+x).parentNode.replaceChild(v,getByid("3DDiv"+x));var D=document.createElement("CANVAS");D.className="VrCanvas",v.appendChild(D),displayCanvasFor3D(D,_,C),v.style.transform="rotate3d(0, 0, 0 , 0deg) translateZ(-"+x+"px)",v.style.width=g[0]+"px",v.style.height=g[1]+"px",v.canvas=function(){return this.getElementsByClassName("VrCanvas")[0]?this.getElementsByClassName("VrCanvas")[0]:null},v.ctx=function(){return this.getElementsByClassName("VrCanvas")[0]?this.getElementsByClassName("VrCanvas")[0].getContext("2d"):null}}catch(L){return console.log(L),p=!0,1==openVR&&(openVR=!1,alert("Error, this image may not support 3D.")),openRendering=!1,void getByid("ImgVR").onclick("error")}}return void function(){if(1==p&&1==openVR)return openRendering=!1,img2darkByClass("VR",!openVR),void getByid("ImgVR").click();h(100).then((()=>{if(getByid("3DDiv"+(o3DListLength-1)).thickness-Thickness-(getByid("3DDiv0").thickness-Thickness)<0){for(var e=[],t=0;t<o3DListLength;t++){var i=getByid("3DDiv"+t);e.push(i.thickness)}for(t=0;t<o3DListLength;t++)(i=getByid("3DDiv"+t)).thickness=e[o3DListLength-t-1]}Alpha3D(),h(100).then((()=>{openRendering=!1,img2darkByClass("VR",!openVR),setTimeout(getByid("MouseOperation_VR").click(),100)}))}))}()}}function get3dDistance(){var e=0;return(e+=getByid("3DDiv"+(o3Dcount-1)).thickness-getByid("3DDiv0").thickness)<0&&(e*=-1),e*(parseFloat(getByid("3DDiv0").canvas().style.height)/parseFloat(GetViewport().imageHeight))}function displayCanvasFor3D(e,t,i){e.width=t.width,e.height=t.height,e.style.width=t.width+"px",e.style.height=t.height+"px";var o=e.getContext("2d"),n=o.createImageData(t.width,t.height),a=GetViewport().windowWidthList,d=GetViewport().windowCenterList;if(1==getByid("o3DAngio").selected?(a=332,d=287):1==getByid("o3DAirways").selected&&(a=409,d=-538),1==getByid("o3DcomCombine").selected||1==getByid("o3DcomCombine2").selected){var r=(d=-538)+(a=409)/2,s=d-a/2,g=t.intercept;CheckNull(g)&&(g=0);var l=t.slope;CheckNull(l)&&(l=1);var h=255/(r-s)*l,p=(-s+g)/(r-s)*255;if(1==t.color)for(var y=0;y<n.data.length;y+=4)n.data[y+0]=i[y]*h+p,n.data[y+1]=i[y+1]*h+p,n.data[y+2]=i[y+2]*h+p,128-Math.abs(128-n.data[y])>25?(n.data[y]=93,n.data[y+1]=238,n.data[y+2]=238,n.data[y+3]=255):n.data[y+3]=0;else{y=0;for(var c=0;y<n.data.length;y+=4,c++)n.data[y+0]=n.data[y+1]=n.data[y+2]=i[c]*h+p,128-Math.abs(128-n.data[y])>25?(n.data[y]=93,n.data[y+1]=238,n.data[y+2]=238,n.data[y+3]=255):n.data[y+3]=0}if(1==getByid("o3DcomCombine2").selected?(a=800,d=600):1==getByid("o3DcomCombine").selected&&(a=332,d=287),r=d+a/2,s=d-a/2,g=t.intercept,CheckNull(g)&&(g=0),l=t.slope,CheckNull(l)&&(l=1),h=255/(r-s)*l,p=(-s+g)/(r-s)*255,1==t.color)for(y=0;y<n.data.length;y+=4)0==n.data[y+3]&&(n.data[y+0]=i[y]*h+p,n.data[y+1]=i[y+1]*h+p,n.data[y+2]=i[y+2]*h+p,n.data[y+0]>25&&(n.data[y+3]=255));else for(y=0,c=0;y<n.data.length;y+=4,c++)0==n.data[y+3]&&(n.data[y+0]=n.data[y+1]=n.data[y+2]=i[c]*h+p,n.data[y+0]>25&&(n.data[y+3]=255))}else if(r=d+a/2,s=d-a/2,g=t.intercept,CheckNull(g)&&(g=0),l=t.slope,CheckNull(l)&&(l=1),h=255/(r-s)*l,p=(-s+g)/(r-s)*255,1==t.color)for(y=0;y<n.data.length;y+=4)n.data[y+0]=i[y]*h+p,n.data[y+1]=i[y+1]*h+p,n.data[y+2]=i[y+2]*h+p,n.data[y+3]=255;else if(1!=t.invert&&1==GetViewport().openInvert||1==t.invert&&0==GetViewport().openInvert)for(y=0,c=0;y<n.data.length;y+=4,c++)n.data[y+0]=n.data[y+1]=n.data[y+2]=255-i[c]*h+p,n.data[y+3]=255;else for(y=0,c=0;y<n.data.length;y+=4,c++)n.data[y+0]=n.data[y+1]=n.data[y+2]=i[c]*h+p,n.data[y+3]=255;o.putImageData(n,0,0)}loadVR(),loadVR_UI(),getByid("MouseOperation_VR").style.display="none",getByid("WindowRevision_VR").style.display="none",getByid("WindowLevelDiv_VR").style.display="none",getByid("WindowRevision_VR").onclick=function(){set_BL_model("windowlevel_VR");for(var e=getClass("VR_div"),t=0;t<e.length;t++)Css(e[t],"border","");getByid("WindowLevelDiv_VR").style.display="",drawBorderVR(this)},getByid("MouseOperation_VR").onclick=function(){if(0!=this.enable){for(var e=getClass("VR_div"),t=0;t<e.length;t++)e[t].style.display="none";set_BL_model("mouseTool_VR"),drawBorderVR(this)}},getByid("textWC_VR").onchange=function(){GetViewport().windowCenterList=parseInt(textWC_VR.value),getByid("WindowCustom_VR").selected=!0},getByid("textWW_VR").onchange=function(){GetViewport().windowWidthList=parseInt(textWW_VR.value),getByid("WindowCustom_VR").selected=!0},getByid("WindowLevelSelect_VR").onchange=function(){1==getByid("WindowDefault").selected&&(getByid("textWC_VR").value=GetViewport().windowCenterList=GetViewport().windowCenter,getByid("textWW_VR").value=GetViewport().windowWidthList=GetViewport().windowWidth);for(var e=0;e<getClass("WindowSelect_VR").length;e++)1==getClass("WindowSelect_VR")[e].selected&&(GetViewport().windowCenterList=getByid("textWC_VR").value=parseInt(getClass("WindowSelect_VR")[e].getAttribute("wc")),GetViewport().windowWidthList=getByid("textWW_VR").value=parseInt(getClass("WindowSelect_VR")[e].getAttribute("ww")))},getByid("ImgVR").onclick=function(e){0!=this.enable&&(openVR=!openVR,"error"==e&&(openVR=!1),img2darkByClass("VR",!openVR),initVR(),getByid("MouseOperation_VR").click())},getByid("3dZipText").onchange=getByid("3dZipCheckbox").onclick=function(){if(0==getByid("3dZipCheckbox").checked)for(var e=0;e<o3DListLength;e++)(t=getByid("3DDiv"+e).canvas()).style.display="";else for(e=0;e<o3DListLength;e++){var t;(t=getByid("3DDiv"+e).canvas()).style.display="",1==getByid("3dZipCheckbox").checked&&parseInt(getByid("3dZipText").value)<o3DListLength&&e%parseInt(o3DListLength/parseFloat(getByid("3dZipText").value))!=0&&(t.style.display="none")}},getByid("o3dAlphaValueText").onchange=function(){parseInt(getByid("o3dAlphaValueText").value)<=1?getByid("o3dAlphaValueText").value=1:parseInt(getByid("o3dAlphaValueText").value)>=100&&(getByid("o3dAlphaValueText").value=100),o3DAlphaValue=parseInt(getByid("o3dAlphaValueText").value)},getByid("3dInsertText").onchange=function(){parseFloat(getByid("3dInsertText").value)<=0?getByid("3dInsertText").value=0:parseInt(getByid("3dInsertText").value)>=5?getByid("3dInsertText").value=5:parseInt(getByid("3dInsertText").value)<5||(getByid("3dInsertText").value=1)},getByid("3DskinText").onchange=function(){parseFloat(getByid("3DskinText").value)<=0?getByid("3DskinText").value=0:parseInt(getByid("3DskinText").value)>=100?getByid("3DskinText").value=100:parseInt(getByid("3DskinText").value)<100||(getByid("3DskinText").value=0)},getByid("3dShadow").onchange=function(){setVrLight()},getByid("3dStrengthen").onchange=function(){1==getByid("3dStrengthenAuto").selected||getByid("3dStrengthenAlways").selected||getByid("o3DMinIP").selected?getByid("OutSide3dDiv")&&(getByid("OutSide3dDiv").style.transformStyle="preserve-3d"):getByid("OutSide3dDiv")&&(getByid("OutSide3dDiv").style.transformStyle="")},getByid("3dPerspective").onchange=function(){parseFloat(getByid("3dPerspective").value)<=-1e4?getByid("3dPerspective").value=-1e4:parseInt(getByid("3dPerspective").value)>=1e4?getByid("3dPerspective").value=1e4:parseInt(getByid("3dPerspective").value)<1e4||(getByid("3dPerspective").value=0),document.body.style.perspective=getByid("3dPerspective").value+"px"},getByid("3dDisplay").onclick=function(){o3dWindowLevel()},getByid("3dCave").onclick=function(){openCave=!openCave,this.src=1==openCave?"../image/icon/black/b_Cross-hair_ON.png":"../image/icon/black/b_Cross-hair_OFF.png"};var Uint8Canvas=[];function Alpha3D(){if(openVR||openMPR){var e=GetViewport().canvas();getByid("OutSide3dDiv")&&(getByid("OutSide3dDiv").style.transformStyle=""),zoomRatio3D=1;for(var t=parseFloat(100/85),i=parseFloat(50/85),o=parseFloat(35/85),n=parseFloat(65/85),a=parseFloat(100/85),d=parseFloat(115/85),r=parseFloat(90/85),s=parseFloat(70/85),g=parseFloat(30/85),l=[],h=[],p=[],y=0;y<=85;y++)l.push(parseInt(0+t*y)),h.push(parseInt(0+i*y)),p.push(parseInt(0+o*y));for(y=0;y<=85;y++)l.push(parseInt(100+r*y)),h.push(parseInt(50+s*y)),p.push(parseInt(35+g*y));for(y=0;y<=85;y++)l.push(parseInt(190+n*y)),h.push(parseInt(120+a*y)),p.push(parseInt(65+d*y));for(var c=0;c<o3DListLength&&(1!=getByid("o3DMip").selected||!openVR);c++){(f=getByid("3DDiv"+c).canvas()).addEventListener("mousedown",mousedownFocus3D,!1),f.addEventListener("mousemove",mousemoveFocus3D,!1),f.addEventListener("mouseup",mouseupFocus3D,!1);var v=(u=f.getContext("2d")).getImageData(0,0,f.width,f.height),D=v.data;if(1==openCave)for(let e=0;e<D.length;e+=4)D[e]<=25&&D[e+1]<=25&&D[e+2]<=25&&(D[e+3]=0);else if(1==getByid("o3DAirways").selected){var w=0;for(let e=0;e<D.length;e+=4)w=128-Math.abs(128-D[e]),D[e]=93,D[e+1]=238,D[e+2]=238,D[e+3]=w<=25?0:w}else if(1==getByid("o3DcomCombine2").selected)for(let e=0;e<D.length;e+=4)D[e]<=25&&D[e+1]<=25&&D[e+2]<=25?D[e+3]=0:93==D[e]&&D[e+1];else if(1==getByid("o3DcomCombine").selected&&1==getByid("3dYellow").checked)for(let e=0;e<D.length;e+=4)D[e]<=25&&D[e+1]<=25&&D[e+2]<=25?D[e+3]=0:93==D[e]&&238==D[e+1]||(D[e]=l[D[e]],D[e+1]=h[D[e+1]],D[e+2]=p[D[e+2]],D[e+3]=D[e+3]*o3DAlphaValue/100);else if(1==getByid("3dYellow").checked)if(1==getByid("3dSmooth").checked)for(let e=0;e<D.length;e+=4)D[e]<=25&&D[e+1]<=25&&D[e+2]<=25?D[e+3]=0:(D[e]=l[D[e]],D[e+1]=h[D[e+1]],D[e+2]=p[D[e+2]],D[e+3]=(D[e]+D[e+1]+D[e+2])/3*2,D[e+3]=D[e+3]*o3DAlphaValue/100);else for(let e=0;e<D.length;e+=4)D[e]<=25&&D[e+1]<=25&&D[e+2]<=25?D[e+3]=0:(D[e]=l[D[e]],D[e+1]=h[D[e+1]],D[e+2]=p[D[e+2]],D[e+3]=D[e+3]*o3DAlphaValue/100);else if(1==getByid("3dSmooth").checked)for(let e=0;e<D.length;e+=4)D[e+3]=D[e],D[e+3]=D[e+3]*o3DAlphaValue/100;else for(let e=0;e<D.length;e+=4)D[e]<=25&&D[e+1]<=25&&D[e+2]<=25?D[e+3]=0:D[e+3]=D[e+3]*o3DAlphaValue/100;u.putImageData(v,0,0)}for(c=0;c<o3DListLength;c++){var u=(f=getByid("3DDiv"+c).canvas()).getContext("2d"),m=document.createElement("CANVAS");m.canvas=function(){return this},m.sop=getByid("3DDiv"+c).sop,m.width=f.width,m.height=f.height,display3DMark(m,m.sop),u.drawImage(m,0,0),delete m}if(o3Dcount==o3DListLength)for(var B=0;B<parseInt(getByid("3dInsertText").value);B++){for(c=o3DListLength-1;c>=0;c--)getByid("3DDiv"+c).id="3DDiv"+2*c;for(o3DListLength=2*o3DListLength-1,openVR?x=getViewportFixSize(window.innerWidth,window.innerHeight,1,1):openMPR&&(x=getViewportFixSize(window.innerWidth,window.innerHeight,2,2)),c=0;c<o3DListLength;c++)if(c%2!=0){(k=document.createElement("DIV")).addEventListener("contextmenu",contextmenuF,!1),k.id="3DDiv"+c,k.className="o3DDiv",k.sop=getByid("3DDiv"+(c-1)).sop,k.width=getByid("3DDiv"+(c-1)).width,k.height=getByid("3DDiv"+(c-1)).height,k.style.width=getByid("3DDiv"+(c-1)).style.width,k.style.height=getByid("3DDiv"+(c-1)).style.height,k.thickness=(getByid("3DDiv"+(c-1)).thickness+getByid("3DDiv"+(c+1)).thickness)/2,k.style="position:absolute;width:"+k.width+"px;height:"+k.height+"px;z-index:"+c+";",(P=document.createElement("CANVAS")).className="VrCanvas",P.width=k.width,P.height=k.height,P.style.width=k.style.width,P.style.height=k.style.height,P.getContext("2d").globalAlpha=.5;var V=getByid("3DDiv"+(c-1)).canvas();P.getContext("2d").drawImage(V,0,0),V=getByid("3DDiv"+(c+1)).canvas(),P.getContext("2d").drawImage(V,0,0),P.getContext("2d").globalAlpha=1,k.appendChild(P),(1==openVR||1==openMPR)&&getByid("OutSide3dDiv").appendChild(k),getByid("3DDiv"+c).parentNode.replaceChild(k,getByid("3DDiv"+c)),k.style="transform:rotate3d(0, 0, 0 , 0deg) translateZ(-"+c+"px);;position:absolute;width:"+x[0]+"px;height:"+x[1]+"px;",k.canvas=function(){return this.getElementsByClassName("VrCanvas")[0]?this.getElementsByClassName("VrCanvas")[0]:null},k.ctx=function(){return this.getElementsByClassName("VrCanvas")[0]?this.getElementsByClassName("VrCanvas")[0].getContext("2d"):null}}}for(c=0;c<o3DListLength;c++){var f=getByid("3DDiv"+c).canvas();!parseInt(f.style.width)>=1&&(f.style.width=e.style.width,f.style.height=e.style.height),f.style.margin="-"+parseInt(f.style.height)/2+"px 0 0 -"+parseInt(f.style.width)/2+"px"}Uint8Canvas=[];for(var x,_=getByid("3DDiv0").canvas(),C=0;C<o3DListLength;C++){canvasCtx0=getByid("3DDiv"+C).canvas().getContext("2d"),canvasCtx=canvasCtx0.getImageData(0,0,_.width,_.height);var L=new ArrayBuffer(canvasCtx.data.length),R=new Uint8Array(L);for(y=0;y<R.length;y++)R[y]=canvasCtx.data[y];Uint8Canvas.push(R)}for(o3d_3degree=parseInt(getByid("3DskinText").value),openVR?x=getViewportFixSize(window.innerWidth,window.innerHeight,1,1):openMPR&&(x=getViewportFixSize(window.innerWidth,window.innerHeight,2,2)),c=0;c<o3d_3degree;c++){var S=get3dDistance(),k=document.createElement("DIV");_=getByid("3DDiv0").canvas(),k.addEventListener("contextmenu",contextmenuF,!1),k.id="3DDiv2_"+c,k.className="o3DDiv",k.width=_.width,k.height=o3DListLength,k.style.width=getByid("3DDiv0").style.width,k.style.height=getByid("3DDiv0").style.height,k.rotatePosition=c*(e.height/o3DListLength),k.zPosition=e.height/o3d_3degree*(o3d_3degree-c)-(e.height-S)/2,(P=document.createElement("CANVAS")).className="VrCanvas",P.width=_.width,P.height=o3DListLength,P.style.width=_.width+"px",P.style.height=S+"px",P.originWidth=parseFloat(P.style.width),P.originHeight=parseFloat(P.style.height),P.rotatePosition=c*(e.height/o3DListLength);var I=P.getContext("2d").getImageData(0,0,P.width,P.height);if(getByid("3DDiv"+(o3DListLength-1)).thickness-Thickness-(getByid("3DDiv0").thickness-Thickness)<0)for(C=0;C<o3DListLength;C++)for(X=Uint8Canvas[C],F=C*P.width*4,G=parseInt(c*(e.height/o3d_3degree))*_.width*4,M=0;M<4*P.width;M+=4)I.data[F+M]=X[G+M+0],I.data[F+M+1]=X[G+M+1],I.data[F+M+2]=X[G+M+2],I.data[F+M+3]=X[G+M+3];else for(C=0;C<o3DListLength;C++)for(F=C*P.width*4,X=Uint8Canvas[o3DListLength-C-1],G=parseInt(c*(e.height/o3d_3degree))*_.width*4,M=0;M<4*P.width;M+=4)I.data[F+M]=X[G+M+0],I.data[F+M+1]=X[G+M+1],I.data[F+M+2]=X[G+M+2],I.data[F+M+3]=X[G+M+3];k.canvas=function(){return this.getElementsByClassName("VrCanvas")[0]?this.getElementsByClassName("VrCanvas")[0]:null},k.ctx=function(){return this.getElementsByClassName("VrCanvas")[0]?this.getElementsByClassName("VrCanvas")[0].getContext("2d"):null},k.appendChild(P),P.getContext("2d").putImageData(I,0,0),1!=openVR&&1!=openMPR||getByid("OutSide3dDiv").appendChild(k),getByid("3DDiv2_"+c).parentNode.replaceChild(k,getByid("3DDiv2_"+c))}for(c=0;c<o3d_3degree;c++){var P,M,Y,F,G,b,E,X;if(S=get3dDistance(),k=document.createElement("DIV"),_=getByid("3DDiv0").canvas(),k.addEventListener("contextmenu",contextmenuF,!1),k.id="3DDiv3_"+c,k.className="o3DDiv",k.width=o3DListLength,k.height=_.height,k.style.width=getByid("3DDiv0").style.width,k.style.height=getByid("3DDiv0").style.height,k.rotatePosition=c*(e.height/o3DListLength),k.zPosition=e.width/o3d_3degree*(o3d_3degree-c)-(e.width-S)/2,(P=document.createElement("CANVAS")).className="VrCanvas",P.width=o3DListLength,P.height=_.height,P.style.width=S+"px",P.style.height=_.height+"px",P.rotatePosition=c*(e.height/o3DListLength),P.originWidth=parseFloat(P.style.width),P.originHeight=parseFloat(P.style.height),I=P.getContext("2d").getImageData(0,0,P.width,P.height),getByid("3DDiv"+(o3DListLength-1)).thickness-Thickness-(getByid("3DDiv0").thickness-Thickness)<0)for(C=0;C<o3DListLength;C++)for(M=4*C,X=Uint8Canvas[C],F=4*P.width,G=4*parseInt(c*(e.width/o3d_3degree)),Y=0;Y<P.height;Y+=1)b=Y*F+M,E=Y*_.width*4+G,I.data[b]=X[E],I.data[b+1]=X[E+1],I.data[b+2]=X[E+2],I.data[b+3]=X[E+3];else for(C=0;C<o3DListLength;C++)for(M=4*C,F=4*P.width,G=4*parseInt(c*(e.width/o3d_3degree)),X=Uint8Canvas[o3DListLength-C-1],Y=0;Y<P.height;Y+=1)b=Y*F+M,E=Y*_.width*4+G,I.data[b]=X[E],I.data[b+1]=X[E+1],I.data[b+2]=X[E+2],I.data[b+3]=X[E+3];k.canvas=function(){return this.getElementsByClassName("VrCanvas")[0]?this.getElementsByClassName("VrCanvas")[0]:null},k.ctx=function(){return this.getElementsByClassName("VrCanvas")[0]?this.getElementsByClassName("VrCanvas")[0].getContext("2d"):null},k.appendChild(P),P.getContext("2d").putImageData(I,0,0),1!=openVR&&1!=openMPR||getByid("OutSide3dDiv").appendChild(k),getByid("3DDiv3_"+c).parentNode.replaceChild(k,getByid("3DDiv3_"+c))}for(c=0;c<o3DListLength;c++){f=getByid("3DDiv"+c).canvas();var T=getByid("3DDiv"+c);f.className="VrCanvas canvas_3d",1==getByid("3dZipCheckbox").checked&&parseInt(getByid("3dZipText").value)<o3DListLength&&c%parseInt(o3DListLength/parseFloat(getByid("3dZipText").value))!=0&&(f.style.display="none"),1==getByid("o3DMip").selected&&openVR?T.style.mixBlendMode="lighten":1==getByid("o3DMinIP").selected&&openVR&&(T.style.mixBlendMode="darken")}for(c=0;c<o3d_3degree;c++)(W=getByid("3DDiv2_"+c).canvas()).className="VrCanvas canvas_3d",W.style="margin:"+-1*getByid("3DDiv2_"+c).zPosition*(parseFloat(getByid("3DDiv0").canvas().style.height)/parseFloat(GetViewport().imageHeight))+"px 0 0 -"+parseInt(W.style.width)/2+"px;width:"+W.style.width+";height:"+W.style.height+";";for(c=0;c<o3d_3degree;c++)(A=getByid("3DDiv3_"+c).canvas()).className="VrCanvas canvas_3d",A.style="margin:-"+parseInt(A.style.height)/2+"px 0 0 "+-1*getByid("3DDiv3_"+c).zPosition*(parseFloat(getByid("3DDiv0").canvas().style.height)/parseFloat(GetViewport().imageHeight))+"px;height:"+A.style.height+";width:"+A.style.width+";";for(rotate3dVR(S=get3dDistance()),c=0;c<o3d_3degree;c++){var W=getByid("3DDiv2_"+c).canvas(),z=getByid("3DDiv2_"+c);W.style.transform="rotateY(0deg) rotateX(-90deg)",1==getByid("o3DMip").selected&&openVR?z.style.mixBlendMode="lighten":1==getByid("o3DMinIP").selected&&openVR&&(z.style.mixBlendMode="darken")}for(c=0;c<o3d_3degree;c++){var A=getByid("3DDiv3_"+c).canvas(),N=getByid("3DDiv3_"+c);A.style.transform="rotateY(90deg) rotateX(0deg)",1==getByid("o3DMip").selected&&openVR?N.style.mixBlendMode="lighten":1==getByid("o3DMinIP").selected&&openVR&&(N.style.mixBlendMode="darken")}for(c=0;c<o3DListLength;c++)f=getByid("3DDiv"+c).canvas(),(T=getByid("3DDiv"+c)).onselectstart=f.onselectstart=function(){return!1},T.ondragstart=f.ondragstart=function(){return!1};for(c=0;c<o3d_3degree;c++)A=getByid("3DDiv3_"+c).canvas(),(N=getByid("3DDiv3_"+c)).onselectstart=A.onselectstart=function(){return!1},N.ondragstart=A.ondragstart=function(){return!1},W=getByid("3DDiv2_"+c).canvas(),(z=getByid("3DDiv2_"+c)).onselectstart=W.onselectstart=function(){return!1},z.ondragstart=W.ondragstart=function(){return!1};setVrLight(),setTimeout((function(){(1==getByid("3dStrengthenAuto").selected||getByid("o3DMinIP").selected)&&getByid("OutSide3dDiv")&&!openMPR&&(getByid("OutSide3dDiv").style.transformStyle="preserve-3d")}),10)}}var mousedownFocus3D=function(e){if(0!=openCave){MouseDownCheck=!0;var t=getByid("3DDiv0").canvas(),i=parseFloat(t.style.height)/parseFloat(GetViewport().imageHeight),o=null!=e.offsetX?e.offsetX:e.originalEvent.layerX,n=null!=e.offsetY?e.offsetY:e.originalEvent.layerY;o/=i,n/=i;for(var a=0;a<o3DListLength;a++){var d=getByid("3DDiv"+a).canvas();d.getContext("2d").fillStyle="rgba(0, 0, 0, 255)",d.getContext("2d").strokeStyle="rgba(0, 0, 0, 255)",d.getContext("2d").beginPath(),d.getContext("2d").lineWidth=""+2*Math.abs(2)*1,d.getContext("2d").moveTo(o,n)}}},mousemoveFocus3D=function(e){if(0!=openCave&&0!=MouseDownCheck){var t=getByid("3DDiv0").canvas(),i=parseFloat(t.style.height)/parseFloat(GetViewport().imageHeight),o=null!=e.offsetX?e.offsetX:e.originalEvent.layerX,n=null!=e.offsetY?e.offsetY:e.originalEvent.layerY;o/=i,n/=i;for(var a=0;a<o3DListLength;a++){var d=getByid("3DDiv"+a).canvas();d.getContext("2d").fillStyle="rgba(0, 0, 0, 255)",d.getContext("2d").strokeStyle="rgba(0, 0, 0, 255)",d.getContext("2d").lineTo(o,n),d.getContext("2d").stroke()}}},mouseupFocus3D=function(e){if(0!=openCave){MouseDownCheck=!1,rightMouseDown=!1;for(var t=0;t<o3DListLength;t++){var i=getByid("3DDiv"+t).canvas();i.getContext("2d").fillStyle="rgba(0, 0, 0, 255)",i.getContext("2d").strokeStyle="rgba(0, 0, 0, 255)",i.getContext("2d").fill(),i.getContext("2d").closePath()}Alpha3D()}},Timeout3d=!1,mousemove3D=function(e){if(1!=openCave&&1!=Timeout3d){var t=GetViewport().canvas();if(1==openVR||1==openMPR){if(MouseDownCheck||rightMouseDown)var i=get3dCurrPoint(e)[0],o=get3dCurrPoint(e)[1];if(Timeout3d=!0,setTimeout((function(){Timeout3d=!1}),50),1==MouseDownCheck){for(var n=0;n<o3DListLength;n++){var a=getByid("3DDiv"+n).canvas();!parseInt(a.style.width)>=1&&(a.style.width=t.style.width,a.style.height=t.style.height),a.style.margin="-"+parseInt(a.style.height)/2+"px 0 0 -"+parseInt(a.style.width)/2+"px"}for(n=0;n<o3d_3degree;n++)(s=getByid("3DDiv2_"+n).canvas()).style.margin=-1*getByid("3DDiv2_"+n).zPosition*(parseFloat(getByid("3DDiv0").canvas().style.height)/parseFloat(GetViewport().imageHeight))+"px 0 0 -"+parseInt(s.style.width)/2+"px";for(n=0;n<o3d_3degree;n++)(l=getByid("3DDiv3_"+n).canvas()).style.margin="-"+parseInt(l.style.height)/2+"px 0 0 "+-1*getByid("3DDiv3_"+n).zPosition*(parseFloat(getByid("3DDiv0").canvas().style.height)/parseFloat(GetViewport().imageHeight))+"px";var d=get3dDistance()}if(1==MouseDownCheck&&(i<GetViewport().originalPointX-rotateStep?((degerrX+=GetViewport().originalPointX-i>rotateSpeed?-1*rotateSpeed:-1*(GetViewport().originalPointX-i))<0&&(degerrX+=360),degerrX>360&&(degerrX-=360),90!=degerrX&&270!=degerrX||(degerrX+=1)):i>GetViewport().originalPointX+rotateStep&&((degerrX-=i-GetViewport().originalPointX>rotateSpeed?-1*rotateSpeed:-1*(i-GetViewport().originalPointX))<0&&(degerrX+=360),degerrX>360&&(degerrX-=360),90!=degerrX&&270!=degerrX||(degerrX-=1)),o>GetViewport().originalPointY+rotateStep?degerrX>=90&&degerrX<=270?((degerrY-=GetViewport().originalPointY-o<rotateSpeed?-1*rotateSpeed:-1*(GetViewport().originalPointY-o))<0&&(degerrY+=360),degerrY>360&&(degerrY-=360),90!=degerrY&&270!=degerrY||(degerrY-=1)):((degerrY+=o-GetViewport().originalPointY>rotateSpeed?-1*rotateSpeed:-1*(o-GetViewport().originalPointY))<0&&(degerrY+=360),degerrY>360&&(degerrY-=360),90!=degerrY&&270!=degerrY||(degerrY+=1)):o<GetViewport().originalPointY-rotateStep&&(degerrX>=90&&degerrX<=270?((degerrY+=GetViewport().originalPointY-o>rotateSpeed?-1*rotateSpeed:-1*(GetViewport().originalPointY-o))<0&&(degerrY+=360),degerrY>360&&(degerrY-=360),90!=degerrY&&270!=degerrY||(degerrY+=1)):((degerrY-=o-GetViewport().originalPointY<rotateSpeed?-1*rotateSpeed:-1*(o-GetViewport().originalPointY))<0&&(degerrY+=360),degerrY>360&&(degerrY-=360),90!=degerrY&&270!=degerrY||(degerrY+=1))),rotate3dVR(d)),1==rightMouseDown){if(o>GetViewport().originalPointY+3){for(zoomRatio3D/=1.05,n=0;n<o3DListLength;n++)a=getByid("3DDiv"+n).canvas(),!parseInt(a.style.width)>=1&&(a.style.width=t.style.width,a.style.height=t.style.height),a.style.width=parseFloat(a.width)*zoomRatio3D+"px",a.style.height=parseFloat(a.height)*zoomRatio3D+"px",a.style.margin="-"+parseInt(a.style.height)/2+"px 0 0 -"+parseInt(a.style.width)/2+"px";for(n=0;n<o3d_3degree;n++)(s=getByid("3DDiv2_"+n).canvas()).style.width=parseFloat(s.originWidth)*zoomRatio3D+"px",s.style.height=parseFloat(s.originHeight)*zoomRatio3D+"px",s.style.margin=-1*getByid("3DDiv2_"+n).zPosition*(parseFloat(getByid("3DDiv0").canvas().style.height)/parseFloat(GetViewport().imageHeight))+"px 0 0 -"+parseInt(s.style.width)/2+"px";for(n=0;n<o3d_3degree;n++)(l=getByid("3DDiv3_"+n).canvas()).style.width=parseFloat(l.originWidth)*zoomRatio3D+"px",l.style.height=parseFloat(l.originHeight)*zoomRatio3D+"px",l.style.margin="-"+parseInt(l.style.height)/2+"px 0 0 "+-1*getByid("3DDiv3_"+n).zPosition*(parseFloat(getByid("3DDiv0").canvas().style.height)/parseFloat(GetViewport().imageHeight))+"px"}else if(o<GetViewport().originalPointY-3){for(zoomRatio3D*=1.05,n=0;n<o3DListLength;n++)a=getByid("3DDiv"+n).canvas(),parseInt(a.style.width)||(a.style.width=t.style.width,a.style.height=t.style.height),a.style.width=parseFloat(a.width)*zoomRatio3D+"px",a.style.height=parseFloat(a.height)*zoomRatio3D+"px",a.style.margin="-"+parseInt(a.style.height)/2+"px 0 0 -"+parseInt(a.style.width)/2+"px";for(n=0;n<o3d_3degree;n++)(s=getByid("3DDiv2_"+n).canvas()).style.width=parseFloat(s.originWidth)*zoomRatio3D+"px",s.style.height=parseFloat(s.originHeight)*zoomRatio3D+"px",s.style.margin=-1*getByid("3DDiv2_"+n).zPosition*(parseFloat(getByid("3DDiv0").canvas().style.height)/parseFloat(GetViewport().imageHeight))+"px 0 0 -"+parseInt(s.style.width)/2+"px";for(n=0;n<o3d_3degree;n++)(l=getByid("3DDiv3_"+n).canvas()).style.width=parseFloat(l.originWidth)*zoomRatio3D+"px",l.style.height=parseFloat(l.originHeight)*zoomRatio3D+"px",l.style.margin="-"+parseInt(l.style.height)/2+"px 0 0 "+-1*getByid("3DDiv3_"+n).zPosition*(parseFloat(getByid("3DDiv0").canvas().style.height)/parseFloat(GetViewport().imageHeight))+"px"}a=getByid("3DDiv0").canvas(),rotate3dVR(d=get3dDistance())}if(MouseDownCheck||rightMouseDown){for(n=0;n<o3DListLength;n++){a=getByid("3DDiv"+n).canvas();var r=getByid("3DDiv"+n);1==getByid("o3DMip").selected&&openVR?r.style.mixBlendMode="lighten":1==getByid("o3DMinIP").selected&&openVR&&(r.style.mixBlendMode="darken"),1==getByid("3dZipCheckbox").checked&&parseInt(getByid("3dZipText").value)<o3DListLength&&n%parseInt(o3DListLength/parseFloat(getByid("3dZipText").value))!=0&&(a.style.display="none")}for(n=0;n<o3d_3degree;n++){var s=getByid("3DDiv2_"+n).canvas(),g=getByid("3DDiv2_"+n);s.style.transform="translate3d(0,0,0)  rotateX(-90deg)",1==getByid("o3DMip").selected&&openVR?g.style.mixBlendMode="lighten":1==getByid("o3DMinIP").selected&&openVR&&(g.style.mixBlendMode="darken")}for(n=0;n<o3d_3degree;n++){var l=getByid("3DDiv3_"+n).canvas(),h=getByid("3DDiv3_"+n);l.style.transform="translate3d(0,0,0)  rotateY(90deg)",1==getByid("o3DMip").selected&&openVR?h.style.mixBlendMode="lighten":1==getByid("o3DMinIP").selected&&openVR&&(h.style.mixBlendMode="darken")}GetViewport().originalPointX=i,GetViewport().originalPointY=o}}}},mousedown3D=function(e){1!=getByid("3dStrengthenAuto").selected||getByid("o3DMinIP").selected||getByid("OutSide3dDiv")&&(getByid("OutSide3dDiv").style.transformStyle=""),1!=openCave&&MouseDown3D(e)};function MouseDown3D(e){switch(e.which){case 1:MouseDownCheck=!0;break;case 2:default:break;case 3:rightMouseDown=!0}windowMouseX=GetmouseX(e),windowMouseY=GetmouseY(e),GetViewport().originalPointX=get3dCurrPoint(e)[0],GetViewport().originalPointY=get3dCurrPoint(e)[1]}var mouseup3D=function(e){1!=openCave&&(MouseDownCheck=!1,rightMouseDown=!1,(1==getByid("3dStrengthenAuto").selected||getByid("o3DMinIP").selected)&&getByid("OutSide3dDiv")&&!openMPR&&(getByid("OutSide3dDiv").style.transformStyle="preserve-3d"))},touchstart3D=function(e){1!=getByid("3dStrengthenAuto").selected||getByid("o3DMinIP").selected||getByid("OutSide3dDiv")&&(getByid("OutSide3dDiv").style.transformStyle=""),e.touches[1]?Touchstart3D(e.touches[0],e.touches[1]):Touchstart3D(e.touches[0])},touchmove3D=function(e){e.touches[1]?Touchmove3D(e.touches[0],e.touches[1]):Touchmove3D(e.touches[0])},Touchstart3D=function(e,t){t?rightTouchDown=!0:TouchDownCheck=!0,windowMouseX=GetmouseX(e),windowMouseY=GetmouseY(e),GetViewport().originalPointX=get3dCurrPoint(e)[0],GetViewport().originalPointY=get3dCurrPoint(e)[1]},touchend3D=function(e,t){TouchDownCheck=!1,rightTouchDown=!1,(1==getByid("3dStrengthenAuto").selected||getByid("o3DMinIP").selected)&&getByid("OutSide3dDiv")&&!openMPR&&(getByid("OutSide3dDiv").style.transformStyle="preserve-3d")},Touchmove3D=function(e,t){if(1!=openCave&&(1==openVR||1==openMPR)){var i=GetViewport().canvas();Timeout3d=!0,setTimeout((function(){Timeout3d=!1}),50);for(var o=0;o<o3DListLength;o++){var n=getByid("3DDiv"+o).canvas();!parseInt(n.style.width)>=1&&(n.style.width=i.style.width,n.style.height=i.style.height),n.style.margin="-"+parseInt(n.style.height)/2+"px 0 0 -"+parseInt(n.style.width)/2+"px"}for(o=0;o<o3d_3degree;o++)(g=getByid("3DDiv2_"+o).canvas()).style.margin=-1*getByid("3DDiv2_"+o).zPosition*(parseFloat(getByid("3DDiv0").canvas().style.height)/parseFloat(GetViewport().imageHeight))+"px 0 0 -"+parseInt(g.style.width)/2+"px";for(o=0;o<o3d_3degree;o++)(h=getByid("3DDiv3_"+o).canvas()).style.margin="-"+parseInt(h.style.height)/2+"px 0 0 "+-1*getByid("3DDiv3_"+o).zPosition*(parseFloat(getByid("3DDiv0").canvas().style.height)/parseFloat(GetViewport().imageHeight))+"px";var a=get3dDistance(),d=getCurrPoint(e)[0],r=getCurrPoint(e)[1];if(1==TouchDownCheck&&!rightTouchDown){for(o=0;o<o3DListLength;o++)n=getByid("3DDiv"+o).canvas(),!parseInt(n.style.width)>=1&&(n.style.width=i.style.width,n.style.height=i.style.height),n.style="position: absolute;top: 50%;left:50%; margin: -"+parseInt(n.style.height)/2+"px 0 0 -"+parseInt(n.style.width)/2+"px;width:"+n.style.width+";height:"+n.style.height+";";for(o=0;o<o3d_3degree;o++)(g=getByid("3DDiv2_"+o).canvas()).style="position: absolute;top: 50%;left:50%;margin:"+-1*getByid("3DDiv2_"+o).zPosition*(parseFloat(getByid("3DDiv0").canvas().style.height)/parseFloat(GetViewport().imageHeight))+"px 0 0 -"+parseInt(g.style.width)/2+"px;width:"+g.style.width+";height:"+g.style.height+";";for(o=0;o<o3d_3degree;o++)(h=getByid("3DDiv3_"+o).canvas()).style="position: absolute;top: 50%;left:50%;margin:-"+parseInt(h.style.height)/2+"px 0 0 "+-1*getByid("3DDiv3_"+o).zPosition*(parseFloat(getByid("3DDiv0").canvas().style.height)/parseFloat(GetViewport().imageHeight))+"px;height:"+h.style.height+";width:"+h.style.width+";"}if(d=get3dCurrPoint(e)[0],r=get3dCurrPoint(e)[1],a=get3dDistance(),1!=TouchDownCheck||rightTouchDown||(d<GetViewport().originalPointX-rotateStep?((degerrX+=GetViewport().originalPointX-d>rotateSpeed?-1*rotateSpeed:-1*(GetViewport().originalPointX-d))<0&&(degerrX+=360),degerrX>360&&(degerrX-=360),90!=degerrX&&270!=degerrX||(degerrX+=1)):d>GetViewport().originalPointX+rotateStep&&((degerrX-=d-GetViewport().originalPointX>rotateSpeed?-1*rotateSpeed:-1*(d-GetViewport().originalPointX))<0&&(degerrX+=360),degerrX>360&&(degerrX-=360),90!=degerrX&&270!=degerrX||(degerrX-=1)),r>GetViewport().originalPointY+rotateStep?degerrX>=90&&degerrX<=270?((degerrY-=GetViewport().originalPointY-r<rotateSpeed?-1*rotateSpeed:-1*(GetViewport().originalPointY-r))<0&&(degerrY+=360),degerrY>360&&(degerrY-=360),90!=degerrY&&270!=degerrY||(degerrY-=1)):((degerrY+=r-GetViewport().originalPointY<rotateSpeed?-1*rotateSpeed:-1*(r-GetViewport().originalPointY))<0&&(degerrY+=360),degerrY>360&&(degerrY-=360),90!=degerrY&&270!=degerrY||(degerrY+=1)):r<GetViewport().originalPointY-rotateStep&&(degerrX>=90&&degerrX<=270?((degerrY+=GetViewport().originalPointY-r>rotateSpeed?-1*rotateSpeed:-1*(GetViewport().originalPointY-r))<0&&(degerrY+=360),degerrY>360&&(degerrY-=360),90!=degerrY&&270!=degerrY||(degerrY+=1)):((degerrY+=r-GetViewport().originalPointY>rotateSpeed?-1*rotateSpeed:-1*(r-GetViewport().originalPointY))<0&&(degerrY+=360),degerrY>360&&(degerrY-=360),90!=degerrY&&270!=degerrY||(degerrY+=1))),rotate3dVR(a)),1==rightTouchDown){if(r>GetViewport().originalPointY+3){for(zoomRatio3D/=1.05,o=0;o<o3DListLength;o++)n=getByid("3DDiv"+o).canvas(),!parseInt(n.style.width)>=1&&(n.style.width=i.style.width,n.style.height=i.style.height),n.style.width=parseFloat(n.width)*zoomRatio3D+"px",n.style.height=parseFloat(n.height)*zoomRatio3D+"px",n.style.margin="-"+parseInt(n.style.height)/2+"px 0 0 -"+parseInt(n.style.width)/2+"px";for(o=0;o<o3d_3degree;o++)(g=getByid("3DDiv2_"+o).canvas()).style.width=parseFloat(g.originWidth)*zoomRatio3D+"px",g.style.height=parseFloat(g.originHeight)*zoomRatio3D+"px",g.style.margin=-1*getByid("3DDiv2_"+o).zPosition*(parseFloat(getByid("3DDiv0").canvas().style.height)/parseFloat(GetViewport().imageHeight))+"px 0 0 -"+parseInt(g.style.width)/2+"px";for(o=0;o<o3d_3degree;o++)(h=getByid("3DDiv3_"+o).canvas()).style.width=parseFloat(h.originWidth)*zoomRatio3D+"px",h.style.height=parseFloat(h.originHeight)*zoomRatio3D+"px",h.style.margin="-"+parseInt(h.style.height)/2+"px 0 0 "+-1*getByid("3DDiv3_"+o).zPosition*(parseFloat(getByid("3DDiv0").canvas().style.height)/parseFloat(GetViewport().imageHeight))+"px"}else if(r<GetViewport().originalPointY-3){for(zoomRatio3D*=1.05,o=0;o<o3DListLength;o++)n=getByid("3DDiv"+o).canvas(),parseInt(n.style.width)||(n.style.width=i.style.width,n.style.height=i.style.height),n.style.width=parseFloat(n.width)*zoomRatio3D+"px",n.style.height=parseFloat(n.height)*zoomRatio3D+"px",n.style.margin="-"+parseInt(n.style.height)/2+"px 0 0 -"+parseInt(n.style.width)/2+"px";for(o=0;o<o3d_3degree;o++)(g=getByid("3DDiv2_"+o).canvas()).style.width=parseFloat(g.originWidth)*zoomRatio3D+"px",g.style.height=parseFloat(g.originHeight)*zoomRatio3D+"px",g.style.margin=-1*getByid("3DDiv2_"+o).zPosition*(parseFloat(getByid("3DDiv0").canvas().style.height)/parseFloat(GetViewport().imageHeight))+"px 0 0 -"+parseInt(g.style.width)/2+"px";for(o=0;o<o3d_3degree;o++)(h=getByid("3DDiv3_"+o).canvas()).style.width=parseFloat(h.originWidth)*zoomRatio3D+"px",h.style.height=parseFloat(h.originHeight)*zoomRatio3D+"px",h.style.margin="-"+parseInt(h.style.height)/2+"px 0 0 "+-1*getByid("3DDiv3_"+o).zPosition*(parseFloat(getByid("3DDiv0").canvas().style.height)/parseFloat(GetViewport().imageHeight))+"px"}n=getByid("3DDiv0").canvas(),rotate3dVR(a=get3dDistance())}if(TouchDownCheck||rightTouchDown){for(o=0;o<o3DListLength;o++){n=getByid("3DDiv"+o).canvas();var s=getByid("3DDiv"+o);1==getByid("o3DMip").selected&&openVR?s.style.mixBlendMode="lighten":1==getByid("o3DMinIP").selected&&openVR&&(s.style.mixBlendMode="darken"),1==getByid("3dZipCheckbox").checked&&parseInt(getByid("3dZipText").value)<o3DListLength&&o%parseInt(o3DListLength/parseFloat(getByid("3dZipText").value))!=0&&(n.style.display="none")}for(o=0;o<o3d_3degree;o++){var g=getByid("3DDiv2_"+o).canvas(),l=getByid("3DDiv2_"+o);g.style.transform="rotateX(-90deg)",1==getByid("o3DMip").selected&&openVR?l.style.mixBlendMode="lighten":1==getByid("o3DMinIP").selected&&openVR&&(l.style.mixBlendMode="darken")}for(o=0;o<o3d_3degree;o++){var h=getByid("3DDiv3_"+o).canvas(),p=getByid("3DDiv3_"+o);h.style.transform="rotateY(90deg)",1==getByid("o3DMip").selected&&openVR?p.style.mixBlendMode="lighten":1==getByid("o3DMinIP").selected&&openVR&&(p.style.mixBlendMode="darken")}GetViewport().originalPointX=d,GetViewport().originalPointY=r}}};function rotate3dVR(e){if(!(degerrY>=90&&degerrY<=270)&&degerrX>=90&&degerrX<=270||degerrY>=90&&degerrY<=270&&!(degerrX>=90&&degerrX<=270))for(var t=0;t<o3DListLength;t++){var i=getByid("3DDiv"+t).getElementsByClassName("VrCanvas")[0];(o=getByid("3DDiv"+t)).style.zIndex=-t+o3DListLength+o3d_3degree,o.style.transform="translate3d(0,0,0) rotateY("+degerrX+"deg) rotateX("+degerrY+"deg)  translateZ("+(parseFloat(parseFloat(1)*(parseFloat(i.style.height)/parseFloat(GetViewport().imageHeight)))*(o.thickness-Thickness)-e/2)+"px)"}else for(t=0;t<o3DListLength;t++){var o;i=getByid("3DDiv"+t).getElementsByClassName("VrCanvas")[0],(o=getByid("3DDiv"+t)).style.zIndex=t+o3d_3degree,o.style.transform="translate3d(0,0,0) rotateY("+degerrX+"deg) rotateX("+degerrY+"deg)  translateZ("+(parseFloat(parseFloat(1)*(parseFloat(i.style.height)/parseFloat(GetViewport().imageHeight)))*(o.thickness-Thickness)-e/2)+"px)"}if(!(degerrY>=0&&degerrY<=180)&&degerrX>=90&&degerrX<=270||degerrY>=0&&degerrY<=180&&!(degerrX>=90&&degerrX<=270))for(t=0;t<o3d_3degree;t++){var n=getByid("3DDiv2_"+t);Math.abs(90-degerrY)<25||Math.abs(270-degerrY)<25?n.style.zIndex=t+o3DListLength+o3d_3degree:n.style.zIndex=t,n.style.transform="translate3d(0,0,0) rotateY("+(degerrX+0)+"deg) rotateX("+(degerrY+0)+"deg)  translateZ(0px)"}else for(t=0;t<o3d_3degree;t++)n=getByid("3DDiv2_"+t),Math.abs(90-degerrY)<25||Math.abs(270-degerrY)<25?n.style.zIndex=-t+o3DListLength+o3d_3degree+o3d_3degree:n.style.zIndex=-t+o3d_3degree,n.style.transform="translate3d(0,0,0) rotateY("+(degerrX+0)+"deg) rotateX("+(degerrY+0)+"deg)  translateZ(0px)";if(!(degerrY>=90&&degerrY<=270)&&degerrX>=0&&degerrX<=180||degerrY>=90&&degerrY<=270&&!(degerrX>=0&&degerrX<=180))for(t=0;t<o3d_3degree;t++){var a=getByid("3DDiv3_"+t);Math.abs(90-degerrY)<25||Math.abs(270-degerrY)<25?Math.abs(90-degerrX)<25||Math.abs(270-degerrX)<25?a.style.zIndex=degerrX>=0&&degerrX<=180?-t+o3DListLength+o3d_3degree+o3d_3degree:t+o3DListLength+o3d_3degree:a.style.zIndex=degerrX>=0&&degerrX<=180?-t+o3d_3degree:t:Math.abs(90-degerrX)<25||Math.abs(270-degerrX)<25?a.style.zIndex=degerrX>=0&&degerrX<=180?-t+o3d_3degree+o3DListLength+o3d_3degree:t+o3DListLength+o3d_3degree:a.style.zIndex=degerrX>=0&&degerrX<=180?-t+o3d_3degree:t,a.style.transform="translate3d(0,0,0) rotateY("+(degerrX+0)+"deg) rotateX("+(degerrY+0)+"deg)  translateZ(0px)"}else for(t=0;t<o3d_3degree;t++)a=getByid("3DDiv3_"+t),Math.abs(90-degerrY)<25||Math.abs(270-degerrY),Math.abs(90-degerrX)<25||Math.abs(270-degerrX)<25?a.style.zIndex=degerrX>=0&&degerrX<=180?-t+o3d_3degree+o3DListLength+o3d_3degree:t+o3DListLength+o3d_3degree:a.style.zIndex=degerrX>=0&&degerrX<=180?-t+o3d_3degree:t,a.style.transform="translate3d(0,0,0) rotateY("+(degerrX+0)+"deg) rotateX("+(degerrY+0)+"deg)  translateZ(0px)"}function setVrLight(){var e=0;if(1==getByid("3dShadow_0").selected?e=0:1==getByid("3dShadow_05").selected?e=.005:1==getByid("3dShadow_1").selected?e=.01:1==getByid("3dShadow_2").selected?e=.02:1==getByid("3dShadow_3").selected?e=.03:1==getByid("3dShadow_4").selected?e=.04:1==getByid("3dShadow_5").selected?e=.05:1==getByid("3dShadow_6").selected?e=.06:1==getByid("3dShadow_7").selected?e=.07:1==getByid("3dShadow_8").selected?e=.08:1==getByid("3dShadow_12").selected&&(e=.12),0==e){for(var t=0;t<o3DListLength;t++)getByid("3DDiv"+t).canvas().style.backgroundColor="";for(t=0;t<o3d_3degree;t++)getByid("3DDiv2_"+t).canvas().style.backgroundColor="";for(t=0;t<o3d_3degree;t++)getByid("3DDiv3_"+t).canvas().style.backgroundColor=""}else{for(t=0;t<o3DListLength;t++)getByid("3DDiv"+t).canvas().style.backgroundColor="rgba(0,0,0,"+e+")";for(t=0;t<o3d_3degree;t++)getByid("3DDiv2_"+t).canvas().style.backgroundColor="rgba(0,0,0,"+e+")";for(t=0;t<o3d_3degree;t++)getByid("3DDiv3_"+t).canvas().style.backgroundColor="rgba(0,0,0,"+e+")"}}function VRscreenshot(){var e=GetViewport().style.backgroundColor;GetViewport().style.backgroundColor="black",html2canvas(GetViewport()).then((function(e){var t=document.createElement("a");t.href=e.toDataURL("image/png").replace("image/png","image/octet-stream"),t.download="image.png",t.click(),delete e})),GetViewport().style.backgroundColor=e}function get3dCurrPoint(e){return[parseFloat(e.pageX),parseFloat(e.pageY)]}function display3DMark(e,t){var i=GetViewport();if(i.openMark){var o=e.getContext("2d");o.clearRect(0,0,i.imageWidth,i.imageHeight),o.strokeStyle=o.fillStyle="#FF0000",o.lineJoin=o.lineCap="round",o.lineWidth=""+getMarkSize(e,!1),setMarkColor(o);try{var[n,a,d]=SearchUid2Index(t)}catch(e){return}for(var r=0;r<PatientMark.length;r++)if(PatientMark[r].sop==Patient.Study[n].Series[a].Sop[d].SopUID)for(var s=0;s<PatientMark[r].mark.length;s++)0!=checkMark(n,a,r)&&((g=PatientMark[r].mark[s]).parent=PatientMark[r],"SEG"==g.type?drawSEG(e,g,i):"Overlay"==g.type&&drawOverLay(e,g,i));for(r=0;r<PatientMark.length;r++)if(PatientMark[r].sop==Patient.Study[n].Series[a].Sop[d].SopUID)for(s=0;s<PatientMark[r].mark.length;s++)0!=checkMark(n,a,r)&&((g=PatientMark[r].mark[s]).parent=PatientMark[r],"XML_mark"==g.type?drawXML_mark(e,g,PatientMark[r].showName):"TEXT"==g.type?drawTEXT(e,g,i):"POLYLINE"==g.type?drawPOLYLINE(e,g,i):"ELLIPSE"==g.type?drawELLIPSE(e,g,i):"CIRCLE"==g.type?drawCIRCLE(e,g,i):"TwoDimensionPolyline"==g.type?drawTwoDimensionPolyline(e,g,i):"TwoDimensionMultiPoint"==g.type?drawTwoDimensionMultiPoint(e,g,i):"TwoDimensionEllipse"==g.type&&drawTwoDimensionEllipse(e,g,i));for(r=0;r<PatientMark.length;r++)if(PatientMark[r].sop==Patient.Study[n].Series[a].Sop[d].SopUID)for(s=0;s<PatientMark[r].mark.length;s++){var g;0!=checkMark(n,a,r)&&((g=PatientMark[r].mark[s]).parent=PatientMark[r],"RTSS"==g.type?drawRTSS(e,g,i):"TextAnnotationEntity"==g.type&&drawTextAnnotationEntity(e,g,i))}}}