function measure(){"measure"==BL_mode&&(DeleteMouseEvent(),cancelTools(),openMeasure=!0,set_BL_model.onchange1=function(){getByid("MeasureLabel").style.display="none",displayMark(),openMeasure=!1,document.documentElement.onmousemove=DivDraw,document.documentElement.ontouchmove=DivDraw,set_BL_model.onchange1=function(){return 0}},Mousedown=function(e){1==e.which?MouseDownCheck=!0:3==e.which&&(rightMouseDown=!0),windowMouseX=GetmouseX(e),windowMouseY=GetmouseY(e),GetViewport().originalPointX=getCurrPoint(e)[0],GetViewport().originalPointY=getCurrPoint(e)[1];let o=rotateCalculation(e);MeasureXY=o,MeasureXY2=o;for(var t=0;t<Viewport_Total;t++)displayMark(t)},Mousemove=function(e){var o=getCurrPoint(e)[0],t=getCurrPoint(e)[1],r=getClass("labelXY");{let o=rotateCalculation(e);MeasureXY2=o,r[viewportNumber].innerText="X: "+parseInt(o[0])+" Y: "+parseInt(o[1])}if(1==rightMouseDown&&scale_size(e,o,t),1==openLink)for(var a=0;a<Viewport_Total;a++)GetViewport(a).newMousePointX=GetViewport().newMousePointX,GetViewport(a).newMousePointY=GetViewport().newMousePointY;for(putLabel(),a=0;a<Viewport_Total;a++)displayRuler(a);if(MouseDownCheck){let r=SearchNowUid();var i={};i.study=r.studyuid,i.series=r.sreiesuid,i.color="#FF0000",i.mark=[],i.showName="ruler",i.hideName=i.showName,i.mark.push({}),i.sop=r.sopuid;var n=i.mark.length-1;return i.mark[n].type="MeasureRuler",i.mark[n].markX=[],i.mark[n].markY=[],i.mark[n].markX.push(GetViewport().originalPointX),i.mark[n].markY.push(GetViewport().originalPointY),i.mark[n].markY.push(t),i.mark[n].markX.push(o),i.mark[n].Text=getMeasurelValue(e),PatientMark.push(i),refreshMark(i),void PatientMark.splice(PatientMark.indexOf(i),1)}GetViewport().originalPointX=o,GetViewport().originalPointY=t},Mouseup=function(e){var o=getCurrPoint(e)[0],t=getCurrPoint(e)[1];let r=SearchNowUid();var a={};a.study=r.studyuid,a.series=r.sreiesuid,a.color="#FF0000",a.mark=[],a.showName="ruler",a.hideName=a.showName,a.mark.push({}),a.sop=r.sopuid;var i=a.mark.length-1;a.mark[i].type="MeasureRuler",a.mark[i].markX=[],a.mark[i].markY=[],a.mark[i].markX.push(GetViewport().originalPointX),a.mark[i].markY.push(GetViewport().originalPointY),a.mark[i].markY.push(t),a.mark[i].markX.push(o),a.mark[i].Text=getMeasurelValue(e),PatientMark.push(a),refreshMark(a);for(var n=0;n<Viewport_Total;n++)displayMark(n);if(displayAngleRuler(),Graphic_now_choose={reference:a},1==openMouseTool&&1==rightMouseDown&&displayMark(),MouseDownCheck=!1,rightMouseDown=!1,magnifierDiv.style.display="none",openLink)for(n=0;n<Viewport_Total;n++)displayRuler(n)},Touchstart=function(e,o){o?rightTouchDown=!0:TouchDownCheck=!0,windowMouseX=GetmouseX(e),windowMouseY=GetmouseY(e),1==rightTouchDown&&o&&(windowMouseX2=GetmouseX(o),windowMouseY2=GetmouseY(o)),GetViewport().originalPointX=getCurrPoint(e)[0],GetViewport().originalPointY=getCurrPoint(e)[1],1==rightTouchDown&&o&&(GetViewport().originalPointX2=getCurrPoint(o)[0],GetViewport().originalPointY2=getCurrPoint(o)[1]);{getByid("MeasureLabel").style.display="";let o=rotateCalculation(e);MeasureXY=o,MeasureXY2=o;for(var t=0;t<Viewport_Total;t++)displayMark(t)}{let o=rotateCalculation(e);var r=o[0],a=o[1];for(MeasureXY=[r,a],MeasureXY2=[r,a],t=0;t<Viewport_Total;t++)displayMark(t)}},Touchmove=function(e,o){if(!openDisplayMarkup||!getByid("DICOMTagsSelect").selected&&!getByid("AIMSelect").selected){var t=getCurrPoint(e)[0],r=getCurrPoint(e)[1];if(o&&(getCurrPoint(o)[0],getCurrPoint(o)[1]),getClass("labelXY")[viewportNumber].innerText="X: "+Math.floor(t)+" Y: "+Math.floor(r),1!=TouchDownCheck||0!=rightTouchDown);else{let o=rotateCalculation(e);var a=o[0],i=o[1];MeasureXY2=[a,i];for(var n=0;n<Viewport_Total;n++)displayMark(n)}}},Touchend=function(e,o){1==TouchDownCheck&&(1==openAngle?openAngle=2:2==openAngle&&(openAngle=3)),TouchDownCheck=!1,rightTouchDown=!1,magnifierDiv.style.display="none"},AddMouseEvent())}function getMeasurelValue(e,o){var t=parseInt(Math.sqrt(Math.pow(MeasureXY2[0]/GetViewport().PixelSpacingX-MeasureXY[0]/GetViewport().PixelSpacingX,2)+Math.pow(MeasureXY2[1]/GetViewport().PixelSpacingY-MeasureXY[1]/GetViewport().PixelSpacingY,2),2))+"mm";if(!o)return t;if(document.body.scrollTop&&0!=document.body.scrollTop)var r=document.body.scrollTop,a=document.body.scrollLeft;else r=document.getElementsByTagName("html")[0].scrollTop,a=document.getElementsByTagName("html")[0].scrollLeft;var i=o.style,n=e.clientY,l=e.clientX;return n&&l||(n=e.touches[0].clientY,l=e.touches[0].clientX),1!=MouseDownCheck&&1!=TouchDownCheck||(i.top=n+r+"px",i.left=l+a+"px"),parseInt(t)<=1?"":t}function drawMeasureRuler(e){var o=e.canvas,t=e.mark;if("MeasureRuler"==t.type){var r=o.getContext("2d");r.globalAlpha=parseFloat(getByid("markAlphaText").value)/100,setMarkColor(r),t.parent.color&&(r.strokeStyle=r.fillStyle=""+t.parent.color);for(var a=0;a<t.markX.length;a+=1){r.beginPath();var i=1*t.markX[a],n=1*t.markY[a],l=1*t.markX[a+1],u=1*t.markY[a+1];t.RotationAngle&&t.RotationPoint&&([i,n]=rotatePoint([i,n],t.RotationAngle,t.RotationPoint),[l,u]=rotatePoint([l,u],t.RotationAngle,t.RotationPoint));var s=r.globalAlpha;r.globalAlpha=1,r.moveTo(i,n),r.lineTo(l,u),r.stroke(),r.globalAlpha=s,r.closePath()}s=r.globalAlpha,r.globalAlpha=1,r.strokeStyle="#00FF00",r.fillStyle="#00FF00",r.beginPath(),r.arc(t.markX[0],t.markY[0],3,0,2*Math.PI),r.arc(t.markX[t.markX.length-1],t.markY[t.markY.length-1],3,0,2*Math.PI),r.fill(),r.closePath(),t.Text&&(r.beginPath(),r.font="22px Arial",r.fillStyle="#FF0000",r.fillText(""+t.Text,t.markX[t.markX.length-1],t.markY[t.markY.length-1]),r.closePath()),r.globalAlpha=s}}PLUGIN.PushMarkList(drawMeasureRuler);