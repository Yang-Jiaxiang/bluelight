var AngleXY0=[],AngleXY1=[],AngleXY2=[];function angle(){"angle"==BL_mode&&(DeleteMouseEvent(),document.documentElement.onmousemove=displayAngleLabel,document.documentElement.ontouchmove=displayAngleLabel,openAngle=0,angle.angle_=1,set_BL_model.onchange1=function(){getByid("AngleLabel").style.display="none",displayMark(),angle.angle_=!1,set_BL_model.onchange1=function(){return 0}},Mousedown=function(e){if(1==e.which?MouseDownCheck=!0:3==e.which&&(rightMouseDown=!0),windowMouseX=GetmouseX(e),windowMouseY=GetmouseY(e),GetViewport().originalPointX=getCurrPoint(e)[0],GetViewport().originalPointY=getCurrPoint(e)[1],3==angle.angle_&&(angle.angle_=1),1==angle.angle_){let l=rotateCalculation(e);AngleXY0=l,AngleXY1=l;for(var a=0;a<Viewport_Total;a++)displayMark(a);displayAngleRuler()}},Mousemove=function(e){var a=getCurrPoint(e)[0],l=getCurrPoint(e)[1],t=getClass("labelXY");{let a=rotateCalculation(e);t[viewportNumber].innerText="X: "+parseInt(a[0])+" Y: "+parseInt(a[1])}if(1==rightMouseDown&&scale_size(e,a,l),2==angle.angle_){let a=rotateCalculation(e);AngleXY2=a;let l=SearchNowUid();(o={}).study=l.studyuid,o.series=l.sreiesuid,o.color="#FF0000",o.mark=[],o.showName="ruler",o.hideName=o.showName,o.mark.push({}),o.sop=l.sopuid;var n=o.mark.length-1;o.mark[n].type="AngleRuler",o.mark[n].markX=[],o.mark[n].markY=[],o.mark[n].markX.push(GetViewport().originalPointX),o.mark[n].markY.push(GetViewport().originalPointY),o.mark[n].markY.push(AngleXY1[1]),o.mark[n].markX.push(AngleXY1[0]),o.mark[n].markY.push(AngleXY0[1]),o.mark[n].markX.push(AngleXY0[0]),o.mark[n].markY.push(AngleXY2[1]),o.mark[n].markX.push(AngleXY2[0]),o.mark[n].Text=getAnglelValue(e),PatientMark.push(o),refreshMark(o);for(var r=0;r<Viewport_Total;r++)displayMark(r);PatientMark.splice(PatientMark.indexOf(o),1)}if(1==openLink)for(r=0;r<Viewport_Total;r++)GetViewport(r).newMousePointX=GetViewport().newMousePointX,GetViewport(r).newMousePointY=GetViewport().newMousePointY;for(putLabel(),r=0;r<Viewport_Total;r++)displayRuler(r);if(MouseDownCheck&&(windowMouseX=GetmouseX(e),windowMouseY=GetmouseY(e),1==angle.angle_)){let a=rotateCalculation(e);AngleXY1=a;let l=SearchNowUid();var o;for((o={}).study=l.studyuid,o.series=l.sreiesuid,o.color="#FF0000",o.mark=[],o.showName="ruler",o.hideName=o.showName,o.mark.push({}),o.sop=l.sopuid,n=o.mark.length-1,o.mark[n].type="AngleRuler",o.mark[n].markX=[],o.mark[n].markY=[],o.mark[n].markX.push(GetViewport().originalPointX),o.mark[n].markY.push(GetViewport().originalPointY),o.mark[n].markY.push(AngleXY1[1]),o.mark[n].markX.push(AngleXY1[0]),o.mark[n].markY.push(AngleXY0[1]),o.mark[n].markX.push(AngleXY0[0]),o.mark[n].Text="",PatientMark.push(o),refreshMark(o),r=0;r<Viewport_Total;r++)displayMark(r);PatientMark.splice(PatientMark.indexOf(o),1)}GetViewport().originalPointX=a,GetViewport().originalPointY=l},Mouseup=function(e){if(1==openMouseTool&&1==rightMouseDown&&displayMark(),2==angle.angle_){let n=rotateCalculation(e);AngleXY2=n;let r=SearchNowUid();var a={};a.study=r.studyuid,a.series=r.sreiesuid,a.color="#FF0000",a.mark=[],a.showName="ruler",a.hideName=a.showName,a.mark.push({}),a.sop=r.sopuid;var l=a.mark.length-1;a.mark[l].type="AngleRuler",a.mark[l].markX=[],a.mark[l].markY=[],a.mark[l].markX.push(GetViewport().originalPointX),a.mark[l].markY.push(GetViewport().originalPointY),a.mark[l].markY.push(AngleXY1[1]),a.mark[l].markX.push(AngleXY1[0]),a.mark[l].markY.push(AngleXY0[1]),a.mark[l].markX.push(AngleXY0[0]),a.mark[l].markY.push(AngleXY2[1]),a.mark[l].markX.push(AngleXY2[0]),a.mark[l].Text=getAnglelValue(e),PatientMark.push(a),refreshMark(a);for(var t=0;t<Viewport_Total;t++)displayMark(t)}1==MouseDownCheck&&(1==angle.angle_?angle.angle_=2:2==angle.angle_&&(angle.angle_=3)),MouseDownCheck=!1,rightMouseDown=!1},Touchstart=function(e,a){if(a?rightTouchDown=!0:TouchDownCheck=!0,windowMouseX=GetmouseX(e),windowMouseY=GetmouseY(e),1==rightTouchDown&&a&&(windowMouseX2=GetmouseX(a),windowMouseY2=GetmouseY(a)),GetViewport().originalPointX=getCurrPoint(e)[0],GetViewport().originalPointY=getCurrPoint(e)[1],1==rightTouchDown&&a&&(GetViewport().originalPointX2=getCurrPoint(a)[0],GetViewport().originalPointY2=getCurrPoint(a)[1]),3==angle.angle_&&(angle.angle_=1),2==angle.angle_&&(getByid("AngleLabel").style.display=""),1==angle.angle_){let a=rotateCalculation(e);var l=a[0],t=a[1];AngleXY0=[l,t],AngleXY1=[l,t];for(var n=0;n<Viewport_Total;n++)displayMark(n);displayAngleRuler()}},Touchmove=function(e,a){if(!openDisplayMarkup||!getByid("DICOMTagsSelect").selected&&!getByid("AIMSelect").selected){var l=getCurrPoint(e)[0],t=getCurrPoint(e)[1];if(a&&(getCurrPoint(a)[0],getCurrPoint(a)[1]),getClass("labelXY")[viewportNumber].innerText="X: "+Math.floor(l)+" Y: "+Math.floor(t),2!=angle.angle_)if(1!=angle.angle_);else{let a=rotateCalculation(e);for(n=a[0],r=a[1],AngleXY0=[n,r],o=0;o<Viewport_Total;o++)displayMark(o);displayAngleRuler()}else{let a=rotateCalculation(e);var n=a[0],r=a[1];AngleXY2=[n,r];for(var o=0;o<Viewport_Total;o++)displayMark(o);displayAngleRuler()}}},Touchend=function(e,a){1==TouchDownCheck&&(1==angle.angle_?angle.angle_=2:2==angle.angle_&&(angle.angle_=3)),TouchDownCheck=!1,rightTouchDown=!1,magnifierDiv.style.display="none"},AddMouseEvent())}function drawAngleRuler(e){var a=e.canvas,l=e.mark;if("AngleRuler"==l.type){var t=a.getContext("2d");t.globalAlpha=parseFloat(getByid("markAlphaText").value)/100,setMarkColor(t);var n=t.globalAlpha;t.globalAlpha=1,t.beginPath(),t.strokeStyle="#00FF00",t.fillStyle="#00FF00",t.moveTo(l.markX[0],l.markY[0]),t.lineTo(l.markX[1],l.markY[1]),t.stroke(),l.markX.length>2&&(t.moveTo(l.markX[1],l.markY[1]),t.lineTo(l.markX[2],l.markY[2])),t.stroke(),t.closePath(),t.beginPath(),t.strokeStyle="#FF0000",t.fillStyle="#FF0000",t.arc(l.markX[0],l.markY[0],3,0,2*Math.PI),t.fill(),t.closePath(),t.beginPath(),t.arc(l.markX[1],l.markY[1],3,0,2*Math.PI),t.fill(),t.closePath(),t.beginPath(),l.markX.length>2&&(t.strokeStyle="#FF0000",t.fillStyle="#FF0000",t.arc(l.markX[1],l.markY[1],3,0,2*Math.PI),t.fill(),t.arc(l.markX[2],l.markY[2],3,0,2*Math.PI),t.fill()),t.closePath(),l.Text&&(t.beginPath(),t.font="22px Arial",t.fillStyle="#FF0000",t.fillText(""+l.Text,l.markX[l.markX.length-1],l.markY[l.markY.length-1]),t.closePath()),t.globalAlpha=n}}function displayAngleRuler(){}function getAnglelValue(e,a){if(angle.angle_){var l,t=({x:e,y:a},{x:l,y:t})=>{const n=e*l+a*t,r=e*t-a*l;return(Math.atan2(r,n)/Math.PI*180+360)%360};return(l=t({x:AngleXY1[0]-AngleXY2[0],y:AngleXY1[1]-AngleXY2[1]},{x:AngleXY1[0]-AngleXY0[0],y:AngleXY1[1]-AngleXY0[1]}))>180&&(l=360-l),a?(x_out=-parseInt(magnifierCanvas.style.width)/2,y_out=-parseInt(magnifierCanvas.style.height)/2,angle.angle_>=2?(a.style.display="",AngleXY2[0]>AngleXY0[0]?x_out=20:x_out=-20,AngleXY2[1]>AngleXY0[1]?y_out=20:y_out=-20):a.style.display="none",document.body.scrollTop&&0!=document.body.scrollTop?(dbst=document.body.scrollTop,dbsl=document.body.scrollLeft):(dbst=document.getElementsByTagName("html")[0].scrollTop,dbsl=document.getElementsByTagName("html")[0].scrollLeft),dgs=a.style,y=e.clientY,x=e.clientX,y&&x||(y=e.touches[0].clientY,x=e.touches[0].clientX),dgs.top=y+dbst+y_out+"px",dgs.left=x+dbsl+x_out+"px",(l=t({x:AngleXY0[0]-AngleXY2[0],y:AngleXY0[1]-AngleXY2[1]},{x:AngleXY0[0]-AngleXY1[0],y:AngleXY0[1]-AngleXY1[1]}))>180&&(l=360-l),parseInt(l)+"°"):parseInt(l)+"°"}}function displayAngleLabel(e){}PLUGIN.PushMarkList(drawAngleRuler);