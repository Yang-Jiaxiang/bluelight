function loadLdcmview(){getByid("LeftPicture").style="display: flex;flex-direction: column;position: absolute;z-index: 9",parseInt(getByid("LeftPicture").offsetHeight)+10>=window.innerHeight-document.getElementsByClassName("container")[0].offsetTop-2*bordersize&&(getByid("LeftPicture").style="overflow-y: scroll;display: flex;flex-direction: column;position: absolute;z-index: 9;height:"+(window.innerHeight-document.getElementsByClassName("container")[0].offsetTop-2*bordersize)+"px;"),getByid("WindowLevelDiv").style.display="none",getByid("labelZoom").style.display="none",getByid("labelPlay").style.display="none",getByid("textPlay").style.display="none",getByid("textZoom").style.display="none",getByid("SplitViewportDiv").style.display="none",getByid("MarkStyleDiv").style.display="none",getByid("GraphicStyleDiv").style.display="none",getByid("magnifierDiv").style.width=magnifierWidth+"px",getByid("magnifierDiv").style.height=magnifierHeight+"px",getByid("magnifierCanvas").style.width=magnifierWidth+"px",getByid("magnifierCanvas").style.height=magnifierHeight+"px",getByid("magnifierDiv").width=magnifierWidth,getByid("magnifierDiv").height=magnifierHeight,getByid("magnifierCanvas").width=magnifierWidth,getByid("magnifierCanvas").height=magnifierHeight,Patient.patientName="",Patient.StudyAmount=0,Patient.Study=[];for(var e=0;e<Viewport_Total;e++){var t=document.createElement("DIV"),n=document.createElement("CANVAS");t.id="MyDicomDiv"+e,t.viewportNum=e,t.className="MyDicomDiv",t.setAttribute("data-role","drag-drop-container"),magnifierDiv=document.getElementById("magnifierDiv"),document.getElementsByClassName("container")[0].appendChild(t),t.imageOrientationX=0,t.imageOrientationY=0,t.imageOrientationZ=0,t.imageOrientationX2=0,t.imageOrientationY2=0,t.imageOrientationZ2=0,t.windowCenterList=0,t.windowWidthList=0,t.PixelSpacingX=1,t.PixelSpacingY=1,t.imagePositionX=0,t.imagePositionY=0,t.imagePositionZ=0,t.windowCenter=0,t.windowWidth=0,t.imageWidth=0,t.imageHeight=0,t.originalPointX=0,t.originalPointY=0,t.originalPointX2=0,t.originalPointY2=0,t.newMousePointX=0,t.newMousePointY=0,t.rotateValue=0,t.StudyDate=0,t.StudyTime=0,t.PatientID="12345",t.PatientName="name",t.openInvert=!1,t.AccessionNumber="",t.StudyDescription="",t.StudyID="",t.SliceLocation=1,t.ModalitiesInStudy="",t.Manufacturer="",t.InstitutionName="",t.InstitutionAddress="",t.ReferringPhysicianName="",t.StationName="",t.SeriesDescription="",t.SeriesNumber="",t.RequestingPhysician="",t.ImagePositionPatient="",t.SpacingBetweenSlices="",t.SliceThickness="",t.ImageType="",t.PatientBirthDate="",t.PatientSex="",t.PatientAge="",t.FrameOfReferenceUID="",t.PhotometricInterpretation="",t.Rows="",t.Columns="",t.BitsAllocated="",t.BitsStored="",t.HighBit="",t.PixelRepresentation="",t.LossyImageCompression="",t.PixelSpacing="",t.NowCanvasSizeWidth=null,t.NowCanvasSizeHeight=null,t.openHorizontalFlip=!1,t.openVerticalFlip=!1,t.openMark=!0,t.openPlay=!1,t.DicomTagsList=[],t.canvas=function(){return this.getElementsByClassName("DicomCanvas")[0]?this.getElementsByClassName("DicomCanvas")[0]:null},t.ctx=function(){return this.getElementsByClassName("DicomCanvas")[0]?this.getElementsByClassName("DicomCanvas")[0].getContext("2d"):null},n.id="MarkCanvas"+e,t.appendChild(n)}for(var i=0;getClass("leftRule").length<Viewport_Total;){var o=document.createElement("CANVAS");o.className="leftRule",o.style="z-index:30;position:absolute;left:110px;",o.height=500,o.width=10,GetViewport(getClass("leftRule").length).appendChild(o)}for(i=0;getClass("downRule").length<Viewport_Total;){var a=document.createElement("CANVAS");a.className="downRule",a.style="z-index:30;position:absolute;bottom:15px;left:100px;",a.height=10,GetViewport(getClass("downRule").length).appendChild(a)}for(i=0;getClass("labelWC").length<Viewport_Total;){i++;var s=document.createElement("LABEL");s.className="labelWC innerLabel",s.style="position:absolute;left:115px;bottom:30px;color: white;z-index: 10;-webkit-user-select: none; ",GetViewport(i-1).appendChild(s)}for(i=0;getClass("labelLT").length<Viewport_Total;){i++;var l=document.createElement("LABEL");l.className="labelLT innerLabel",l.style="position:absolute;left:115px;top:10px;color: white;z-index: 10;-webkit-user-select: none; ",GetViewport(i-1).appendChild(l)}for(i=0;getClass("labelRT").length<Viewport_Total;){i++;var g=document.createElement("LABEL");g.className="labelRT innerLabel",g.style="position:absolute;right:20px;top:10px;color: white;z-index: 10;-webkit-user-select: none;text-align:right;",GetViewport(i-1).appendChild(g)}for(i=0;getClass("labelRB").length<Viewport_Total;){i++;var p=document.createElement("LABEL");p.className="labelRB innerLabel",p.style="position:absolute;right:20px;bottom:20px;color: white;z-index: 10;-webkit-user-select: none;text-align:right;",GetViewport(i-1).appendChild(p)}for(i=0;getClass("labelXY").length<Viewport_Total;){i++;var r=document.createElement("LABEL");r.className="labelXY innerLabel",r.style="position:absolute;left:115px;bottom:10px;color: white;z-index: 10;-webkit-user-select: none; ",r.innerText="X: 0 Y: 0",GetViewport(i-1).appendChild(r)}for(i=0;getClass("DicomCanvas").length<Viewport_Total;){i++;var d=document.createElement("CANVAS");d.className="DicomCanvas",GetViewport(i-1).appendChild(d)}labelWC=getClass("labelWC"),labelLT=getClass("labelLT"),labelRT=getClass("labelRT"),labelRB=getClass("labelRB"),getByid("textWC").style.display=getByid("textWW").style.display="none",readDicomTags("../data/dicomTags.json",setLabelPadding),readConfigJson("../data/config.json",readAllJson,readJson),drawBorder(getByid("MouseOperation")),magnifierDiv.style.display="none",displayAnnotation()}function getParameterByName(e){e=e.replace(/\[\[]/g,"\\[").replace(/\[\]]/g,"\\]");for(var t=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(location.search),n=(""+(t=null==t?"":decodeURIComponent(t[1].replace(/\+/g," ")))).split(","),i=[],o=0;o<n.length;o++)i.push(n[o]);return i}function setLabelPadding(){labelPadding=isNaN(parseInt(DicomTags.labelPadding))?5:parseInt(DicomTags.labelPadding),leftLabelPadding=isNaN(parseInt(DicomTags.leftLabelPadding))?labelPadding:parseInt(DicomTags.leftLabelPadding),rightLabelPadding=isNaN(parseInt(DicomTags.rightLabelPadding))?labelPadding:parseInt(DicomTags.rightLabelPadding),topLabelPadding=isNaN(parseInt(DicomTags.topLabelPadding))?labelPadding:parseInt(DicomTags.topLabelPadding),bottomLabelPadding=isNaN(parseInt(DicomTags.bottomLabelPadding))?labelPadding:parseInt(DicomTags.bottomLabelPadding)}function readDicomTags(e,t){var n=new XMLHttpRequest;n.open("GET",e),n.responseType="json",n.send();var i={};n.onload=function(){var e=n.response.default;i.labelPadding=parseInt(e.labelPadding)?parseInt(e.labelPadding):5,i.leftLabelPadding=parseInt(e.leftLabelPadding)?parseInt(e.leftLabelPadding):i.labelPadding,i.rightLabelPadding=parseInt(e.rightLabelPadding)?parseInt(e.rightLabelPadding):i.labelPadding,i.topLabelPadding=parseInt(e.topLabelPadding)?parseInt(e.topLabelPadding):i.labelPadding,i.bottomLabelPadding=parseInt(e.bottomLabelPadding)?parseInt(e.bottomLabelPadding):i.labelPadding,i.LT={},i.LT.name=[],i.LT.tag=[];for(var o=0;o<e.LT.length;o++)i.LT.name.push(e.LT[o].name),i.LT.tag.push(e.LT[o].tag);for(i.RT={},i.RT.name=[],i.RT.tag=[],o=0;o<e.RT.length;o++)i.RT.name.push(e.RT[o].name),i.RT.tag.push(e.RT[o].tag);for(i.LB={},i.LB.name=[],i.LB.tag=[],o=0;o<e.LB.length;o++)i.LB.name.push(e.LB[o].name),i.LB.tag.push(e.LB[o].tag);for(i.RB={},i.RB.name=[],i.RB.tag=[],o=0;o<e.RB.length;o++)i.RB.name.push(e.RB[o].name),i.RB.tag.push(e.RB[o].tag);Object.assign(DicomTags,i),t&&t()}}function operateQueryString(e){var t=[],n="";for(var i in TAG_DICT)t.push(TAG_DICT[i].name);for(var o=0;o<e.split("&").length;o++)t.includes(e.split("&")[o].split("=")[0])&&(0!=o&&(n+="&"),n+=e.split("&")[o]);return n}function readAllJson(e){var t=(""+location.search).replace("?","");if((t=operateQueryString(t)).length>0){var n=ConfigLog.QIDO.https+"://"+ConfigLog.QIDO.hostname+":"+ConfigLog.QIDO.PORT+"/"+ConfigLog.QIDO.service+"/series?"+t;e(n=fitUrl(n))}}function fitUrl(e){return(e=(e=(e=(e=e.replace("?&","?")).replace("http://http://","http://")).replace("https://http://","https://")).replace("http://https://","http://")).replace("https://https://","https://")}function readConfigJson(e,t,n){var i={},o=new XMLHttpRequest;o.open("GET",e),o.responseType="json",o.send(),o.onload=function(){var e=o.response;i.QIDO={},tempResponse=e.DICOMWebServersConfig[0],tempConfig=i.QIDO,tempConfig.hostname=tempResponse["QIDO-hostname"],tempConfig.https=1==tempResponse["QIDO-enableHTTPS"]?"https":"http",tempConfig.PORT=tempResponse["QIDO-PORT"],tempConfig.service=tempResponse.QIDO,tempConfig.contentType=tempResponse.contentType,tempConfig.timeout=tempResponse.timeout,tempConfig.charset=tempResponse.charset,tempConfig.includefield=tempResponse.includefield,tempConfig.token=tempResponse.token,tempConfig.enableRetrieveURI=tempResponse.enableRetrieveURI,i.WADO={},tempConfig=i.WADO,tempResponse=e.DICOMWebServersConfig[0],tempConfig.hostname=tempResponse["WADO-hostname"],tempConfig.https=1==tempResponse["WADO-enableHTTPS"]?"https":"http",tempConfig.PORT=tempResponse["WADO-PORT"],tempConfig.WADOType=tempResponse["WADO-RS/URI"],"URI"==tempConfig.WADOType?tempConfig.service=tempResponse["WADO-URI"]:"RS"==tempConfig.WADOType?tempConfig.service=tempResponse["WADO-RS"]:tempConfig.service=tempResponse["WADO-URI"],tempConfig.contentType=tempResponse.contentType,tempConfig.timeout=tempResponse.timeout,tempConfig.includefield=tempResponse.includefield,tempConfig.token=tempResponse.token,tempConfig.enableRetrieveURI=tempResponse.enableRetrieveURI,i.STOW={},tempConfig=i.STOW,tempResponse=e.DICOMWebServersConfig[0],tempConfig.hostname=tempResponse.hostname,tempConfig.https=1==tempResponse.enableHTTPS?"https":"http",tempConfig.PORT=tempResponse.PORT,tempConfig.service=tempResponse.STOW,tempConfig.contentType=tempResponse.contentType,tempConfig.timeout=tempResponse.timeout,tempConfig.includefield=tempResponse.includefield,tempConfig.token=tempResponse.token,tempConfig.enableRetrieveURI=tempResponse.enableRetrieveURI,i.Xml2Dcm={},tempConfig=i.Xml2Dcm,tempConfig.enableXml2Dcm=tempResponse.enableXml2Dcm,tempConfig.Xml2DcmUrl=tempResponse.Xml2DcmUrl,tempConfig.token=tempResponse.token,Object.assign(ConfigLog,i),configOnload=!0,t(n)}}function getValue(e){if(e&&e.Value&&e.Value[0])return e.Value[0]}function getJsonByInstanceRequest(e,t,n){let i=t.response;for(var o=1e9,a=0;a<i.length;a++)try{getValue(i[a]["00200013"])<o&&(o=getValue(i[a]["00200013"]))}catch(e){console.log(e)}for(a=0;a<i.length;a++){if("URI"==ConfigLog.WADO.WADOType)var s=ConfigLog.WADO.https+"://"+ConfigLog.WADO.hostname+":"+ConfigLog.WADO.PORT+"/"+ConfigLog.WADO.service+"?requestType=WADO&studyUID="+i[a]["0020000D"].Value[0]+"&seriesUID="+i[a]["0020000E"].Value[0]+"&objectUID="+i[a]["00080018"].Value[0]+"&contentType=application/dicom";else"RS"==ConfigLog.WADO.WADOType&&(s=ConfigLog.WADO.https+"://"+ConfigLog.WADO.hostname+":"+ConfigLog.WADO.PORT+"/"+ConfigLog.WADO.service+"/studies/"+i[a]["0020000D"].Value[0]+"/series/"+i[a]["0020000E"].Value[0]+"/instances/"+i[a]["00080018"].Value[0]);if(s=fitUrl(s),i[a]["00080016"])try{readDicom(s,PatientMark)}catch(e){console.log(e)}try{"URI"==ConfigLog.WADO.WADOType&&(s="wadouri:"+s),getValue(i[a]["00200013"])==o&&(getValue(i[a]["0020000D"]),getValue(i[a]["0020000E"]),getValue(i[a]["00080018"]),getValue(i[a]["00200013"]),getValue(i[a]["00100020"]),"URI"==ConfigLog.WADO.WADOType?loadAndViewImage(s):"RS"==ConfigLog.WADO.WADOType&&wadorsLoader(s))}catch(e){console.log(e)}}function l(t){if("URI"==ConfigLog.WADO.WADOType)var o=ConfigLog.WADO.https+"://"+ConfigLog.WADO.hostname+":"+ConfigLog.WADO.PORT+"/"+ConfigLog.WADO.service+"?requestType=WADO&studyUID="+i[t]["0020000D"].Value[0]+"&seriesUID="+i[t]["0020000E"].Value[0]+"&objectUID="+i[t]["00080018"].Value[0]+"&contentType=application/dicom";else"RS"==ConfigLog.WADO.WADOType&&(o=ConfigLog.WADO.https+"://"+ConfigLog.WADO.hostname+":"+ConfigLog.WADO.PORT+"/"+ConfigLog.WADO.service+"/studies/"+i[t]["0020000D"].Value[0]+"/series/"+i[t]["0020000E"].Value[0]+"/instances/"+i[t]["00080018"].Value[0]);o=fitUrl(o);try{"URI"==ConfigLog.WADO.WADOType&&(o="wadouri:"+o),getValue(i[t]["0020000D"]),getValue(i[t]["0020000E"]),getValue(i[t]["00080018"]),getValue(i[t]["00200013"]),getValue(i[t]["00100020"]),"RS"==ConfigLog.WADO.WADOType?wadorsLoader(o,!0):onlyLoadImage(o);try{"PR"!=getValue(i[t]["00080060"])&&"PR"!=getValue(e[n]["00080060"])||(100,new Promise((e=>setTimeout(e,100)))).then((()=>{readDicom(o.replace("wadouri:",""),PatientMark,!0)}))}catch(e){console.log(e)}}catch(e){console.log(e)}}function g(e){return new Promise((t=>setTimeout(t,e)))}for(a=0;a<i.length;a++){const e=a;g(2e3*parseInt(e/50)).then((()=>{l(e)}))}}function getJsonBySeriesRequest(e){let t=e.response,n="";for(let e=0;e<t.length;e++){n=1==ConfigLog.QIDO.enableRetrieveURI?t[e]["00081190"].Value[0]+"/instances":fitUrl(ConfigLog.QIDO.https+"://"+ConfigLog.QIDO.hostname+":"+ConfigLog.QIDO.PORT+"/"+ConfigLog.QIDO.service)+"/studies/"+t[e]["0020000D"].Value[0]+"/series/"+t[e]["0020000E"].Value[0]+"/instances",1==ConfigLog.WADO.includefield&&(n+="?includefield=all"),"https"==ConfigLog.WADO.https&&(n=n.replace("http:","https:"));let a=new XMLHttpRequest;a.open("GET",n),a.responseType="json";for(var i=ConfigLog.WADO.token,o=0;o<Object.keys(i).length;o++)""!=i[Object.keys(i)[o]]&&a.setRequestHeader(""+Object.keys(i)[o],""+i[Object.keys(i)[o]]);const s=e;a.send(),a.onload=function(){getJsonByInstanceRequest(t,a,s)}}}function readJson(e){"https"==ConfigLog.WADO.https&&(e=e.replace("http:","https:"));let t=new XMLHttpRequest;t.open("GET",e),t.responseType="json";for(var n=ConfigLog.WADO.token,i=0;i<Object.keys(n).length;i++)""!=n[Object.keys(n)[i]]&&t.setRequestHeader(""+Object.keys(n)[i],""+n[Object.keys(n)[i]]);t.send(),t.onload=function(){getJsonBySeriesRequest(t)}}window.onload=function(){EnterRWD(),loadLdcmview(),html_onload(),EnterRWD()};