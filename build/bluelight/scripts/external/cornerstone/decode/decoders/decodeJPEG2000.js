import OpenJPEG from"../../codecs/openJPEG-FixedMemory.js";import JpxImage from"../../codecs/jpx.min.js";function decodeJpx(e,n){const o=new JpxImage;o.parse(n);const r=o.tiles.length;if(1!==r)throw new Error(`JPEG2000 decoder returned a tileCount of ${r}, when 1 is expected`);return e.columns=o.width,e.rows=o.height,e.pixelData=o.tiles[0].items,e}let openJPEG;function decodeOpenJPEG(e,n,o){const r=openJPEG._malloc(e.length);openJPEG.writeArrayToMemory(e,r);const t=openJPEG._malloc(4),i=openJPEG._malloc(4),p=openJPEG._malloc(4),a=openJPEG._malloc(4),l=openJPEG._malloc(4),J=(new Date).getTime();if(0!==openJPEG.ccall("jp2_decode","number",["number","number","number","number","number","number","number"],[r,e.length,t,i,p,a,l]))return console.log("[opj_decode] decoding failed!"),openJPEG._free(r),openJPEG._free(openJPEG.getValue(t,"*")),openJPEG._free(p),openJPEG._free(a),openJPEG._free(i),void openJPEG._free(l);const E=openJPEG.getValue(t,"*"),P={length:openJPEG.getValue(i,"i32"),sx:openJPEG.getValue(p,"i32"),sy:openJPEG.getValue(a,"i32"),nbChannels:openJPEG.getValue(l,"i32"),perf_timetodecode:void 0,pixelData:void 0},d=P.sx*P.sy*P.nbChannels,G=new Int32Array(openJPEG.HEAP32.buffer,E,d);if(1===n)if(Uint8Array.from)P.pixelData=Uint8Array.from(G);else{P.pixelData=new Uint8Array(d);for(let e=0;e<d;e++)P.pixelData[e]=G[e]}else if(o)if(Int16Array.from)P.pixelData=Int16Array.from(G);else{P.pixelData=new Int16Array(d);for(let e=0;e<d;e++)P.pixelData[e]=G[e]}else if(Uint16Array.from)P.pixelData=Uint16Array.from(G);else{P.pixelData=new Uint16Array(d);for(let e=0;e<d;e++)P.pixelData[e]=G[e]}const c=(new Date).getTime();return P.perf_timetodecode=c-J,openJPEG._free(r),openJPEG._free(t),openJPEG._free(E),openJPEG._free(i),openJPEG._free(p),openJPEG._free(a),openJPEG._free(l),P}function decodeOpenJpeg2000(e,n){const o=decodeOpenJPEG(n,e.bitsAllocated<=8?1:2,1===e.pixelRepresentation);return e.columns=o.sx,e.rows=o.sy,e.pixelData=o.pixelData,o.nbChannels>1&&(e.photometricInterpretation="RGB"),e}function initializeJPEG2000(e){if(!e.usePDFJS&&void 0===OpenJPEG)throw new Error("OpenJPEG decoder not loaded");if(!openJPEG&&(openJPEG=OpenJPEG(),!openJPEG||!openJPEG._jp2_decode))throw new Error("OpenJPEG failed to initialize")}function decodeJPEG2000(e,n,o,r={}){return initializeJPEG2000(o),r.usePDFJS||o.usePDFJS?decodeJpx(e,n):decodeOpenJpeg2000(e,n)}export default decodeJPEG2000;export{initializeJPEG2000};